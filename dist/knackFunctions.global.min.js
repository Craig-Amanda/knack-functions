const CLASS_HIDDEN="ktlHidden",CLASS_DISPLAY_NONE="ktlDisplayNone",INPUT_CHECKBOX_SELECTOR='input[type="checkbox"]',INPUT_RADIO_SELECTOR='input[type="radio"]',INPUT_CHECKBOX_CHECKED_SELECTOR=`${INPUT_CHECKBOX_SELECTOR}:checked`,INPUT_RADIO_CHECKED_SELECTOR=`${INPUT_RADIO_SELECTOR}:checked`,HEADER_CHECKBOX_SELECTOR='th input[type="checkbox"]',CLASS_DISABLED="disabled";console.log("KnackApps/ARC Beta 1.0 - knackFunctions.js loaded."),$.expr[":"].textEquals=function(e,t,n){let o=n[3];return $(e).text().replace("*","").trim()===o};const evaluate=e=>t=>n=>{switch(t){case"+":return e+n;case"-":return e-n;case"/":return e/n;case"*":return e*n;case">":return e>n;case">=":return e>=n;case"<":return e<n;case"<=":return e<=n;case"==":return e==n;case"===":return e===n;case"!=":return e!=n;case"!==":return e!==n;case"%":return e%n;default:return"Invalid operation"}};function getNumericValue(e,t=!1){let n;if("string"==typeof e){if(n=document.querySelector(e),!n)return NaN}else{if(!e||"object"!=typeof e||!("value"in e))return NaN;n=e}const o=String(n.value??"").trim(),r=t?o.replace(/[^\d.+-]/g,""):o,i=Number(r);return Number.isFinite(i)?i:NaN}function setVisibility(e,t){"string"==typeof e&&(e=document.querySelectorAll(e)),e instanceof Element&&(e=[e]),(NodeList.prototype.isPrototypeOf(e)||Array.isArray(e))&&e.forEach(e=>{e&&(e.style.display=t?"":"none")})}function showIf(e,t){setVisibility(e,!!("function"==typeof t?t():t))}function toggleVisibility(e,t){"string"==typeof e&&(e=document.querySelectorAll(e)),e instanceof Element&&(e=[e]),(NodeList.prototype.isPrototypeOf(e)||Array.isArray(e))&&e.forEach(e=>{if(!e)return;let n;n=void 0===t?"none"===e.style.display:"function"==typeof t?t():!!t,e.style.display=n?"":"none"})}function QuillEditor({value:e,onChange:t,modules:n,theme:o="snow",readOnly:r=!1}){const i=React.useRef(null),s=React.useRef(null);return React.useEffect(()=>{if(!i.current||!window.Quill||s.current)return;s.current=new window.Quill(i.current,{theme:o,modules:n,readOnly:r});const e=[i.current.previousSibling,i.current.parentNode?.querySelector(".ql-toolbar"),document.querySelector(".ql-toolbar")].find(e=>e?.classList?.contains("ql-toolbar"));if(e){const t=/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"Cmd":"Ctrl";[{selector:"button.ql-bold",tip:`Bold (${t}+B)`},{selector:"button.ql-italic",tip:`Italic (${t}+I)`},{selector:"button.ql-underline",tip:`Underline (${t}+U)`},{selector:"button.ql-link",tip:`Insert Link (${t}+K)`},{selector:"button.ql-image",tip:"Insert Image"},{selector:"button.ql-code-block",tip:"Code Block"},{selector:"button.ql-blockquote",tip:"Blockquote"},{selector:"button.ql-clean",tip:"Remove Formatting"},{selector:'button.ql-list[value="ordered"]',tip:`Numbered List (${t}+Shift+7)`},{selector:'button.ql-list[value="bullet"]',tip:`Bullet List (${t}+Shift+8)`},{selector:".ql-color",tip:"Text Color"},{selector:".ql-background",tip:"Background Color"},{selector:'button.ql-script[value="sub"]',tip:`Subscript (${t}+,)`},{selector:'button.ql-script[value="super"]',tip:`Superscript (${t}+.)`},{selector:".ql-align",tip:"Align"}].forEach(({selector:t,tip:n})=>{e.querySelectorAll(t).forEach(e=>{e.title=n})});const n=e.querySelector(".ql-align.ql-picker");if(n){n.querySelectorAll(".ql-picker-item").forEach(e=>{switch(e.getAttribute("data-value")){case null:e.title="Align Left";break;case"center":e.title="Align Center";break;case"right":e.title="Align Right";break;case"justify":e.title="Justify"}})}}return s.current.on("text-change",()=>{const e=i.current.querySelector(".ql-editor").innerHTML;t&&t(e)}),()=>{s.current&&(s.current.off("text-change"),s.current=null)}},[n,o,r]),React.useEffect(()=>{s.current&&e!==s.current.root.innerHTML&&!s.current.hasFocus()&&s.current.clipboard.dangerouslyPasteHTML(e||"")},[e]),React.useEffect(()=>{s.current&&s.current.enable(!r)},[r]),React.createElement("div",{ref:i})}function initializeQuillIcons(){if(!window.Quill?.imports?.["ui/icons"])return;const e=window.Quill.imports["ui/icons"];e.list.ordered='\n        <svg viewBox="0 0 18 18">\n            <text x="2" y="5.5" font-size="6" font-family="Arial" fill="#444">1</text>\n            <rect class="ql-stroke" height="0.1" width="8" x="10" y="3.8" rx="0.3"></rect>\n            <text x="2" y="11.5" font-size="6" font-family="Arial" fill="#444">2</text>\n            <rect class="ql-stroke" height="0.1" width="8" x="10" y="9.6" rx="0.3"></rect>\n            <text x="2" y="17" font-size="6" font-family="Arial" fill="#444">3</text>\n            <rect class="ql-stroke" height="0.1" width="8" x="10" y="15" rx="0.3"></rect>\n        </svg>\n    ',e.list.bullet='\n        <svg viewBox="0 0 18 18">\n            <circle class="ql-fill" cx="5" cy="4" r="1.5"></circle>\n            <rect class="ql-stroke" height="0.1" width="8" x="10" y="3.8" rx="0.3"></rect>\n            <circle class="ql-fill" cx="5" cy="10" r="1.5"></circle>\n            <rect class="ql-stroke" height="0.1" width="8" x="10" y="9.6" rx="0.3"></rect>\n            <circle class="ql-fill" cx="5" cy="15" r="1.5"></circle>\n            <rect class="ql-stroke" height="0.1" width="8" x="10" y="15" rx="0.3"></rect>\n        </svg>\n    '}const QuillModal={init(){if(document.getElementById("quill-universal-modal"))return;const e=document.createElement("div");e.id="quill-universal-modal",e.innerHTML='\n            <div class="ql-modal-content">\n                <h3 id="ql-modal-title"></h3>\n                <div id="ql-modal-fields"></div>\n                <div class="ql-modal-actions">\n                    <button id="ql-modal-save" type="button">Save</button>\n                    <button id="ql-modal-unlink" type="button" style="display:none;">Unlink</button>\n                    <button id="ql-modal-cancel" type="button">Cancel</button>\n                </div>\n            </div>\n        ',document.body.appendChild(e);const t=document.createElement("style");t.textContent="\n            #quill-universal-modal {\n                position: fixed; z-index: 99999; left: 0; top: 0; width: 100vw; height: 100vh; display: none;\n                background: rgba(0,0,0,0.3); align-items: center; justify-content: center;\n            }\n            .ql-modal-content {\n                background: #fff; border-radius: 8px; padding: 1.5em 2em; min-width: 320px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);\n                display: flex; flex-direction: column; gap: 1.25em;\n            }\n            .ql-modal-content h3 {\n                margin: 0; padding: 0; font-size: 1.3em;\n            }\n            .ql-modal-content label {\n                display: flex; flex-direction: column; gap: 0.5em; font-weight: 500;\n                margin-bottom: 0.5em;\n            }\n            .ql-modal-content input {\n                padding: 0.5em; border: 1px solid #ccc; border-radius: 4px;\n                margin-bottom: 0;\n            }\n            .ql-modal-content small {\n                color: #666; font-size: 0.65em; margin-top: -0.7em; margin-bottom: 0.85em;\n                display: block;\n            }\n            .ql-modal-fields {\n                margin-bottom: 0.5em;\n            }\n            .ql-modal-actions {\n                display: flex; gap: 1em; justify-content: flex-end;\n                margin-top: 0.5em; padding-top: 0.5em;\n            }\n            .ql-modal-actions button {\n                padding: 0.6em 1.2em; border: none; border-radius: 4px;\n                background: #0078d4; color: #fff; font-weight: 600; cursor: pointer;\n                min-width: 80px;\n            }\n            .ql-modal-actions button#ql-modal-unlink { background: #e81123; }\n            .ql-modal-actions button#ql-modal-cancel { background: #888; }\n            .ql-modal-actions button:disabled { opacity: 0.6; cursor: not-allowed; }\n            .ql-modal-actions button:hover { filter: brightness(1.1); }\n        ",document.head.appendChild(t)},show({type:e,url:t="",label:n="",onSave:o,onUnlink:r,onCancel:i}){this.init();const s=document.getElementById("quill-universal-modal"),a=document.getElementById("ql-modal-fields"),l=document.getElementById("ql-modal-title"),c=document.getElementById("ql-modal-save"),d=document.getElementById("ql-modal-unlink"),u=document.getElementById("ql-modal-cancel");"link"===e?(l.textContent="Insert/Edit Link",a.innerHTML=`\n                <label>\n                    Link URL:\n                    <input type="url" id="ql-link-url" placeholder="https://example.com" value="${t}" required>\n                    <small>\n                        If you omit https:// it will be added automatically.\n                    </small>\n                </label>\n                <label>\n                    Link Text:\n                    <input type="text" id="ql-link-label" placeholder="Link text" value="${n}" required>\n                </label>\n            `,d.style.display=""):"image"===e&&(l.textContent="Insert Image",a.innerHTML=`\n                <label>\n                    Image URL:\n                    <input type="url" id="ql-image-url" placeholder="https://example.com/image.jpg" value="${t}" required>\n                </label>\n            `,d.style.display="none"),s.style.display="flex",c.onclick=()=>{if("link"===e){let e=document.getElementById("ql-link-url").value.trim(),t=document.getElementById("ql-link-label").value.trim();e&&t&&(/^https?:\/\//i.test(e)||(e="https://"+e),o(e,t),s.style.display="none")}else if("image"===e){let e=document.getElementById("ql-image-url").value.trim();e&&(o(e),s.style.display="none")}},d.onclick=()=>{r&&r(),s.style.display="none"},u.onclick=()=>{i&&i(),s.style.display="none"}}};function createQuillModules(){return{toolbar:{container:[[{header:[1,2,3,4,!1]},{font:[]}],["bold","italic","underline",{color:[]},{background:[]}],[{align:[]},{list:"ordered"},{list:"bullet"}],["code-block","blockquote",{script:"sub"},{script:"super"}],["link","image"],["clean"]],handlers:{image:function(){const e=this.quill;let t=e.getSelection();QuillModal.show({type:"image",url:"",onSave:n=>{e.setSelection(t.index,t.length),e.insertEmbed(t.index,"image",n,"user")}})},link:function(){const e=this.quill;let t=e.getSelection();if(!t)return;let n="",o="";const[r]=e.getLeaf(t.index);if(r?.parent?.formats&&"function"==typeof r.parent.formats){const i=r.parent.formats();i.link?(n=i.link,o=r.parent.domNode.innerText||e.getText(t.index,t.length)):o=e.getText(t.index,t.length)}else o=e.getText(t.index,t.length);QuillModal.show({type:"link",url:n,label:o,onSave:(n,o)=>{e.setSelection(t.index,t.length),e.deleteText(t.index,t.length),e.insertText(t.index,o,"link",n)},onUnlink:()=>{e.setSelection(t.index,t.length),e.format("link",!1)}})}}},keyboard:{bindings:{orderedList:{key:55,shortKey:!0,shiftKey:!0,handler:function(){this.quill.format("list","ordered")}},bulletList:{key:56,shortKey:!0,shiftKey:!0,handler:function(){this.quill.format("list","bullet")}}}}}}function replaceKnackRichTextWithQuillEditor(e,t={}){if(!window.React||!window.ReactDOM||!window.Quill)return void console.warn("React or Quill not loaded, using Knack Redactor editor.");initializeQuillIcons();const n=createQuillModules(),o=e?document.getElementById(e):document;if(!o)return;const r=o.querySelectorAll?.(".kn-input-rich_text")||document.querySelectorAll(".kn-input-rich_text");return r.length?(r.forEach((r,i)=>{if("true"===r.dataset.quillMounted)return;const s=r.querySelector(".redactor-editor"),a=r.querySelector("textarea.rich_text");if(!s||!a)return;const l=r.querySelector("label.kn-label");let c=null;l&&(c=l.cloneNode(!0),l.remove());const d=`${e||"global"}-${i}`;let u=r.parentNode.querySelector(`.my-react-editor[data-for="${r.id}"]`);u||(u=document.createElement("div"),u.className="my-react-editor",u.id=`my-react-editor-${d}`,u.setAttribute("data-for",r.id),r.parentNode.insertBefore(u,r),c&&u.parentNode.insertBefore(c,u));try{s.classList.add("ktlHidden"),u._reactRootContainer||(u._reactRootContainer=ReactDOM.createRoot(u)),u._reactRootContainer.render(React.createElement(QuillEditor,{theme:t.theme||"snow",value:a.value,modules:t.modules||n,readOnly:t.readOnly||!1,onChange:e=>{const t=!e||""===e.replace(/<[^>]+>/g,"").trim();a.value=t?"":e,s&&(s.innerHTML=t?"":e),a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0})),a.blur()}})),r.dataset.quillMounted="true",document.querySelectorAll(".redactor-toolbar, .redactor-toolbar-tooltip, .redactor-air, .redactor-dropdown").forEach(e=>e.remove()),document.querySelectorAll('[id^="redactor-toolbar-"]').forEach(e=>e.remove())}catch(e){console.error("Failed to load QuillEditor, reverting to Knack Redactor editor:",e);const t=o.querySelectorAll?o:document;t.querySelectorAll(".redactor-editor").forEach(e=>e.classList.remove("ktlHidden")),t.querySelectorAll(".my-react-editor").forEach(e=>e.remove())}}),r.length):void 0}function truncateColumnsInGrid(e,t){const n=document.getElementById(e);n&&Object.entries(t).forEach(([e,t])=>{const o=parseInt(e,10);(Array.isArray(t)?t:[t]).forEach(e=>{const t=`td.field_${e}`,r=document.createElement("div");n.querySelectorAll(t).forEach(e=>{const t=e.innerHTML;let n=t.replace(/<\/(p|div|li|h[1-6]|tr|td|th)>/gi," ").replace(/<(p|div|li|h[1-6]|tr|td|th)[^>]*>/gi," ").replace(/<\/(p|div|li|h[1-6]|tr|td|th)>/gi," ").replace(/<(ul|ol|table|thead|tbody|tfoot|section|article)[^>]*>/gi," ");r.innerHTML=n;const i=r.textContent;if(i.length>o){const n=i.substring(0,o)+"...",r=document.createElement("span");r.textContent=n;const s=document.createElement("span");s.innerHTML=t,s.style.display="none";const a=document.createElement("a");a.href="#",a.className="text-expand",a.textContent="View More",a.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation();const t="none"===s.style.display;s.style.display=t?"":"none",r.style.display=t?"none":"",a.textContent=t?"View Less":"View More"}),e.innerHTML="",e.appendChild(r),e.appendChild(s),e.appendChild(document.createTextNode(" ")),e.appendChild(a)}})})})}function selectTextOnFocus(e,t=".kn-input-number input"){const n=document.getElementById(e);if(!n)return;n.querySelectorAll(t).forEach(e=>{e.addEventListener("focus",function(){setTimeout(()=>{this.select()},0)})})}function debounce(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...o)},t)}}function addInputEventListener(e,t,n={}){const{events:o="change",delegate:r=null,runOnInit:i=!1}=n,s=Array.isArray(o)?o:[o],a=[];function l(e){s.forEach(n=>{r?e.addEventListener(n,function(n){const o=e.querySelectorAll(r),i=n.target.closest(r);i&&Array.from(o).includes(i)&&t(n,i)}):e.addEventListener(n,function(n){t(n,e)})});try{if(window.jQuery&&window.jQuery.fn&&"function"==typeof window.jQuery.fn.datepicker){const n=window.jQuery(e);if(n.hasClass&&n.hasClass("hasDatepicker")){let o=null;try{o=n.datepicker("option","onSelect")}catch(e){o=null}n.datepicker("option","onSelect",function(n,r){if("function"==typeof o)try{o.call(this,n,r)}catch(e){}const i={type:"datepicker",dateText:n,target:e};try{t(i,e)}catch(e){}})}}}catch(e){}i&&t(null,e),a.push(e)}return"string"==typeof e?document.querySelectorAll(e).forEach(l):NodeList.prototype.isPrototypeOf(e)||Array.isArray(e)?e.forEach(l):e instanceof Element&&l(e),a}function enhanceDatepicker(e,t={}){const n=Object.assign({},{changeMonth:!0,changeYear:!0,yearsBack:80,showButtonPanel:!1,dateFormat:null,minDate:null,maxDate:null,waitForInit:!1,maxAttempts:10,attemptInterval:200,onApplied:null},t||{});if(!window.jQuery||!window.jQuery.fn||"function"!=typeof window.jQuery.fn.datepicker)return!!n.waitForInit&&Promise.resolve(!1);const o="string"==typeof e?Array.from(document.querySelectorAll(e)):NodeList.prototype.isPrototypeOf(e)||Array.isArray(e)?Array.from(e):e instanceof Element?[e]:[];if(!o.length)return!!n.waitForInit&&Promise.resolve(!1);if(!document.getElementById("knack-datepicker-styles")){const e=document.createElement("style");e.id="knack-datepicker-styles",e.textContent="\n        /* Improve month/year select styling in jQuery UI datepicker */\n        .ui-datepicker-title {\n            display: flex;\n        }\n        .ui-datepicker select.ui-datepicker-month, .ui-datepicker select.ui-datepicker-year {\n            padding: 2px 6px;\n            border-radius: 4px;\n            border: 1px solid #cfcfcf;\n            background: #fff;\n            color: #222;\n            font-size: 13px;\n            margin-right: 6px;\n            display: inline-block;\n        }\n        .ui-datepicker .ui-datepicker-header {\n            padding: 6px 8px;\n            background: #f5f6f7;\n            border-bottom: 1px solid rgba(0,0,0,0.06);\n        }\n        .ui-datepicker .ui-datepicker-calendar td a {\n            border-radius: 4px;\n            padding: 6px 8px;\n        }\n        .ui-datepicker .ui-datepicker-buttonpane {\n            text-align: right;\n            padding: 6px 8px;\n        }\n        ",document.head.appendChild(e)}const r=()=>{let e=!1;return o.forEach(t=>{try{const o=window.jQuery(t);if(!o||!o.hasClass)return;if(o.hasClass("hasDatepicker")){const r=(new Date).getFullYear(),i=r-Math.max(0,n.yearsBack),s={changeMonth:!!n.changeMonth,changeYear:!!n.changeYear,yearRange:`${i}:${r}`,showButtonPanel:!!n.showButtonPanel};if(n.dateFormat&&(s.dateFormat=n.dateFormat),null!==n.minDate&&(s.minDate=n.minDate),null!==n.maxDate&&(s.maxDate=n.maxDate),o.datepicker("option",s),"function"==typeof n.onApplied)try{n.onApplied(t)}catch(e){}e=!0}}catch(e){}}),e};return n.waitForInit?new Promise(e=>{let t=0;const o=()=>{t+=1;return r()?e(!0):t>=Math.max(1,n.maxAttempts)?e(!1):void setTimeout(o,Math.max(50,n.attemptInterval))};o()}):r()}async function waitSelector({selector:e,textCondition:t=null,returnType:n="element",timeout:o=1e4}){return new Promise((r,i)=>{let s=null,a=null;const l=()=>{let o=null,i=null,l=!1;t&&("string"==typeof t?(i=t,l=!1):"object"==typeof t&&null!==t&&(i=t.text,l=!!t.exact));const c=e=>{if(!i)return!0;const t=e.textContent.trim();return l?t===i:t.includes(i)};if("elements"===n){if(o=document.querySelectorAll(e),o.length>0){if(i&&(o=Array.from(o).filter(c),0===o.length))return;t&&"string"!=typeof t&&"object"!=typeof t&&!t(o)||(s&&s.disconnect(),clearTimeout(a),r(o))}}else{if(i){const t=document.querySelectorAll(e);for(const e of t)if(c(e)){o=e;break}}else o=document.querySelector(e);o&&(t&&"string"!=typeof t&&"object"!=typeof t&&!t(o)||(s&&s.disconnect(),clearTimeout(a),r("empty"===n||o)))}};l(),a=setTimeout(()=>{s&&s.disconnect();let n="";t&&("string"==typeof t?n=` with text: ${t}`:"object"==typeof t&&t.text&&(n=` with ${t.exact?"exact ":""}text: ${t.text}`)),i(new Error(`Timeout waiting for selector: ${e}${n} after ${o}ms`))},o),s=new MutationObserver((e,t)=>{l()}),s.observe(document.body,{childList:!0,subtree:!0,attributes:!0})})}document.addEventListener("mousedown",function(e){const t=document.activeElement&&document.activeElement.closest(".ql-editor"),n=e.target.closest(".ql-editor, .ql-toolbar, .ql-container"),o=e.target.closest(".ql-picker, .ql-picker-label, .ql-picker-options, .ql-picker-item");!t&&!n||o||e.stopImmediatePropagation()},!0);const updateOptions=(e,t,n,o)=>{const r=e.querySelector(".kn-add-option");if(!r)return;const i=e.querySelector(".default"),s=e.querySelector(".chzn-container")||e.querySelector(".select");if(r.textContent=t,r.style.width="fit-content",o){if(r.classList.add("disabled"),s){const t=()=>{r.classList.remove("disabled")};s.addEventListener("click",t);const n=s.querySelector(".chzn-search input");n&&(n.addEventListener("focus",t),n.addEventListener("input",t));const o=e.querySelector("select");o&&(o.addEventListener("change",t),o.addEventListener("focus",t))}}else{const t=e.querySelector(".control");t&&t.parentNode!==r.parentNode&&t.parentNode.insertBefore(r,t)}i&&(i.value=n),r.addEventListener("mousedown",function e(t){waitSelector({selector:"li.kn-form-col",timeout:3e3}).then(()=>registrationHandler(t)),r.removeEventListener("mousedown",e)},{once:!0})};function getValueFromDetailBody(e,t=!1){const n=document.querySelector(`.field_${e} .kn-detail-body`);return n?t?n.innerHTML.trim():n.textContent.trim():(console.log(`Error: Element with field_${e} not found.`),null)}function getIndexOfColumnHeader(e,t){if(!e)return errorHandler.handle(new Error("getIndexOfColumnHeader: viewElement is undefined"),{fieldIds:t}),Array.isArray(t)?t.map(()=>-1):-1;if(null==t)return errorHandler.handle(new Error("getIndexOfColumnHeader: fieldIds is undefined or null"),{viewElement:e}),-1;const n=e.querySelector("table thead tr");return n?Array.isArray(t)?t.map(e=>Array.from(n.children).findIndex(t=>t.classList.contains(`field_${e}`))):Array.from(n.children).findIndex(e=>e.classList.contains(`field_${t}`)):(errorHandler.handle(new Error("getIndexOfColumnHeader: headerRow not found"),{viewElement:e,fieldIds:t}),Array.isArray(t)?t.map(()=>-1):-1)}function getAllTableRows(e,t,n=!1,o=!1,r=null){if(!e)return;const i=document.querySelector(`#${e} table`);if(!i)return;let s=Array.from(i.querySelectorAll("tbody tr:not(.kn-table-group)"));if(n){s=[...Array.from(i.querySelectorAll("thead tr")),...s]}if(o){const e=Array.from(i.querySelectorAll("tbody tr.kn-table-group"));s=[...s,...e]}r&&(s=s.filter(e=>!e.matches(r))),s.forEach((e,n)=>{t(n,e)})}function updateButtonColourOnFormComplete(e,t,n){const o=getValueFromDetail(e);if(!o||!o.length)return;const r=o.split(",");for(const e of r){const o=t[e.trim()];o&&ktl.core.waitSelector(`#view_${o} .view-header:has(.ktlHideShowButton), #view_${o} a.knViewLink`).then(()=>{$(`#view_${o} .view-header:has(.ktlHideShowButton), #view_${o} a.knViewLink`).css("background-color",n)}).catch(e=>{console.error(`Error waiting for selector in view_${o}:`,e)})}}function removeElement(e){if(Array.isArray(e))return void e.forEach(e=>{removeElement(e)});(e instanceof jQuery?e:$(e)).remove()}function addClassToSelector(e,t){if(Array.isArray(e))return void e.forEach(e=>{addClassToSelector(e,t)});const n=e instanceof jQuery?e:$(e);return n.addClass(t),n}function removeClassFromSelector(e,t){if(Array.isArray(e))return void e.forEach(e=>{removeClassFromSelector(e,t)});const n=e instanceof jQuery?e:$(e);return n.removeClass(t),n}function escapeHTML(e){return e.replace(/[&<>"']/g,function(e){return`&#${e.charCodeAt(0)};`})}function getCheckedRowIds(e){return $(`#${e} tbody ${INPUT_CHECKBOX_CHECKED_SELECTOR}`).map(function(){return $(this).closest("tr").attr("id")}).get()}function getCheckedRows(e){return $(`#${e} tbody ${INPUT_CHECKBOX_CHECKED_SELECTOR}`).map(function(){return $(this).closest("tr")}).get()}function showInputNotification(e,t,n,o=null){const r=`notif_${Date.now()}`,i=e.closest(".kn-input");$("<div>",{id:r,class:"input-notification",text:t,css:{backgroundColor:n}}).insertAfter(i);return null!==o&&setTimeout(()=>{removeInputNotification(r)},o),r}function updateInputNotification(e,t){$(`#${e}`).text(t)}function removeInputNotification(e){$(`#${e}`).remove()}$(document).keydown(function(e){e.keyCode});const API_TIMER=e=>new Promise(t=>setTimeout(t,e)),getMax=e=>Object.keys(e).filter(t=>e[t]==Math.max.apply(null,Object.values(e)));function getTextArea(e){return $(`#${e} textarea`)}function getFieldId(e){return e.attr("id")}function updateFieldsInArrays(e){const t=$(`#${e}`).length>0?e:`connection-form-view:has(input[value="${e}"])`,n=FIELD_IDS_FOR_LOGGED_IN_USER.filter(e=>$(`#${t} #kn-input-field_${e}`).length>0),o=SET_CURRENT_DATE_FIELDS.filter(e=>$(`#${t} #kn-input-field_${e}`).length>0);n.length>0&&updateUserFields(e,n),o.length>0&&updateDateFields(e,o)}function updateUserFields(e,t){const n=Knack.getUserAttributes().name;t.forEach(e=>{const t=$(`#kn-input-field_${e}`),o=t.find("input");t.addClass("ktlHidden"),o.val(n)})}function updateDateFields(e,t){const n=new Date;t.forEach(t=>{if($("#view_3404").length>0)return!1;const o=$(`#${e}-field_${t}`),r=$(`#${e}-field_${t}-time`);if(o.val()||o.val(getDateUKFormat(n)),!r.val()){const e=`${n.getHours()}:${n.getMinutes()}`;r.val(e)}})}function copyTextToClipboard(e,t,n){if(navigator.clipboard)navigator.clipboard.writeText(t);else{const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select();try{document.execCommand("copy")}catch(e){}document.body.removeChild(e)}const o=e.closest("td, .kn-detail-body");if(o&&(o.style.position="relative",o.style.overflow="visible"),showNotification({target:o||e,message:n,backgroundColor:"var(--success)",className:"ca-notification ca-notification-copy",delay:1e3}),o&&!o.closest("table")){const e=o.querySelector(".ca-notification-copy");e&&(e.style.left="120px",e.style.opacity="0.85")}}function addCopyToDetails(e,t={}){if(!e)return;const{addIcon:n=!0,message:o="Text Copied",excludeFieldIds:r=[],includeLabels:i=!1}=t;e.querySelectorAll(".kn-detail-body").forEach(t=>{if(t.closest(".kn-details-link"))return;const s=t.closest('[class*="field_"]');if(s){if(Array.from(s.classList).some(e=>r.includes(e)))return}const a=t.textContent.trim();if(!a)return;if("true"===t.dataset.copyEnabled)return;t.dataset.copyEnabled="true";let l=a;if(i&&s){const t=[...s.classList].find(e=>e.startsWith("field_"));let n="";if(t){const o=e.querySelector(`.kn-label-top.${t}, .kn-detail.${t}`),r=o?.querySelector(".kn-detail-label");n=r?.textContent.trim()||"",console.log(`Label wrapper for ${t}:`,r)}n&&(l=`${n}: ${a}`)}if(n){const e=document.createElement("span");e.textContent=" ðŸ“‹",e.style.userSelect="none",t.appendChild(e)}t.style.cursor="pointer",t.addEventListener("click",()=>{copyTextToClipboard(t,l,o)})})}function setupClickToCopy(e){document.querySelectorAll(`#${e} .ca-click-to-copy`).forEach(e=>{let t=e.textContent.trim();if("ðŸ“‹"===t||""===t)return void(e.style.display="none");t=t.replace(" ðŸ“‹",""),e.textContent.includes("ðŸ“‹")||(e.textContent=t+" ðŸ“‹");let n="Text Copied";e.classList.contains("client-contact-num")?n="Client Number Copied":e.classList.contains("funder-email")?n="Funder Email Copied":e.classList.contains("funder-contact-num")?n="Funder Number Copied":e.classList.contains("funder-office-num")?n="Funder Office Number Copied":e.classList.contains("client-email")&&(n="Client Email Copied"),e.addEventListener("click",function(){copyTextToClipboard(e,t,n)})})}function getWeekCommencingDate(e){const t=e.getDay(),n=(0===t?-6:1)-t,o=new Date(e);return o.setDate(e.getDate()+n),o.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}function scheduleDailyRefresh(e,t,n){const o=new Date,r=new Date;r.setHours(t,n,0,0),o>r&&r.setDate(r.getDate()+1);setTimeout(function(){ktl.views.refreshView(e),setInterval(function(){ktl.views.refreshView(e)},864e5)},r-o)}function getCurrentYear(){return(new Date).getFullYear()}function constructList(e,t){let n=e.join(", ");if(e.length>1){let e=n.lastIndexOf(",");n=n.slice(0,e)+" "+t+n.slice(e+1)}return n}function csvToArray(e,t=!1){if(!e||"string"!=typeof e)return console.error("Invalid input. Please provide a non-empty string."),[];let n=e.split(",").map(e=>e.trim());return t&&(n=[...new Set(n)]),n}function startsWithVowel(e){return-1!=="aeiouAEIOU".indexOf(e[0])}function updateViewTitleIfSelectorFound(e,t,n){ktl.core.waitSelector(t,1e4).then(()=>{const o=$(`#${e} h3.kn-title:first`);$(t).length>0&&o.text(n)})}function onInputChange(e,t,n=!0){e.on("change",function(){t(this)}),n&&e.change()}function toggleMessage(e,t){const n=document.querySelectorAll(`.kn-input:has(${t}), .kn-special-title:has(${t})`);if(0===n.length){document.querySelectorAll(".kn-input, .kn-special-title").forEach(n=>{n.querySelector(t)&&(n.style.display=e?"block":"none")})}else n.forEach(t=>{t.style.display=e?"block":"none"})}function replaceTextInGrid(e,t,n){const o=n.startsWith("field_")?$(`#${e} .kn-table thead th.${n}`).index():$(`#${e} .kn-table thead th:textEquals('${n}')`).index();$(`#${e} .kn-table tbody tr`).each(function(){const e=$(this).find(`td:eq(${o}) span.knViewLink__label`),n=$(this).find(`td.${t}`).find("span").html();e.html(n).find("span").css("text-decoration","none")})}function removeBlanksFromDF(e,t){const n=/^-+\s*-*$/;e.find(".removeIfBlank").each(function(){let e=$(this).text().trim(),o=e;if(t){const n=e.split(t);o=n.length>1?n[1].trim():""}(""===o||n.test(o))&&removeElement(this)})}function hideEmptyListItems(e){$(`#${e}`).find(".kn-list-container").each(function(){""===$(this).text().trim()&&$(this).hide()})}function mapDateToRange(e,t){const[n,o,r]=e.split("/").map(Number),i=new Date(r,o-1,n),s=new Date,a=12*(s.getFullYear()-i.getFullYear())+(s.getMonth()-i.getMonth());for(const e of t)if(a<e.max)return e.label;return console.error(`No match found in range "${t}" for date "${e}".`),!1}function parseDateObject(e){if(e instanceof Date)return Number.isNaN(e.getTime())?null:new Date(e.getTime());if("number"==typeof e){const t=new Date(e);return Number.isNaN(t.getTime())?null:t}if("string"==typeof e){const t=removeHtml(e).trim(),n=/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/.exec(t);if(n){const e=parseInt(n[1],10),t=parseInt(n[2],10);let o=parseInt(n[3],10);o<100&&(o+=2e3);const r=new Date(o,t-1,e);return r.getFullYear()===o&&r.getMonth()===t-1&&r.getDate()===e?r:null}const o=new Date(t);return Number.isNaN(o.getTime())?null:o}return null}function getOffsetDateUK(e,t=0){const n=parseDateObject(e);return n?(n.setDate(n.getDate()+t),getDateUKFormat(n)):(console.warn("getOffsetDateUK: cannot parse date:",e),"")}function getDateUKFormat(e){return e.toLocaleDateString("en-GB")}function getWeeksAgoDate(e){const t=new Date,n=7*e*24*60*60*1e3;return getDateUKFormat(new Date(t.getTime()-n))}function getArrayOfWeekNumbersAndFields(e){return Array.from({length:52},(t,n)=>`field_${e+n}`)}function getWeekNumber(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()));t.setUTCDate(t.getUTCDate()+4-(t.getUTCDay()||7));const n=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-n)/864e5+1)/7)}async function updateWeekNumberObject(e,t,n,o){const r=WEEK_NUM_SHARED_AREA_GRID,i=getWeekNumber(convertToDateObj(t)),s=r.weekNumberFields[i-1],a=createFilterForWeekObj(r,e,o),l=(await caAPI(r.sceneId,r.viewId,null,{},"get",a)).records[0].id;l&&await caAPI(r.sceneId,r.viewId,l,{[s]:n},"put")}function createFilterForWeekObj(e,t,n){return{match:"and",rules:[{field:e.conxField,operator:"is",value:[t]},{field:e.typeField,operator:"is",value:n}]}}function showRelevantWeeks(e,t,n=11,o=7){const r=window.WEEK_NUM_SHARED_AREA_GRID,i=getWeekNumber(new Date),s=r.weekNumberFields,a=document.getElementById(e);if(!a)return void console.warn(`View element with ID ${e} not found`);const l=a.querySelector("thead"),c=a.querySelector("tbody");if(!l||!c)return void console.warn(`Table header or body not found in view ${e}`);s.forEach(e=>{a.querySelectorAll(`.${e}`).forEach(e=>e.style.display="none")});const d=[];for(let e=0;e<n;e++){const t=(i-o+e+52)%52||52,n=t-1;d.push({field:s[n],isCurrentWeek:t===i})}const u=l.querySelector("tr");u&&d.forEach(e=>{const t=u.querySelector(`.${e.field}`);t&&(t.style.display="",u.appendChild(t))});c.querySelectorAll("tr").forEach(e=>{d.forEach(n=>{const o=e.querySelector(`.${n.field}`);o&&(o.style.display="",n.isCurrentWeek&&(o.style.backgroundColor=t),e.appendChild(o))})})}function compareAge(e,t,n){const o=convertToDateObj(e),r=Date.now()-o.getTime(),i=new Date(r),s=Math.abs(i.getUTCFullYear()-1970);return evaluate(s)(n)(t)}async function addConxDetailsToList(e,t,n="",o="detail",r=2e4){try{const i=$(e).addClass("custom-list");if(i.find("li").length>0)return;const s="list"===o?`.kn-list-item-container .${t} .kn-detail-body span`:`.${t} .kn-detail-body span`;await ktl.core.waitSelector(s,r);const a=$(s),l=[];if(a.each(function(e){const t=$(this),n=t.text().trim(),o=t.children("span").length>0;n&&!o&&l.push(n)}),0===l.length&&n)i.append(`<li>${n}</li>`);else{const e=new Set;l.forEach((t,n)=>{e.has(t)||(i.append(`<li>${t}</li>`),e.add(t))})}}catch(e){throw new Error(`Failed to add details to list: ${e}`)}}function mapFieldsToView(e,t,n,o,r){const i=(e,t,n)=>{const i=`#${o} #kn-input-field_${e} ${t}`,s=`#${r} #kn-input-field_${e} ${t}`;0!==$(i).length&&0!==$(s).length?($(s).closest(".kn-input").addClass("ktlHidden"),$(i).on(n,function(){const n=t===INPUT_RADIO_SELECTOR?$(`#kn-input-field_${e} ${INPUT_RADIO_CHECKED_SELECTOR}`).val():$(this).val();t===INPUT_RADIO_SELECTOR?$(`${s}`).filter(`[value="${n}"]`).trigger("click"):($(s).val(n),"select"===t&&$(s).trigger("liszt:updated"))})):console.error(`Element not found: ${i} or ${s}`)};e.forEach(e=>i(e,"textarea","blur")),t.forEach(e=>i(e,INPUT_RADIO_SELECTOR,"change")),n.forEach(e=>i(e,"select","change"))}const MULTI_FORM_CONFIG={TIMEOUTS:{BUTTON_WAIT:1e4,FORM_SUBMIT:3e4,PRE_SUBMIT_DELAY:200,MODAL_CLOSE_DELAY:200,OUTCOME_POLL_INTERVAL:500},SELECTORS:{SUBMIT_BUTTON:"button[type=submit]",FORM:"form",SUCCESS_MESSAGE:".kn-message.success",ERROR_MESSAGE:".kn-message.is-error",MODAL:".kn-modal",MODAL_CLOSE:"button.close-modal"}};class MultiFormSubmissionCoordinator{constructor(e){this.manualSubmitViewId=e.manualSubmitViewId,this.autoSubmitViewIds=e.autoSubmitViewIds||[],this.closeModalAfterSubmit=e.closeModalAfterSubmit||!1,this.onAutoFormsComplete=e.onAutoFormsComplete||null,this.timeouts={...MULTI_FORM_CONFIG.TIMEOUTS,...e.timeouts||{}},this.selectors={...MULTI_FORM_CONFIG.SELECTORS,...e.selectors||{}},this.eventHandlers=new Map,this.isInitialized=!1,this.submittedForms=new Set,this.instanceId=`mfc-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}initialize(e){e===this.manualSubmitViewId?this._attachManualFormHandler():this.autoSubmitViewIds.includes(e)&&this._waitForManualForm()}_getEventNamespace(e,t){return`${e}.${t}.${this.instanceId}`}_isValidationError(e){return e.message.includes("Form validation failed")}async _waitForManualForm(){try{await waitSelector({selector:`#${this.manualSubmitViewId} ${this.selectors.SUBMIT_BUTTON}`,timeout:this.timeouts.BUTTON_WAIT}),this._attachManualFormHandler()}catch(e){errorHandler.handleError(e,{manualSubmitViewId:this.manualSubmitViewId,autoSubmitViewIds:this.autoSubmitViewIds},"MultiFormCoordinator:WaitForManualForm")}}_attachManualFormHandler(){if(this.isInitialized)return;this._hideAutoSubmitButtons();const e=document.getElementById(this.manualSubmitViewId);if(!e)return console.error(`[MultiFormCoordinator] Manual submit view "${this.manualSubmitViewId}" not found`),void errorHandler.handleError(new Error(`Manual submit view "${this.manualSubmitViewId}" not found`),{manualSubmitViewId:this.manualSubmitViewId},"MultiFormCoordinator");const t=e.querySelector(this.selectors.FORM),n=e.querySelector(this.selectors.SUBMIT_BUTTON);if(!t||!n)return console.error(`[MultiFormCoordinator] Form or submit button not found in view "${this.manualSubmitViewId}"`),void errorHandler.handleError(new Error(`Form or submit button not found in view "${this.manualSubmitViewId}"`),{manualSubmitViewId:this.manualSubmitViewId,formExists:!!t,buttonExists:!!n},"MultiFormCoordinator");this._cleanupPreviousHandler(n);const o=async e=>{e.preventDefault(),e.stopPropagation(),await this._handleFormSubmission(t,n)},r=e=>{e.preventDefault(),e.stopPropagation()};n._multiSubmitHandler=o,n.addEventListener("click",o),t._multiFormSubmitHandler=r,t.addEventListener("submit",r),this.isInitialized=!0}_hideAutoSubmitButtons(){this.autoSubmitViewIds.forEach(e=>{const t=this._getEventNamespace("knack-view-render",e);$(document).off(t),$(document).on(t,()=>{const t=document.querySelector(`#${e} ${this.selectors.SUBMIT_BUTTON}`);t&&t.classList.add("ktlHidden")}),this.eventHandlers.set(`render-${e}`,t),waitSelector({selector:`#${e} ${this.selectors.SUBMIT_BUTTON}`,timeout:this.timeouts.BUTTON_WAIT}).then(e=>e&&e.classList.add("ktlHidden")).catch(()=>{})})}async _handleFormSubmission(e,t){t.disabled=!0,this._setFormInputsDisabled(e,!0);let n=[];try{n=await this._submitAutoForms(),this.onAutoFormsComplete&&this.onAutoFormsComplete(n),this._setFormInputsDisabled(e,!1),t.disabled=!1,await this._submitManualForm(e)}catch(o){errorHandler.handleError(o,{manualSubmitViewId:this.manualSubmitViewId,autoSubmitViewIds:this.autoSubmitViewIds,outcomes:n},"MultiFormCoordinator:HandleSubmission"),this._setFormInputsDisabled(e,!1),t.disabled=!1}}_validateForm(e,t){if(!t)return{isValid:!1,invalidInputs:[],errorMessage:`Form not found for ${e}`};const n=t.querySelectorAll("input, select, textarea"),o=Array.from(n).filter(e=>Array.from(e.classList).some(e=>e.startsWith("ktlNotValid_")));if(0===o.length)return{isValid:!0,invalidInputs:[],errorMessage:""};const r=o.map(e=>{const t=Array.from(e.classList).filter(e=>e.startsWith("ktlNotValid_")).join(", ");return`#${e.id||e.name} (${t})`}).join(", ");return{isValid:!1,invalidInputs:o,errorMessage:`Form validation failed for ${e}. Found ${o.length} invalid input(s): ${r}`}}async _submitAutoForms(){const e=[];for(const t of this.autoSubmitViewIds)if(this.submittedForms.has(t))e.push({success:!0,viewId:t,skipped:!0,reason:"Already submitted"});else try{const n=await this._submitSingleAutoForm(t);e.push(n),n.success&&this.submittedForms.add(t)}catch(e){throw this._isValidationError(e)||errorHandler.handleError(e,{manualSubmitViewId:this.manualSubmitViewId,autoSubmitViewIds:this.autoSubmitViewIds,failedViewId:t,submittedForms:Array.from(this.submittedForms)},"MultiFormCoordinator:SubmitAutoForms"),e}return e}async _submitSingleAutoForm(e){const t=document.getElementById(e);if(!t)throw new Error(`Auto submit view "${e}" not found`);const n=t.querySelector(this.selectors.FORM),o=t.querySelector(this.selectors.SUBMIT_BUTTON);if(!n||!o)throw new Error(`Form or submit button not found in auto view "${e}"`);try{this._setFormInputsDisabled(n,!1),o.disabled=!1;const t=this._validateForm(e,n);if(!t.isValid)throw console.error(`[MultiFormCoordinator] ${t.errorMessage}`),new Error(t.errorMessage);const r=this._waitForFormSubmitOutcome(e);o.click();const i=await r;return setVisibility(`#${e} ${this.selectors.SUCCESS_MESSAGE}`,!1),this._setFormInputsDisabled(n,!0),{success:!0,viewId:e,record:i.record||null,timestamp:(new Date).toISOString()}}catch(n){throw this._isValidationError(n)||errorHandler.handleError(n,{autoViewId:e,manualSubmitViewId:this.manualSubmitViewId,viewExists:!!t},"MultiFormCoordinator:SubmitSingleAutoForm"),n}}_waitForFormSubmitOutcome(e){return new Promise((t,n)=>{let o=!1;const r=setTimeout(()=>{c(),n(new Error(`Form submission timeout for ${e} after ${this.timeouts.FORM_SUBMIT}ms`))},this.timeouts.FORM_SUBMIT),i=document.getElementById(e);if(!i)return c(),void n(new Error(`View element not found: ${e}`));const s=()=>{const o=i.querySelector(this.selectors.SUCCESS_MESSAGE);if(o&&null!==o.offsetParent)return c(),t({success:!0,record:null,view:e,message:o.textContent.trim()}),!0;const r=i.querySelector(this.selectors.ERROR_MESSAGE);if(r&&null!==r.offsetParent)return c(),n(new Error(`Form submission failed: ${r.textContent.trim()}`)),!0;const s=i.querySelectorAll('input.invalid, select.invalid, textarea.invalid, [aria-invalid="true"]');if(s.length>0){const e=Array.from(s).map(e=>{const t=e.closest(".kn-input")?.querySelector(".kn-label");return t?t.textContent.trim().replace("*","").trim():"Unknown field"}).filter((e,t,n)=>n.indexOf(e)===t).slice(0,3).join(", ");return c(),n(new Error(`Form validation failed: Required fields missing or invalid (${e})`)),!0}return!1},a=new MutationObserver(s);a.observe(i,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style","aria-invalid"]}),s(),setTimeout(s,this.timeouts.OUTCOME_POLL_INTERVAL);const l=setInterval(()=>{o||s()},this.timeouts.OUTCOME_POLL_INTERVAL),c=()=>{o||(o=!0,clearTimeout(r),clearInterval(l),a.disconnect())};this.eventHandlers.set(`submit-${e}`,c)})}async _submitManualForm(e){return new Promise((t,n)=>{setTimeout(()=>{try{$(e).submit(),this.closeModalAfterSubmit&&document.querySelector(this.selectors.MODAL)&&setTimeout(()=>{document.querySelector(this.selectors.MODAL_CLOSE)?.click()},this.timeouts.MODAL_CLOSE_DELAY),t()}catch(e){errorHandler.handleError(e,{manualSubmitViewId:this.manualSubmitViewId},"MultiFormCoordinator:SubmitManualForm"),n(e)}},this.timeouts.PRE_SUBMIT_DELAY)})}_setFormInputsDisabled(e,t){e&&e.querySelectorAll("input, select, textarea, button").forEach(e=>{e.disabled=t})}_cleanupPreviousHandler(e){e._multiSubmitHandler&&(e.removeEventListener("click",e._multiSubmitHandler),delete e._multiSubmitHandler);const t=e.closest("form");t&&t._multiFormSubmitHandler&&(t.removeEventListener("submit",t._multiFormSubmitHandler),delete t._multiFormSubmitHandler)}destroy(){const e=document.getElementById(this.manualSubmitViewId);if(e){const t=e.querySelector(this.selectors.FORM),n=e.querySelector(this.selectors.SUBMIT_BUTTON);n&&n._multiSubmitHandler&&(n.removeEventListener("click",n._multiSubmitHandler),delete n._multiSubmitHandler),t&&t._multiFormSubmitHandler&&(t.removeEventListener("submit",t._multiFormSubmitHandler),delete t._multiFormSubmitHandler)}this.eventHandlers.forEach(e=>{$(document).off(e)}),this.eventHandlers.clear(),this.submittedForms.clear(),this.isInitialized=!1}}function setupAutoFormSubmission(e,t,n,o=!1){const r=new MultiFormSubmissionCoordinator({manualSubmitViewId:e,autoSubmitViewIds:t,closeModalAfterSubmit:o});return r.initialize(n),r}async function addConnectionIdToRecord(e,t,n=null,o){const r=$(`#${e}`).length>0?$(`#${e}`):$(`#connection-form-view:has(input[value="${e}"])`),i=r.find(`#kn-input-field_${t}`),s=i.find("select"),a=n||getRecordID();i.addClass("ktlHidden");const l=e=>{s.val(e).trigger("liszt:updated")};await ktl.core.waitSelector(`${r.selector} #kn-input-field_${t} select option`,2e4);if(s.find("option").length>1)l(a);else{const{sceneIdAPI:e,viewIdAPI:t,clientPKField:r}=CONNECTION_FIELDS_OBJECT[o];try{const o=(await caAPI(e,t,n,{},"get",{},[],!1))[`${r}_raw`],a=i.find(".chzn-search input");a.trigger("focus").val(o).trigger("input");const c=setInterval(()=>{const e=s.find("option").filter((e,t)=>$(t).text()===o);e.length>0&&(l(e.val()),a.trigger("blur"),clearInterval(c),clearTimeout(d))},500),d=setTimeout(()=>{clearInterval(c),console.log(`Timeout: Could not find item "${o}" in the dropdown.`)},1e4)}catch(e){console.error("Error fetching data from API:",e)}}}function validateInputEmpty(e){const t=$(`#${e}`);return t.on("blur",function(){t.val()?removeClassFromSelector(t,"inputInvalid"):t.addClass("inputInvalid")}),!!t.val()||(t.addClass("inputInvalid").focus(),t[0].scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),!1)}function disableCellsByColHead(e,t){const n=document.getElementById(e);if(!n)return;const o=n.querySelector("table");if(!o)return;const r=o.querySelectorAll("thead th");let i=-1;r.forEach((e,n)=>{e.classList.contains(`field_${t}`)&&(i=n)}),-1!==i&&getAllTableRows(e,(e,t)=>{const n=t.children[i];n&&n.classList.add("disabled")})}function isInOfficeHours(e="08:30",t="16:30"){const n=e=>{const[t,n]=e.split(":").map(Number);return 60*t+n},o=n(e),r=n(t),i=new Date,s=60*i.getHours()+i.getMinutes();return 0!==i.getDay()&&6!==i.getDay()&&(o<=s&&s<=r)}function setupLocalStorageMinutes(e,t,n){const o=getRecordID();initSecureStorage(e),t.forEach(t=>{getTextArea(t).on("blur",function(){const t=getFieldId($(this));setSecureStorage(e,o,t,$(this).val())}),$(`#${t} .redactor-editor`).on("blur",function(){const t=getFieldId($(this).closest(".kn-input"));setSecureStorage(e,o,t,$(this).html())})}),ktl.core.waitSelector(`.kn-details-link a:contains("${n}")`,5e3).then(()=>{$(`.kn-details-link a:contains("${n}")`).on("click",function(n){n.preventDefault(),getSecureStorage(e,o).then(e=>{e&&reloadMinutes(t,e)})})})}function reloadMinutes(e,t){e.forEach(e=>{getTextArea(e).each(function(){const e=getFieldId($(this)),n=t[e];n&&$(`#${e}`).val(n)}),$(`#${e} .redactor-editor`).each(function(){const e=getFieldId($(this).closest(".kn-input")),n=t[e];n&&($(`#${e} .redactor-editor`).html(n),$(`#${e} textarea`).val(n))})})}function showHideGroup(e,t){const n=e.map(e=>waitSelector({selector:`#view_${e}`}));Promise.all(n).then(()=>{const n=`view_${e[0]}`,o=`showHide_${n}`,r=`.${o}`,i=`<a class="ktlShrinkLink" id="shrink-link_${o}">Shrink &nbsp;<span class="ktlArrow ktlUp" id="arrow_${o}">â—€</span></a>`;waitSelector({selector:`#${n} h2.kn-title`}).then(s=>{const a=s.textContent.trim(),l=`<div class="ktlHideShowButton" id="${o}">${a} &nbsp;<span class="ktlArrow ktlDown" id="arrow_${o}">â—€</span></div>`,c=document.getElementById(n);let d=document.getElementById(`${n}_wrapper`);if(document.getElementById(o)||(s.style.display="none",c&&c.insertAdjacentHTML("beforebegin",l),wrapContentForShowHideGroup(e,o),d=document.getElementById(`${n}_wrapper`),d&&!document.getElementById(`shrink-link_${o}`)&&d.insertAdjacentHTML("beforeend",i)),c){const e=c.querySelector(".kn-description");if(e&&""!==e.textContent.trim()&&!document.querySelector(`${r} .kn-description`)){const t=document.querySelector(r);t&&(t.insertBefore(e,t.firstChild),e.style.display="")}}showHideViewGroupContent(o,1e3,t),d&&(d.style.marginTop="13px")})}).catch(t=>{isDeveloper&&console.warn("view/s missing from page",e,t)})}function wrapContentForShowHideGroup(e,t){const n=`view_${e[0]}`,o=document.getElementById(n);if(document.getElementById(`${n}_wrapper`))return;const r=document.createElement("section");r.className=`${t} ktlBoxWithBorder ktlHideShowSection`,r.id=`${n}_wrapper`,r.style.display="none";const i=document.createElement("div");i.className="view-wrapper",o.parentNode.insertBefore(r,o),r.appendChild(i),i.appendChild(o),e.slice(1).forEach(e=>{const t=document.getElementById(`view_${e}`);t&&i.appendChild(t)})}function showHideViewGroupContent(e,t,n=!1){const o=document.getElementById(e),r=document.getElementById(`arrow_${e}`),i=document.querySelector(`.${e}`),s=document.getElementById(`shrink-link_${e}`);function a(e,t=600,n="block"){const o="none"===window.getComputedStyle(e).display,r=function(e){const t=window.getComputedStyle(e);return{paddingTop:t.paddingTop,paddingBottom:t.paddingBottom,marginTop:t.marginTop,marginBottom:t.marginBottom}}(e);if(o){e.style.removeProperty("display");let o=window.getComputedStyle(e).display;"none"===o&&(o=n),e.style.display=o,e.style.overflow="hidden",e.style.height="0px",e.style.paddingTop="0px",e.style.paddingBottom="0px",e.style.marginTop="13px",e.style.marginBottom="0px",e.offsetHeight,requestAnimationFrame(()=>{e.style.transition=[`height ${t}ms cubic-bezier(0.33,0,0.2,1)`,`padding-top ${t}ms cubic-bezier(0.33,0,0.2,1)`,`padding-bottom ${t}ms cubic-bezier(0.33,0,0.2,1)`,`margin-top ${t}ms cubic-bezier(0.33,0,0.2,1)`,`margin-bottom ${t}ms cubic-bezier(0.33,0,0.2,1)`].join(", "),e.style.height=e.scrollHeight+"px",e.style.paddingTop=r.paddingTop,e.style.paddingBottom=r.paddingBottom,e.style.marginTop=r.marginTop,e.style.marginBottom=r.marginBottom}),setTimeout(()=>{e.style.transition="",e.style.height="auto",e.style.overflow="",e.style.paddingTop="",e.style.paddingBottom="",e.style.marginTop="13px",e.style.marginBottom="";let t=e.closest('[id^="view_"]');if(t){const e=t.querySelectorAll(".kn-input-signature"),n=t.id;e.length&&window.Knack&&Knack.views&&Knack.views[n]&&"function"==typeof Knack.views[n].renderSignatures&&Knack.views[n].renderSignatures();const o=t.querySelector(".kn-table-group td"),r=t.querySelectorAll('th:not([style*="display: none"])');if(o&&r.length){const e=r.length;parseInt(o.getAttribute("colspan"),10)!==e&&o.setAttribute("colspan",e)}}},t)}else e.style.height=e.scrollHeight+"px",e.style.overflow="hidden",e.offsetHeight,requestAnimationFrame(()=>{e.style.transition=[`height ${t}ms cubic-bezier(0.33,0,0.2,1)`,`padding-top ${t}ms cubic-bezier(0.33,0,0.2,1)`,`padding-bottom ${t}ms cubic-bezier(0.33,0,0.2,1)`,`margin-top ${t}ms cubic-bezier(0.33,0,0.2,1)`,`margin-bottom ${t}ms cubic-bezier(0.33,0,0.2,1)`].join(", "),e.style.height="0px",e.style.paddingTop="0px",e.style.paddingBottom="0px",e.style.marginTop="13px",e.style.marginBottom="0px"}),setTimeout(()=>{e.style.display="none",e.style.transition="",e.style.height="",e.style.overflow="",e.style.paddingTop="",e.style.paddingBottom="",e.style.marginTop="13px",e.style.marginBottom=""},t)}o&&r&&i&&(o.onclick=function(){a(i,t,n?"flex":"block"),r.classList.toggle("ktlDown"),r.classList.toggle("ktlUp"),o.classList.toggle("ktlActive"),n&&"none"!==window.getComputedStyle(i).display&&(i.style.display="flex")},s&&(s.onclick=function(){!function(e,t=400){"none"!==window.getComputedStyle(e).display&&(e.style.height=e.scrollHeight+"px",e.style.overflow="hidden",e.offsetHeight,requestAnimationFrame(()=>{e.style.transition=`height ${t}ms cubic-bezier(0.33,0,0.2,1)`,e.style.height="0px"}),setTimeout(()=>{e.style.display="none",e.style.transition="",e.style.height="",e.style.overflow=""},t))}(i,t),r.classList.toggle("ktlDown"),r.classList.toggle("ktlUp"),o.classList.remove("ktlActive")}))}function addCheckboxes(e,t,n=!0){const o=document.getElementById(e);if(!o)return;const r=o.querySelector("table.kn-table");if(!r)return;const i=r.querySelector("thead tr"),s=r.querySelectorAll("tbody tr:not(.kn-tr-nodata)");let a=i.querySelector("th.header-checkbox-th");a||(a=document.createElement("th"),a.className="header-checkbox-th"),i.firstChild!==a&&i.insertBefore(a,i.firstChild);let l=null;if(n)l=a.querySelector('input[type="checkbox"]'),l||(l=document.createElement("input"),l.type="checkbox",l.className="header-checkbox",a.appendChild(l));else{const e=a.querySelector('input[type="checkbox"]');e&&e.remove()}s.forEach(n=>{let o=n.querySelector("td.row-checkbox-td");if(!o){o=document.createElement("td"),o.className="row-checkbox-td",o.style.maxWidth="32px";const i=document.createElement("input");i.type="checkbox",i.className="row-checkbox",o.appendChild(i),n.insertBefore(o,n.firstChild),addInputEventListener(i,function(o){const a=Array.from(r.querySelectorAll(`tbody tr:not(.kn-tr-nodata) ${INPUT_CHECKBOX_SELECTOR}`)).every(e=>e.checked);if(l&&(l.checked=a),"function"==typeof t){const a=r.querySelectorAll('tbody tr:not(.kn-tr-nodata) input[type="checkbox"].row-checkbox:checked').length;t({type:"row",checked:i.checked,row:n,viewId:e,checkedCount:a,totalCount:s.length,headerChecked:!!l?.checked,event:o||null})}},{events:"change"})}}),l&&addInputEventListener(l,function(n){const o=l.checked;if(s.forEach(e=>{const t=e.querySelector(`td.row-checkbox-td ${INPUT_CHECKBOX_SELECTOR}`);t&&(t.checked=o)}),"function"==typeof t){const r=o?s.length:0;t({type:"header",checked:o,viewId:e,checkedCount:r,totalCount:s.length,headerChecked:!!l.checked,event:n||null})}},{events:"change"})}function addCheckboxesToHeaders(e,t){const n=document.getElementById(e);if(!n)return;const o=n.querySelector("table.kn-table");if(!o)return;const r=o.querySelector("thead tr");if(r&&(Array.from(r.children).forEach(e=>{if(!Array.from(e.classList).find(e=>e.startsWith("field_")))return;let t=e.querySelector(".header-flex-wrap");if(!t){for(t=document.createElement("span"),t.className="header-flex-wrap",t.style.display="inline-flex",t.style.alignItems="center",t.style.gap="4px";e.firstChild;)t.appendChild(e.firstChild);e.appendChild(t)}if(t.querySelector(INPUT_CHECKBOX_SELECTOR)){const e=t.querySelector(INPUT_CHECKBOX_SELECTOR);e!==t.firstChild&&t.insertBefore(e,t.firstChild),e.style.verticalAlign="middle",e.style.marginRight="6px"}else{const e=document.createElement("input");e.type="checkbox",e.className="header-checkbox",e.style.verticalAlign="middle",e.style.marginRight="6px",t.insertBefore(e,t.firstChild)}}),"function"==typeof t)){const e=r.querySelectorAll(`${INPUT_CHECKBOX_SELECTOR}.header-checkbox`);addInputEventListener(e,function(){const n=Array.from(e).filter(e=>e.checked).map(e=>{const t=e.closest("th");if(!t)return null;const n=Array.from(t.classList).find(e=>e.startsWith("field_"));return n?n.replace("field_",""):null}).filter(Boolean);t(n)},{events:"change"})}}function prependTextToGroupBy(e,t,n=1){$(`#${t} .kn-group-level-${n} td`).prepend(`${e} `)}function getTableRows(e,t,n=!1,o=!1){if(!e)return;const r=$(`#${e} table`);let i=r.find("tbody tr:not(.kn-table-group)");if(n){const e=r.find("thead tr");i=i.add(e)}if(o){const e=r.find("tbody tr.kn-table-group");i=i.add(e)}i.each((e,n)=>{t(e,$(n))})}function extractPostcode(e){if(!e)return"";const t=removeHtml(e).trim().match(/[A-Z]{1,2}\d{1,2}[A-Z]?\s*\d[A-Z]{2}$/i);return t?t[0].toUpperCase():""}function fileViewer(e,t){return OFFICE_EXTENSIONS.includes(e)?`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(t)}`:"pdf"===e?`https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(t)}`:`https://docs.google.com/gview?url=${encodeURIComponent(t)}`}function weeksBetween(e,t){var n=Math.abs(t-e);return Math.ceil(n/6048e5)}function convertToDateObj(e){var t=e.split("/");return new Date(t[2],t[1]-1,t[0])}function isElementVisible(e,t=document){const n=t&&"function"==typeof t.querySelector?t:document,o="string"==typeof e?n.querySelector(e):e;if(!o||!o.isConnected)return!1;const r=window.getComputedStyle(o);return"none"!==r.display&&"hidden"!==r.visibility&&null!==o.offsetParent}function areAllInputsEmpty(e,t=[]){if(!e)return!0;const n=$(`#${e}`),o=n.find('input[type="text"]:not(.search-field input[type="text"]), input[type="number"], input[type="email"], textarea'),r=n.find("select");for(let e=0;e<o.length;e++){const n=$(o[e]),r=n.attr("id");if(t.includes(r))continue;if(""!==n.val().trim())return!1}for(let e=0;e<r.length;e++){const n=$(r[e]),o=n.attr("id");if(t.includes(o))continue;const i=n.find("option:selected");if(i.length>0&&""!==i.val())return!1}const i=n.find('input[type="radio"]:checked, input[type="checkbox"]:checked');for(let e=0;e<i.length;e++){const n=$(i[e]).attr("name").split("-").pop();if(!t.includes(n))return!1}return!0}const isInputEmpty=(e,t)=>{const n="string"==typeof e?document.getElementById(e):e;if(!n)return console.warn("isInputEmpty: element not found for",e),null;switch(t){case"choice":return 0===n.querySelectorAll("input:checked").length;case"textarea":{const e=n.querySelector('textarea, input[type="text"], input[type="number"], input[type="email"]');return!e||""===e.value.trim()}case"dropdown":{const e=n.querySelector("select"),t=e?e.value:"";return""===t||null===t}default:return console.warn(`isInputEmpty: unknown field type "${t}"`),!1}};function replaceValueInTD(e,t,n,o){const r=document.getElementById(e);if(!r)return;const i=r.querySelector("table");if(!i)return;const s=getIndexOfColumnHeader(i,t);-1!==s&&getAllTableRows(e,(e,t)=>{const r=t.querySelectorAll("td")[s];r&&r.textContent.trim().includes(n)&&(r.textContent=o)})}function filterSelectByText(e,t,n){$("#"+e+`_field_${t}_chzn li`).each(function(){-1!=$(this).text().indexOf(n)?$(this).show():$(this).hide()})}async function triggerWebhook(e,t,n="Unnamed Webhook",o=!1){if(!e.startsWith("https://")){const t=`Invalid webhook URL: ${e} in webhook: ${n}`;return console.error(t),{error:t}}let r=null;try{const i=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",userToken:o?Knack.getUserToken():""},body:JSON.stringify(t)});if(r=await(async e=>{const t=e.headers.get("Content-Type");return t&&t.includes("application/json")?await e.json():await e.text()})(i),!i.ok)throw console.error(`Webhook (${n}) failed with status ${i.status}:`,r),new Error(`Network response was not ok: ${r}`);return console.log(`Webhook (${n}) sent successfully with response:`,r),{success:!0,data:r,error:null}}catch(e){throw console.error(`Error triggering webhook: ${n}`,e),{success:!1,data:r,error:e.message,webhookName:n}}}async function delayAPIPut(e=null,t=null,n=[],o,r=[],i=500){for(var s=0;s<n.length;s++)caAPI(e,t,n[s],o,"put",{},r,!0),await API_TIMER(i)}class KnackAPI{constructor(e={}){this.options={showSpinner:void 0!==e.showSpinner&&e.showSpinner,timeout:e.timeout||6e4,debug:e.debug||!1,developerOnly:void 0===e.developerOnly||e.developerOnly,developerRoles:e.developerRoles||["Developer"]},this._initLogSettings()}async getRecords(e,t,n={}){const{filters:o,sorters:r,page:i,rows:s,rawResponse:a=!1,timeout:l}=n;let c={};o&&(c={...c,...this.buildFilters(o)},this._log("Filters",c)),r&&(c={...c,...this.buildSorters(r)},this._log("Sorters",c)),i&&(c.page=i),s&&(c.rows_per_page=s);const d=this._formatApiUrl(e,t)+this._formatParams(c);this._log("Getting records",d);const{controller:u,signal:m,clear:f}=this._createAbortController(l);try{const e=await this._executeRequest(d,{method:"GET",headers:this._buildHeaders()},m);return a?e:e.records}finally{f()}}async getAllRecords(e,t,n={}){const{filters:o,sorters:r,rows:i=1e3,onProgress:s}=n,a=await this.getRecords(e,t,{filters:o,sorters:r,page:1,rows:i,rawResponse:!0}),{total_pages:l,total_records:c,records:d}=a;if(this._log("Fetching all records",{total_pages:l,total_records:c}),0===c)return[];const u=[...d];for(let n=2;n<=l;n++){const a=await this.getRecords(e,t,{filters:o,sorters:r,page:n,rows:i,rawResponse:!0});if(u.push(...a.records),s){s({page:n,total_pages:l,records_loaded:u.length,total_records:c,percentage:Math.round(n/l*100)})}}return u}async getRecordChildren(e,t,n,o,r={}){const{filters:i,sorters:s,page:a,rows:l,rawResponse:c=!1,timeout:d}=r;let u={};i&&(u={...u,...this.buildFilters(i)}),s&&(u={...u,...this.buildSorters(s)}),a&&(u.page=a),l&&(u.rows_per_page=l);const m=this._formatApiUrl(e,t);u[`${o}_id`]=n;const f=m+this._formatParams(u);this._log("Getting child records",f);const{controller:h,signal:p,clear:g}=this._createAbortController(d);try{const e=await this._executeRequest(f,{method:"GET",headers:this._buildHeaders()},p);return c?e:e.records}finally{g()}}async getAllRecordChildren(e,t,n,o,r={}){const{filters:i,sorters:s,rows:a=1e3,onProgress:l}=r,c=await this.getRecordChildren(e,t,n,o,{filters:i,sorters:s,page:1,rows:a,rawResponse:!0}),{total_pages:d,total_records:u,records:m}=c;if(this._log("Fetching all child records",{total_pages:d,total_records:u}),0===u)return[];const f=[...m];for(let r=2;r<=d;r++){const c=await this.getRecordChildren(e,t,n,o,{filters:i,sorters:s,page:r,rows:a,rawResponse:!0});if(f.push(...c.records),l){l({page:r,total_pages:d,records_loaded:f.length,total_records:u,percentage:Math.round(r/d*100)})}}return f}async createRecord(e,t,n,o,r){const i=this._formatApiUrl(e,t);this._log("Creating record",{url:i,data:n});const{controller:s,signal:a,clear:l}=this._createAbortController(r);try{const e=await this._executeRequest(i,{method:"POST",headers:this._buildHeaders(),body:JSON.stringify(n)},a);return o&&await this.refreshView(o),e}finally{l()}}async updateRecord(e,t,n,o,r,i){const s=this._formatApiUrl(e,t,n);this._log("Updating record",{url:s,data:o});const{controller:a,signal:l,clear:c}=this._createAbortController(i);try{const e=await this._executeRequest(s,{method:"PUT",headers:this._buildHeaders(),body:JSON.stringify(o)},l);return r&&await this.refreshView(r),e}finally{c()}}async updateRecordsWithDelay(e,t,n,o,r,i=300,s){const a=[];for(let r=0;r<n.length;r++)try{const l=await this.updateRecord(e,t,n[r],o,[],s);a.push(l),r<n.length-1&&await new Promise(e=>setTimeout(e,i))}catch(e){a.push({error:e,recordId:n[r]})}return r&&await this.refreshView(r),a}async deleteRecord(e,t,n,o,r){const i=this._formatApiUrl(e,t,n);this._log("Deleting record",i);const{controller:s,signal:a,clear:l}=this._createAbortController(r);try{const e=await this._executeRequest(i,{method:"DELETE",headers:this._buildHeaders()},a);return o&&await this.refreshView(o),e}finally{l()}}async refreshView(e){if(Array.isArray(e)){const t=e.map(e=>this._refreshSingleView(e));return Promise.all(t)}return this._refreshSingleView(e)}async getRecord(e,t,n){if(!e||!t||!n)throw new Error("sceneId, viewId, and recordId are required to fetch a record.");const o=this._formatApiUrl(e,t,n);this._log("Fetching record by ID",o);try{return await this._executeRequest(o,{method:"GET",headers:this._buildHeaders()})}catch(e){throw console.error("Error fetching record by ID:",e),e}}forceLog(e,t){this._log(e,t,!0)}isDeveloper(){return this._canShowLogs}setDebug(e){this.options.debug=e,this._log("Debug mode set to",e)}_log(e,t,n=!1){this.options.debug&&(this._canShowLogs||n)&&console.log(`[KnackAPI] ${e}`,t||"")}_toggleSpinner(e){this.options.showSpinner&&(e?Knack.showSpinner():Knack.hideSpinner())}_checkKnack(){if("undefined"==typeof Knack)throw new Error("Knack is not available")}_createAbortController(e){const t=new AbortController,n=e||this.options.timeout,o=setTimeout(()=>{t.abort()},n);return{controller:t,signal:t.signal,clear:()=>clearTimeout(o)}}_getAuthToken(){return Knack.getUserToken()}_formatApiUrl(e,t,n=null){let o=`${Knack.api_dev}/pages/${e}/views/${t}`;return o+=n?`/records/${n}`:"/records",o}async _handleResponse(e){if(!e.ok){const t=await e.json().catch(()=>({message:"Unknown error"}));throw new Error(`API error ${e.status}: ${t.message||e.statusText}`)}return await e.json()}async _executeRequest(e,t,n){this._checkKnack(),this._toggleSpinner(!0);try{const o=await fetch(e,{...t,signal:n}),r=await this._handleResponse(o);return this._log("API response",r),r}catch(e){if("AbortError"===e.name)throw new Error("Request timeout");throw e}finally{this._toggleSpinner(!1)}}_buildHeaders(e=!0){const t={"Content-Type":"application/json","X-Knack-Application-ID":Knack.application_id,"X-Knack-REST-API-Key":"knack"};if(e){const e=this._getAuthToken();e&&(t.Authorization=e)}return t}_initLogSettings(){if(this._canShowLogs=!1,this.options.developerOnly)try{const e=Knack.getUserRoleNames();this._canShowLogs=this.options.developerRoles.some(t=>e.includes(t))}catch(e){this._canShowLogs=!1,console.warn("KnackAPI: Could not determine user role, defaulting to no logs")}else this._canShowLogs=!0}buildFilters(e){if(!e)return{};if(e.match&&e.rules)return{filters:JSON.stringify(e)};Array.isArray(e)||(e=[e]);const t={};return e.forEach((e,n)=>{const o=`filters[${n}]`;e.field&&(t[`${o}[field]`]=e.field),e.operator&&(t[`${o}[operator]`]=e.operator),void 0!==e.value&&(Array.isArray(e.value)?e.value.forEach((e,n)=>{t[`${o}[value][${n}]`]=e}):t[`${o}[value]`]=e.value),e.type&&(t[`${o}[type]`]=e.type)}),t}buildSorters(e){if(!e)return{};Array.isArray(e)||(e=[e]);const t={};return e.forEach((e,n)=>{const o=`sort[${n}]`;e.field&&(t[`${o}[field]`]=e.field),e.direction?t[`${o}[direction]`]=e.direction:t[`${o}[direction]`]="asc"}),t}_formatParams(e){if(!e||0===Object.keys(e).length)return"";const t=new URLSearchParams;return Object.entries(e).forEach(([e,n])=>{t.append(e,n)}),`?${t.toString()}`}_refreshSingleView(e){return new Promise((t,n)=>{try{const o=Knack.views[e];if(!o||!o.model||!o.model.view)return this._log("View not found or invalid",e),n(new Error("View not found or invalid"));const r=o.model.view.type;if("form"===r)return"function"==typeof o.reloadForm?(o.reloadForm(),o.render(),this._log("Form view reloaded successfully",e),t()):(this._log("reloadForm not available on form view",e),n(new Error("reloadForm not available")));if("calendar"===r)return"function"==typeof o.renderRecords?(o.renderRecords(),Knack.hideSpinner?.(),this._log("Calendar view refreshed via renderRecords",e),t()):(this._log("renderRecords not available on calendar view",e),n(new Error("renderRecords not available")));if("search"===r)return"function"==typeof o.renderResults?(o.renderResults(),this._log("Search view refreshed via renderResults",e),t()):(this._log("renderResults not available on search view",e),n(new Error("renderResults not available")));if("menu"===r)return"function"==typeof o.postRender?(o.postRender(),this._log("Menu view refreshed via postRender",e),t()):(this._log("postRender not available on menu view",e),n(new Error("postRender not available")));o.model.fetch({success:()=>{"details"===r&&(o.render(),o.postRender?.(),this._log("Details view refreshed after fetch",e)),"table"===r&&(o.renderResults?.(),this._log("Table view refreshed via renderResults",e)),t()},error:(t,o)=>{this._log("Error fetching view model",{viewId:e,error:o}),n(o)}})}catch(t){this._log("Error in _refreshSingleView()",{viewId:e,error:t}),n(t)}})}formatConnectedFields(e,t){return Array.isArray(e)||(e=[e]),e.map(e=>{const n={...e};return t.forEach(t=>{e[`${t}_raw`]&&(n[t]=Array.isArray(e[`${t}_raw`])?e[`${t}_raw`].map(e=>({...e})):{...e[`${t}_raw`]})}),n})}}async function caAPI(e=null,t=null,n=null,o={},r="",i={},s=[],a=!1){return new Promise(function(l,c){if(r=r.toUpperCase(),null===t||"PUT"!==r&&"GET"!==r&&"POST"!==r&&"DELETE"!==r)return void c(new Error("Called caAPI with invalid parameters: view = "+t+", recId = "+n+", reqType = "+r));const d=setTimeout(function(){if(m)return clearInterval(m),void c(new Error("Called caAPI with invalid scene key"))},5e3);let u=e.startsWith("scene_")?e:Knack.scenes.getBySlug(e).attributes.key,m=setInterval(function(){if(u){clearInterval(m),m=null,clearTimeout(d);let f=`https://api.knack.com/v1/pages/${u}/views/${t}/records/`;n&&!e.startsWith("scene_")?f=`${f}?${e}_id=${n}`:n&&e.startsWith("scene_")?f=`${f}${n}`:$.isEmptyObject(i)||(f=`${f}?filters=${encodeURIComponent(JSON.stringify(i))}`),a&&Knack.showSpinner(),ktl.account.isDeveloper()&&(console.log("apiURL =",f),console.log(`caAPI - sceneKey: ${e}, caAPI - viewId: ${t}, recId: ${n}, requestType: ${r}, apiData: ${JSON.stringify(o)}, apiFilter: apiFilter: ${JSON.stringify(i)}`)),$.ajax({url:f,type:r,crossDomain:!0,retryLimit:4,headers:{Authorization:Knack.getUserToken(),"X-Knack-Application-Id":Knack.application_id,"X-Knack-REST-API-Key":"knack","Content-Type":"application/json","Access-Control-Allow-Origin":"*.knack.com"},data:JSON.stringify(o),success:function(e,t,n){Knack.hideSpinner(),ktl.account.isDeveloper()&&(ktl.log.clog("green","caAPI data : "),console.log(e)),0===s.length?l(e):ktl.views.refreshViewArray(s).then(function(){l(e)})},error:function(e){if(ktl.log.clog("purple","caAPI error:"),console.log("retries:",this.retryLimit,"\nresponse:",e),this.retryLimit-- >0){const e=this;return void setTimeout(function(){$.ajax(e)},500)}console.log("retry limit reached"),Knack.hideSpinner(),e.caller="caAPI",e.viewId=t,c(e)}})}else u=e.startsWith("scene_")?e:Knack.scenes.getBySlug(e).attributes.key},100)})}function getNestedValue(e,t){return t.split(".").reduce((e,t)=>e?.[t],e)}function removeHtml(e){const t=document.createElement("div");return t.innerHTML=e,t.textContent}function findElementByText(e,t=document,n={}){const{tag:o,class:r}=n,i=o?t.querySelectorAll(o):t.querySelectorAll("*");for(let t of i){if((!r||r.split(/\s+/).every(e=>t.classList.contains(e)))&&t.textContent.trim()===e)return t}return console.warn(`[findElementByText] No element found with text "${e}"`+(o?`, tag "${o}"`:"")+(r?`, class "${r}"`:"")),null}function getSelectedRadioValue(e){const t=`kn-input-field_${e}`,n=document.getElementById(t),o=n?.querySelector('input[type="radio"]:checked');return o?.value?.trim()||""}function replaceTextRegex(e,t,n,o=!1){$("number"==typeof e?`td.field_${e}`:e).each(function(){const e=$(this).text(),r=o?e.replaceAll(t,n):e.replace(t,n);$(this).text(r)})}function showHideMsgBasedOnSelect(e,t,n,o,r=!1){const i=Array.isArray(t)?t:[t],s=Array.isArray(n)?n:[n];const a=()=>{toggleMessage(i.some(t=>s.includes(function(t){if(r){const n=document.querySelector(`#${e}_field_${t}_chzn li.result-selected`);return n?n.textContent.trim():""}{const n=document.getElementById(`${e}-field_${t}`);return n?n.value:""}}(t))),o)};i.forEach(t=>{const n=document.getElementById(`${e}-field_${t}`);n?addInputEventListener(n,a,{runOnInit:!0}):console.error(`Select element not found: ${e}-field_${t}`)})}function showHideMsgBasedOnRadios(e,t,n,o,r,i="any"){let s,a,l;if(s="object"==typeof e&&null!==e&&(e.hasOwnProperty("fieldIds")||e.hasOwnProperty("selector")||e.hasOwnProperty("mode"))?Object.assign({fieldIds:null,valuesToMatch:null,selector:null,callback:null,params:null,mode:"any"},e):{fieldIds:e,valuesToMatch:t,selector:n,callback:o,params:r,mode:i},s.fieldIDs||s.fieldID)return void console.error('[showHideMsgBasedOnRadios] Deprecated parameter "fieldIDs"/"fieldID" used; please pass "fieldIds" only.');let c="map"===s.mode||"object"==typeof s.fieldIds&&!Array.isArray(s.fieldIds);if(!s.fieldIds)return void console.error('[showHideMsgBasedOnRadios] Missing required parameter "fieldIds". Example: showHideMsgBasedOnRadios([123], "Yes", "#msg")');if(!s.selector)return void console.error('[showHideMsgBasedOnRadios] Missing required parameter "selector". Example: showHideMsgBasedOnRadios([123], "Yes", "#msg")');if(!document.querySelector(s.selector))return void console.error(`Message element not found: ${s.selector}`);const d=()=>{let e=!1;if(c)e=Object.entries(s.fieldIds).every(([e,t])=>{const n=document.querySelector(`#kn-input-field_${e} input[type="radio"]:checked`);return n&&n.value===t});else{a=Array.isArray(s.fieldIds)?s.fieldIds:[s.fieldIds],l=Array.isArray(s.valuesToMatch)?s.valuesToMatch:[s.valuesToMatch];const t=a.map(e=>{const t=document.querySelector(`#kn-input-field_${e} ${INPUT_RADIO_CHECKED_SELECTOR}`);return t&&l.includes(t.value)});e="all"===s.mode?t.every(Boolean):t.some(Boolean)}toggleMessage(e,s.selector),s.callback&&"function"==typeof s.callback&&s.callback(e,s.params)};c?Object.keys(s.fieldIds).forEach(e=>{document.querySelectorAll(`#kn-input-field_${e} input[type="radio"]`).forEach(e=>{addInputEventListener(e,d,{runOnInit:!0})})}):(a=Array.isArray(s.fieldIds)?s.fieldIds:[s.fieldIds],a.forEach(e=>{document.querySelectorAll(`#kn-input-field_${e} input[type="radio"]`).forEach(e=>{addInputEventListener(e,d,{runOnInit:!0})})}))}function showHideEleBasedOnRadios(e,t,n,o=!1){const r=`#kn-input-field_${e}`;0!==$(r).length?0!==$(n).length?$(r).change(function(){const e=$(`${r} :checked`).val(),i=o?-1!==$.inArray(e,t):e==t;$(n).toggle(i)}).change():console.error(`Target selector "${n}" not found on the page.`):console.error(`Field with ID ${e} not found on the page.`)}function showHideEleBasedOnString(e,t){Object.entries(t).forEach(([t,n])=>{const o=e.includes(t);$(n).toggle(o)})}function showNotification(e){const t={target:null,message:"",backgroundColor:"",className:"",delay:2e3,fadeTime:500,styles:{},onShow:null,onHide:null,...e},n="string"==typeof t.target?document.querySelector(t.target):t.target;if(!n)return console.error("Target element not found:",t.target),null;const o=getComputedStyle(n).zIndex;"auto"!==o&&"0"!==o||(n.style.position=n.style.position||"relative",n.style.zIndex="1");const r=document.createElement("div");let i=[];Array.isArray(t.className)?i=t.className.flatMap(e=>e.split(" ")):"string"==typeof t.className&&t.className.trim()&&(i=t.className.trim().split(/\s+/)),r.classList.add("custom-notification",...i);const s=["color","fontWeight","fontSize","lineHeight","textAlign"];(Array.isArray(t.message)?t.message:[t.message]).forEach(e=>{const n=document.createElement("p");n.innerHTML=e,s.forEach(e=>{t.styles?.[e]&&(n.style[e]=t.styles[e])}),r.appendChild(n)});const a={backgroundColor:t.backgroundColor,opacity:"1",transition:`opacity ${t.fadeTime}ms ease`};return Object.assign(r.style,a),Object.assign(r.style,t.styles),n.appendChild(r),"function"==typeof t.onShow&&t.onShow(r),t.delay>0&&setTimeout(()=>{r.style.opacity="0",setTimeout(()=>{r.parentNode&&(r.parentNode.removeChild(r),"auto"!==o&&"0"!==o||(n.style.zIndex=o),"function"==typeof t.onHide&&t.onHide())},t.fadeTime)},t.delay),r}function removeOpsFromSelect(e,t){return!!$.isArray(t)&&($(t).each(function(t,n){$(`${e} option`).filter(`[value="${n}"]`).remove()}),!0)}function removeFrmRadioCheckBox(e,t){return!!$.isArray(t)&&($(t).each(function(t,n){removeElement(`#kn-input-field_${e} .control:contains("${n}")`)}),!0)}function changeRadioButtonLabel(e,t,n){const o=$(`#kn-input-field_${e}`).find("label.option.radio").filter(function(){return $(this).text().trim()===t}),r=o.find("input").detach();o.text(` ${n}`),o.prepend(r)}function setupFieldStatus(e,t=!1){const n=document.querySelectorAll(`.field_${e}`);n.length&&n.forEach(e=>{const n=e.textContent.trim();t&&n.includes("Not")?e.style.backgroundColor="var(--warning)":n.includes("Not")||t||(e.style.backgroundColor="var(--success)")})}function removeNull(e){removeElement(`span.${e}:contains("null")`)}function selectFromSelect(e,t){$(`${e} option[value="${t}"]`).length>0?$(`${e} option[value="${t}"]`).prop("selected",!0):console.error(`Option "${t}" does not exist in the dropdown with ID "${e}".`)}function selectFromConx(e,t,n){$("#"+e+`-field_${t} option`).each(function(){if($(this).text()==n)return selectFromSelect("#"+e+`-field_${t}`,$(this).val()),!1})}function addPlaceholderToInput(e,t){const n=document.getElementById(`field_${e}`);n&&n.setAttribute("placeholder",t)}async function waitGetValueFromDetail({viewId:e,fieldIds:t,delay:n=2e4,returnHtml:o=!1}){const r=Array.isArray(t)?t:[t],i={};try{return(await Promise.all(r.map(async t=>{const o=e?`#${e} .field_${t} .kn-detail-body span`:`.field_${t} .kn-detail-body span`;try{return{fieldId:t,found:!0,element:await waitSelector({selector:o,delay:n})}}catch(o){return console.warn(`Field ${t} not found ${e?`in view ${e}`:"globally"} within ${n}ms.`),{fieldId:t,found:!1,element:null}}}))).forEach(({fieldId:e,found:t,element:n})=>{if(t&&n){const t=o?n.innerHTML?.trim()||null:n.textContent?.trim()||null;i[e]=t}else i[e]=null}),Array.isArray(t)?i:i[t]}catch(n){return console.error(`Error retrieving values for fields in view ${e}:`,n),r.forEach(e=>{void 0===i[e]&&(i[e]=null)}),Array.isArray(t)?i:null}}function getValueFromDetail(e,t=!1){const n=$(`.field_${e} .kn-detail-body`).first();return 0===n.length?(console.log(`Error: Element with field_${e} not found.`),null):t?n.html().trim():n.text().trim()}function insertValFromDetail(e,t){const n=getValueFromDetail(e);document.querySelectorAll(t).forEach(e=>{e.textContent=n})}function insertLoggedInUser(e,t){try{const n=Knack.getUserAttributes()?.name||"Unknown User";if("string"==typeof e){const t=document.querySelectorAll(e);if(0===t.length)return console.warn(`No elements found matching selector: ${e}`),n;t.forEach(e=>{e.textContent=n})}else if(e instanceof Element)e.textContent=n;else{if(!(e instanceof NodeList))return console.error("Invalid selector type provided to insertLoggedInUser"),n;e.forEach(e=>{e.textContent=n})}return"function"==typeof t&&t(n),n}catch(e){return console.error("Error inserting logged in user:",e),"User Unknown"}}function borderRadiusLastVisible(e,t){const n=document.getElementById(e);if(!n)return;const o=n.querySelector(".menu-links__list");if(!o)return;const r=Array.from(o.children).filter(e=>"none"!==window.getComputedStyle(e).display&&null!==e.offsetParent);if(0===r.length)return;r.forEach(e=>{const t=e.querySelector("a");t&&(t.style.borderRadius="")});const i=r[r.length-1].querySelector("a");i&&(i.style.borderRadius="0 .35em .35em 0"),t&&setTimeout(()=>borderRadiusLastVisible(e),t)}function changeToSlider(e,t,n,o={}){const r="string"==typeof t?`#${e} ${t}`:t,i="string"==typeof n?`#${e} ${n}`:n,s="string"==typeof r?document.querySelector(r):r,a="string"==typeof i?document.querySelector(i):i;if(!s||!a)return void console.error(`Slider or result field not found in view ${e}`);const l=s.id,c=a.id,d=o.minLabel||"",u=o.maxLabel||"",m=o.class||"",f={...o};delete f.minLabel,delete f.maxLabel,delete f.class,s.classList.remove("input"),s.type="range",s.classList.add("slider"),m&&m.split(/\s+/).filter(Boolean).forEach(e=>{document.getElementById(`kn-input-${l}`).classList.add(e),document.getElementById(`kn-input-${c}`).classList.add(`${e}-result`)});for(const[e,t]of Object.entries(f))s.setAttribute(e,t);if(s.addEventListener("input",()=>{a.value=s.value}),a.addEventListener("keyup",()=>{const e=parseFloat(a.value),t=parseFloat(s.min||0),n=parseFloat(s.max||100);!isNaN(e)&&e>=t&&e<=n&&(s.value=e)}),a.value=s.value,!l)return;const h=document.querySelector(`#${e} #kn-input-${l} div.control`);if(h){if(d){const e=document.createElement("label");e.className="slideLabel",e.textContent=d,e.style.left="1px",h.appendChild(e)}if(u){const e=document.createElement("label");e.className="slideLabel",e.textContent=u,e.style.right="2px",h.appendChild(e)}}}function openFileFromBtn(e,t,n,o=!1){const r=document.getElementById(e);if(!r)return void console.error(`View element with ID ${e} not found`);const i=[];i.push(...r.querySelectorAll("a")),i.push(...r.querySelectorAll("button"));const s=Array.from(i).filter(e=>e.textContent.trim().includes(t));0!==s.length?s.forEach(e=>{e.addEventListener("click",function(e){if(e.preventDefault(),o){const e=n.split("."),t=fileViewer(e[e.length-1],`https://api.knack.com/v1/applications/${Knack.application_id}/download/asset/${n}`);window.open(t,"_blank")}else window.location.href=sanitiseURL(window.location.href)+KN_ASSET_PREFIX+n})}):console.error(`Button with text "${t}" not found in view ${e}`)}function handleRedirect(e,t){"knack-form-submit"===e.type?setTimeout(()=>{window.location.href=t},300):"knack-scene-render"!==e.type&&"knack-view-render"!==e.type||document.querySelectorAll("button.close-modal").forEach(e=>{e.addEventListener("click",function(){setTimeout(()=>{window.location.href=t},300)},{once:!0})})}function getNewURL(e,t=3){const n=sanitiseURL(e).split("/");for(let e=1;e<=t;e++)n.pop();return n.join("/")}function getBackgroundSceneId(){const e=document.querySelectorAll("#knack-body .kn-scenes .kn-scene");for(const t of e)if(!t.closest(".kn-modal"))return t.id||null;return null}function isSceneToIgnore(e){const t=getBackgroundSceneId();if(!t||!e.length)return!1;const n=Number(t.replace("kn-scene_",""));return e.map(e=>Number(e)).filter(e=>!Number.isNaN(e)).includes(n)}function isUserRole(e){var t=!1;return $(e).each(function(e,n){if(Knack.getUserRoles(n))return t=!0,!1}),t}function isUserName(e){const t=Knack.getUserAttributes()?.name;return t===e}function replaceLargeNo(e,t,n,o){let r=[];r=o?Array.from(document.querySelectorAll("span.knViewLink__label")).filter(t=>t.textContent.includes(e)):Array.from(document.querySelectorAll(`td.field_${e}`)),r.forEach(e=>{const o=parseInt(e.textContent.replace(/,/g,""),10);!isNaN(o)&&o>t&&(e.textContent=n)})}function getRecordID(e=null){const t=sanitiseURL(window.location.href).split("/");return e?t[t.length-e]:t[t.length-2]}function showPopUpNotification(e,t,n,o,r){Knack.showSpinner(),$(`<div class="${o}">${t}</div>`).css({"background-color":n}).insertAfter(e).delay(r).fadeOut(function(){removeElement(this)})}function sanitiseURL(e){return e.toString().split("?")[0]}async function initSecureStorage(e){return e&&"string"==typeof e?ktl.storage.initSecureLs().then(()=>{try{const t=ktl.storage.lsGetItem(e,!1,!1,!0);if(!t){console.log(`Storage '${e}' doesn't exist yet, initializing empty storage.`);const t="{}";return ktl.storage.lsSetItem(e,t,!1,!1,!0),{}}try{return JSON.parse(t)}catch(t){return console.warn(`Error parsing content of '${e}', returning empty object:`,t),ktl.storage.lsSetItem(e,"{}",!1,!1,!0),{}}}catch(t){throw console.error(`Error accessing storage '${e}':`,t),new Error(`Failed to get item from secure storage: ${t.message}`)}}).catch(e=>{throw console.error("Failed to initialize secure storage:",e),new Error(`Secure storage initialization failed: ${e.message}`)}):Promise.reject(new Error("Invalid storage key provided. Must be a non-empty string."))}function setSecureStorage(e,t,n,o,r=5){initSecureStorage(e).then(i=>{const s=new Date;s.setDate(s.getDate()+r),i[t]=i[t]||{},i[t].expirationDate=s.getTime(),i[t][n]=o,ktl.storage.lsSetItem(e,JSON.stringify(i),!1,!1,!0)})}function getSecureStorage(e,t){return initSecureStorage(e).then(n=>{const o=(new Date).getTime();for(let e in n)o>n[e].expirationDate&&delete n[e];return ktl.storage.lsSetItem(e,JSON.stringify(n),!1,!1,!0),n[t]?n[t]:""})}function checkAllRadioAnswered(e,t=[]){const n=new Set;$(`#${e} :radio:visible`).each(function(){const e=parseInt($(this).closest('[id^="kn-input-field_"]').attr("id").split("_")[1]);t.includes(e)||n.add($(this).attr("name"))});return $(`#${e} :radio:visible:checked`).filter(function(){const e=parseInt($(this).closest('[id^="kn-input-field_"]').attr("id").split("_")[1]);return!t.includes(e)}).length===n.size}function changeCellTextBasedOnCellContent(e,t,n,o,r,i,s="success"){t.forEach(t=>{if(t[n].includes(r)){$(`tr[id=${t.id}]`).find(`td:eq(${$(`#${e} th.${o}`).index()})`).css({"background-color":`var(--${s})`,"font-weight":"700",color:"black"}).find(".knViewLink__label").text(i)}})}function toggleShowHideViewContent(e,t,n,o,r=!1){e.off("click.showHide").on("click.showHide",function(){t.slideToggle(o),n.toggleClass("down up"),e.toggleClass("active"),r&&t.css("display","flex")})}function shrinkContent(e,t,n,o,r){e.off("click.shrinkLink").on("click.shrinkLink",function(){t.slideUp(o),removeClassFromSelector(n,"up").addClass("down"),removeClassFromSelector(r,"active")})}function showHideViewContent(e,t,n=!1){const o=$(`#show-hide_${e}`),r=$(`#arrow_${e}`),i=$(`#shrink-link_${e}`),s=$(`.${e}`);toggleShowHideViewContent(o,s,r,t,n),shrinkContent(i,s,r,t,o)}function appendShrinkLink(e,t,n=!1){const o=`<a class="show-hide-btn shrink-link" id="shrink-link_${t}">Shrink &nbsp;<span class="arrow up" id="arrow_${t}">â—€</span></a>`;0===$(`#shrink-link_${t}`).length&&(n?$(`#${e}`).append(o):$(`#${e}`).find(".show-hide-section").append(o))}function replaceTitleWithButton(e,t){const n=$(`#${e} h2.kn-title`),o=`<div class="show-hide-btn" id="show-hide_${t}">${n.text()} &nbsp;<span class="arrow down" id="arrow_${t}">â—€</span></div>`;0===$(`#show-hide_${t}`).length&&n.html(o)}function wrapContentForShowHide(e,t,n){const o={table:".kn-table-wrapper, .kn-records-nav",form:"form, .kn-form-confirmation",list:".kn-list-content, .kn-records-nav"}[t],r=$(`#${e}`),i=r.find("section");if(o){const e=r.find(o);e.parent().is("section")||e.wrapAll(`<section class='${n} show-hide-section box-with-border' />`)}else i.hasClass(`${n} show-hide-section box-with-border`)||i.addClass(`${n} show-hide-section box-with-border`)}function toggleElements(e,t){Array.isArray(e)?e.forEach((e,n)=>{const o=Array.isArray(t)?t[n]:t;$(e).toggle(o)}):$(e).toggle(t)}function getFormId(e){return $(`#${e} .kn-submit input[name="id"]`).val()}function splitAndTrimField(e){return e?e.split(",").map(e=>e.trim()):[]}function syncTextInputs(e,t){if("1"===e.dataset.notesSyncBound&&"1"===t.dataset.notesSyncBound)return;e.dataset.notesSyncBound="1",t.dataset.notesSyncBound="1";let n=!1;function o(e,t){if(n)return;const o=e.value;t.value!==o&&(n=!0,t.value=o,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),n=!1)}function r(){o(e,t)}function i(){o(t,e)}e.addEventListener("input",r),e.addEventListener("change",r),t.addEventListener("input",i),t.addEventListener("change",i);const s=(e.value||"").trim(),a=(t.value||"").trim();s&&s!==a?o(e,t):a&&a!==s&&o(t,e)}function createButton(e){"string"==typeof arguments[0]&&(e={id:arguments[0],html:arguments[1],className:arguments[2]}),e=Object.assign({id:"",html:"",className:"",type:"button",attributes:{},onClick:null},e);const t=document.createElement("button");e.id&&(t.id=e.id),t.className="kn-button"+(e.className?" "+e.className:""),t.type=e.type,t.innerHTML=e.html;for(const[n,o]of Object.entries(e.attributes))t.setAttribute(n,o);return"function"==typeof e.onClick&&t.addEventListener("click",e.onClick),t}function addModalNavigationButtons(){const e=document.createElement("div");e.className="modal-control-buttons";const t=createButton({id:"scrollToTopBtn",html:'<i class="fa fa-arrow-up"></i>',className:"modalButton success-bkgd scroll-to-top-btn",onClick:function(){document.querySelector(".modal-card-head").scrollIntoView({behavior:"auto",block:"start"})}}),n=createButton({id:"closeModalBtn",html:'<i class="fa fa-times"></i>',className:"modalButton warning-bkgd close-modal-btn",onClick:function(){const e=document.querySelector("button.close-modal");if(e)e.click();else{const e=document.getElementById("kn-modal-bg-0");e&&(e.style.display="none")}}});e.appendChild(t),e.appendChild(n);const o=document.getElementById("kn-modal-bg-0");o&&(o.appendChild(e),e.style.display="none",o.addEventListener("scroll",function(){const t=document.querySelector(".modal-card-body");if(!t)return;const n=t.getBoundingClientRect();e.style.left=`${n.right}px`,o.scrollTop>100?(e.style.display="flex",e.style.opacity="1",e.style.transition="opacity 0.3s"):(e.style.opacity="0",e.style.transition="opacity 0.3s",setTimeout(function(){o.scrollTop<=100&&(e.style.display="none")},300))}))}function capitaliseInput(e,t,n={mode:"title",trim:!0,smartWords:!0}){let o=document.getElementById(e);if(o||(o=document.querySelector(`#connection-form-view:has(input[value="${e}"])`)),!o)return;const r=o.querySelector(t);if(!r)return;const i=["and","or","the","of","in","on","at","to","for","by","with","a","an","but","nor","as"];addInputEventListener(r,function(e,t){let o=t.value;if(!o)return;const{mode:r="title",trim:s=!0,smartWords:a=!0}=n||{};let l=e&&"blur"===e.type;s&&l&&(o=o.trim());let c=o;if("all"===r?c=o.toUpperCase():"sentence"===r?c=o.charAt(0).toUpperCase()+o.slice(1):"title"===r&&(e&&"insertText"===e.inputType&&" "===e.data||(c=o.replace(/\b[\w'-]+\b/g,function(e,t,n){let o=e.replace(/(^|[-'])\w/g,function(e){return e.toUpperCase()}).replace(/(?<!^|[-'])\w/g,function(e){return e.toLowerCase()});return a&&i.includes(o.toLowerCase())&&0!==t&&t+e.length!==n.length?o.toLowerCase():o}))),t.value!==c){const e=t.selectionStart;t.value=c,"number"==typeof e&&t===document.activeElement&&t.setSelectionRange(e,e)}},{events:["input","blur"]})}function capitaliseString(e,t={allCaps:!0}){if("string"!=typeof e||!e.trim())return"";const{allCaps:n=!0}=t;return n?e.trim().toUpperCase():e.trim().replace(/\b\w/g,e=>e.toUpperCase())}async function waitGetConxIdFromDetailId({viewId:e,fieldId:t,delay:n=5e3}){try{const o=`#${e} .field_${t} .kn-detail-body > span > span > span`,r=await waitSelector({selector:o,delay:n,returnType:"elements"});return r&&0!==r.length?new Promise(e=>{setTimeout(()=>{const t=Array.from(r).map(e=>e.id).filter(Boolean);0===t.length?(console.log("No connection IDs found in elements"),e(null)):e(1===t.length?t[0]:t)},100)}):(console.log(`No connection elements found with selector: ${o}`),null)}catch(e){return console.error(`Error getting connection ID from detail view: ${e}`),null}}function createDropdownHTML(e,t=!0,n="Select"){const o=document.createElement("div");o.className="kn-input kn-input-multiple_choice control";const r=document.createElement("label");r.setAttribute("for",e),r.className="label kn-label";const i=document.createElement("span");i.textContent=`${n} `;const s=document.createElement("span");if(s.className="selectText",r.appendChild(i),r.appendChild(s),t){const e=document.createElement("span");e.className="kn-required",e.textContent="*",r.appendChild(e)}const a=document.createElement("div");a.className="kn-select";const l=document.createElement("div");l.className="kn-select";const c=document.createElement("select");return c.setAttribute("data-placeholder","Select"),c.setAttribute("name",e),c.setAttribute("id",e),c.className="select",c.style.verticalAlign="bottom",l.appendChild(c),a.appendChild(l),o.appendChild(r),o.appendChild(a),o}const OFFICE_EXTENSIONS=["docx","odt","rtf","docm","doc","dotx","dotm","dot","xlsx","xls","ppts","ppt","pptx"],IMAGE_EXTENSIONS=["png","jpeg","jpg","gif","bmp","svg","webp","tiff","ico"];function updateLinksAndAssets(e){const t=sanitiseURL(window.location.href),n=document.getElementById(e);function o(e,t=!1){let n,o;if(t)n=e.getAttribute("data-asset-id"),o=e.getAttribute("data-file-name");else{const t=e.id;if(!assetURLs[t])return{};const r=assetURLs[t].split("/");n=r[0],o=r[r.length-1]}if(!o||!n)return{};const r=o.match(/\.([^.]+)$/);return{assetId:n,fileName:o,extension:r?r[1].toLowerCase():"",assetUrl:`https://api.knack.com/v1/applications/${Knack.application_id}/download/asset/${n}/${encodeURIComponent(o)}`}}function r(e,t,n=!1){t.extension&&(IMAGE_EXTENSIONS.includes(t.extension)?e.setAttribute("href",`${sanitiseURL(window.location.href)}kn-asset/1542-3553-3690-${t.assetId}/${t.fileName}`):OFFICE_EXTENSIONS.includes(t.extension)?(e.setAttribute("href",`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(t.assetUrl)}`),e.setAttribute("target","_blank")):"pdf"===t.extension?(e.setAttribute("href",`https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(t.assetUrl)}`),e.setAttribute("target","_blank")):(e.setAttribute("href",t.assetUrl),e.setAttribute("download",t.fileName)),n&&(e.textContent=t.fileName))}n?(n.querySelectorAll(".ca-link, .ca-link-child, .ca-link-user").forEach(e=>{const n=e.id;let i=t;if(!n)return void console.error(`%c Error: ${e.textContent} - Link must have ID to define URL `,"color: red; font-weight: bold;");const s=e.classList.contains("ca-asset"),a=s?assetURLs[n]:n;e.classList.contains("ca-link-child")?i+=`${a}/${getRecordID()}`:e.classList.contains("ca-link-user")?i+=`${a}/${Knack.getUserAttributes()?.id}`:i+=a,s?function(e,t=!1){const n=o(e,t);n.extension&&r(e,n,t)}(e,!1):("_blank"===e.getAttribute("target")&&e.classList.add("extLink"),e.setAttribute("href",i))}),n.querySelectorAll(".kn-view-asset").forEach(e=>{const t=o(e,!0);if(!t.extension)return;if(IMAGE_EXTENSIONS.includes(t.extension))return;const n=document.createElement("a");n.target="_blank",r(n,t,!0),e.replaceWith(n)})):console.error(`View element with ID ${e} not found`)}function insertStaffName(e){try{const t=".kn-detail-label",n=Knack.getUserAttributes()?.name||"";waitSelector({selector:t,textCondition:{text:"Staff Name",exact:!0},timeout:5e3}).then(t=>{const o=t.nextElementSibling.textContent.trim()||n;"string"==typeof e?document.querySelectorAll(e).forEach(e=>e.textContent=o):e instanceof Element?e.textContent=o:(e instanceof NodeList||Array.isArray(e))&&Array.from(e).forEach(e=>e.textContent=o)}).catch(t=>{console.error(`Error finding staff field: ${t}`),"string"==typeof e?document.querySelectorAll(e).forEach(e=>e.textContent=n):e instanceof Element?e.textContent=n:(e instanceof NodeList||Array.isArray(e))&&Array.from(e).forEach(e=>e.textContent=n)})}catch(t){errorHandler.handle(t,{function:"insertStaffName",target:e},"insertStaffName")}}function updateLabelText(e,t,n,{params:o}){const r=document.getElementById(e);if(!r)return void console.warn(`View ${e} not found for updateLabelText`);let i,s,a;const l={form:`#${r.id} #kn-input-${n} .kn-label span:not(.kn-required)`,details:`#${r.id} .${n} .kn-detail-label > span`,list:`#${r.id} .${n} .kn-detail-label > span`,table:`#${r.id} th.${n} > span > a > span:not(span.icon)`,search:`#${r.id} th.${n} > span > a > span:not(span.icon)`};2===o.length?([i,s]=o.map(e=>e),i=i.join(", "),a=l[t]&&s[0].includes(t[0])?l[t]:null):(i=o[0].join(", "),a=l[t]);const c=Object.entries({"{br}":"<br>","{strong}":"<strong>","{/strong}":"</strong>","{em}":"<em>","{/em}":"</em>","{hr}":"<hr>"}).reduce((e,[t,n])=>e.replaceAll(t,n),i||"");if(a){const e=document.querySelector(a);e?e.innerHTML=c||"":console.warn(`Label element not found for selector: ${a}`)}}function idleWatchDogTimeout(){if(document.querySelector(".kn-login"))return;document.getElementById("overlay")?.remove(),document.getElementById("ktl-idle-dialog")?.remove();const e=document.createElement("div");e.id="overlay",Object.assign(e.style,{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"black",opacity:.8,zIndex:1e3,display:"block"}),document.body.appendChild(e);const t=document.createElement("div");t.id="ktl-idle-dialog",t.setAttribute("role","dialog"),t.setAttribute("aria-modal","true"),t.setAttribute("aria-labelledby","ktl-idle-dialog-title"),t.setAttribute("tabindex","-1"),t.innerHTML='\n        <h2 id="ktl-idle-dialog-title">Knack Logout</h2>\n        <p>You are about to be logged out. Do you wish to remain logged in?</p>\n        <div class="ktl-dialog-buttons">\n            <button id="ktl-logout-btn" class="kn-button is-secondary">Logout</button>\n            <button id="ktl-stay-btn" class="kn-button is-secondary">Stay Logged In</button>\n        </div>\n    ',document.body.appendChild(t);const n=document.activeElement;function o(){e.remove(),t.remove(),clearTimeout(i),window.removeEventListener("resize",r),n&&"function"==typeof n.focus&&n.focus()}function r(){t.style.width=window.innerWidth<=768?"70%":"25%"}t.focus(),document.getElementById("ktl-logout-btn").onclick=function(){o(),Knack.user.destroy()},document.getElementById("ktl-stay-btn").onclick=function(){o(),ktl.scenes.resetIdleWatchdog()},r(),window.addEventListener("resize",r);const i=setTimeout(()=>{o(),Knack.user.destroy()},6e4)}function setViewMaxWidth({key:e}){const t=$(`#${e}`);ktl.core.getKeywordsByType(e,"_vmxw").forEach(({options:e,params:n})=>{if(!ktl.core.hasRoleAccess(e))return;const o=n[0][0];let r;const i=parseFloat(o);if(o.includes("%")||o.includes("px")||isNaN(i))r=o;else{if(isNaN(i))return void console.error(`Invalid width value: ${o}`);r=`${i}px`}t.css("max-width",r)})}function hideEmptyFields(e){$(`#${e.key} .kn-detail-body`).each(function(){""===$.trim($(this).text())&&removeElement(this)})}function hideElementsByValue(e,t){const n="_hebv",{key:o}=e;if(!o||!t[n])return;ktl.core.getKeywordsByType(o,n).forEach(e=>{const{options:t,params:n}=e;ktl.core.hasRoleAccess(t)&&0!==n.length&&n.forEach(e=>{if(e.length<3)return;const[t,n,...o]=e,r=$.trim($(`.${t} .kn-detail-body`).text());(n.startsWith("!")?r!==n.slice(1):r===n)&&($(o.join()).hide(),borderRadiusLastVisible())})})}function buttonToUrl({key:e},t){const n="_btnurl";if(!t[n])return;const o=ktl.views.getViewType(e);if(["list","form"].includes(o))return;const r=$(`#${e}`);ktl.core.getKeywordsByType(e,n).forEach(({options:t,params:n})=>{n.length?n.forEach(n=>{if(n.length<2)return void console.error("Button URL Params Error - Insufficient parameters found.");if(!ktl.core.hasRoleAccess(t))return void removeElement(r.find(d));const i=sanitiseURL(window.location.href),[s,a,l,c]=n,d="menu"===o?`li:textEquals("${s}")`:`a:textEquals("${s}")`,u=(e,t)=>{e.length?e.off("click").on("click",e=>((e,t)=>{e.preventDefault(),window.location.href=t})(e,t)):console.error(`buttonURL Error - Button with text "${s}" not found.`)};if(["table","search"].includes(o))getTableRows(e,(e,t)=>{const n=t.find("td.field_6087").text().trim(),o=t.find(d);u(o,`${i}${a}/${n}/`)});else{const e=r.find(d),t="false"!==l?`${i}${a}/${getRecordID(c||null)}/`:`${i}${a}/`;u(e,t)}}):console.error("Button URL Params Error - No parameter groups found.")})}function caQuickToggle({key:e},t=[]){new CAQuickToggle(e,t).init()}class CAQuickToggle{constructor(e,t){this.viewId=e,this.data=t,this.kw="_caqt",this.kwInstance=null,this.viewModel=null,this.viewType="",this.inlineEditing=!1,this.fieldMap=new Map,this.quickToggleParams={bgColorTrue:"#e2efda",bgColorFalse:"#ffb557",bgColorPending:"#ffe699",showNotification:!1,showSpinner:!1,pendingClass:"ktlProgress"},this.qtScanItv=null,this.quickToggleObj={},this.numToProcess=0,this.refreshTimer=null,this.viewsToRefresh=[],this.viewHasQt=!1,this.fieldsColor={}}init(){this.isValidInitialState()&&this.setupKeywordInstances()&&this.setupViewModel()&&(this.setupColors(),this.processFields(),this.updateTableColors(),this.setupCellClickHandlers())}isValidInitialState(){return this.viewId&&this.data.length>0&&!ktl.scenes.isiFrameWnd()}setupKeywordInstances(){if(this.kwInstance=ktlKeywords[this.viewId]&&ktlKeywords[this.viewId][this.kw],this.kwInstance&&this.kwInstance.length){this.kwInstance=this.kwInstance[0];const{options:e}=this.kwInstance;if(!ktl.core.hasRoleAccess(e))return!1}const e=ktl.core.checkIfViewHasKeyword(this.viewId,this.kw);return ktl.core.checkIfViewHasKeyword(this.viewId,"_qt")?(console.log(`View ${this.viewId} has both _caqt and _qt keywords. Using original quickToggle only.`),!1):!!e}setupViewModel(){if(this.viewModel=Knack.router.scene_view.model.views._byId[this.viewId],!this.viewModel)return!1;const e=this.viewModel.attributes;return this.viewType=e.type,!!["table","search"].includes(this.viewType)&&(this.inlineEditing="table"===this.viewType?e.options&&e.options.cell_editor:e.cell_editor,!0)}setupColors(){let e=this.quickToggleParams.bgColorTrue,t=this.quickToggleParams.bgColorFalse;if(this.kwInstance&&(this.viewHasQt=!0,this.kwInstance.params&&this.kwInstance.params.length)){const n=this.kwInstance.params[0];n.length>=1&&n[0]&&(e=n[0]),n.length>=2&&n[1]&&(t=n[1])}this.bgColorTrue=e,this.bgColorFalse=t}processFields(){const e=this.viewModel.attributes;let t={};("table"===this.viewType?e.columns:e.results.columns).forEach(e=>{if("field"===e.type&&e.field&&e.field.key){const n=Knack.objects.getField(e.field.key);if(n&&!e.connection&&"boolean"===n.attributes.type){let n=!1;const{key:o}=e.field;let r={bgColorTrue:this.bgColorTrue,bgColorFalse:this.bgColorFalse};ktl.fields.getFieldKeywords(o,t);const i=t[o]&&t[o][this.kw];if((this.viewHasQt||i)&&(n=!0,i&&i.length&&i[0].params&&i[0].params.length>0)){const e=i[0].params[0];e.length>=1&&""!==e[0]&&(r.bgColorTrue=e[0]),e.length>=2&&""!==e[1]&&(r.bgColorFalse=e[1])}n&&(this.fieldsColor[o]=r,this.inlineEditing&&!e.ignore_edit&&$(`#${this.viewId} td.${o}.cell-edit`).addClass("caQtCellClickable"))}this.fieldMap.set(e.field.key,e.header)}})}updateTableColors(){$.isEmptyObject(this.fieldsColor)||this.data.forEach(e=>{Object.keys(this.fieldsColor).forEach(t=>{const n=$(`#${this.viewId} tbody tr[id="${e.id}"] .${t}`),o=n.attr("style"),r=`background-color:${!0===e[t+"_raw"]?this.fieldsColor[t].bgColorTrue:this.fieldsColor[t].bgColorFalse}`;n.attr("style",`${o?o+"; ":""}${r}`)})})}setupCellClickHandlers(){$(`#${this.viewId} .caQtCellClickable`).bindFirst("click",e=>this.handleCellClick(e))}handleCellClick(e){if($(".bulkEditCb:checked").length)return;e.stopImmediatePropagation();const t=$(e.target).data("field-key")||$(e.target).parent().data("field-key"),n=$(e.target).closest(".kn-search.kn-view[id], .kn-table.kn-view[id]");if(n.length){const o=n.attr("id"),r=Date.now(),i=$(e.target).closest("tr").attr("id");let s=ktl.views.getDataFromRecId(o,i)[`${t}_raw`];s=!0!==s,this.viewsToRefresh.includes(o)||this.viewsToRefresh.push(o),this.quickToggleObj[r]={viewId:o,fieldId:t,value:s,recId:i,processed:!1};const a=$(e.target).closest("td");a.css("background-color",this.quickToggleParams.bgColorPending),this.quickToggleParams.pendingClass&&a.addClass(this.quickToggleParams.pendingClass),clearTimeout(this.refreshTimer);const l=this.findCorrespondingField(t,s);l&&(this.quickToggleObj[r].additionalData=l),this.numToProcess++,this.startQtScanning()}}findCorrespondingField(e,t){const n=this.fieldMap.get(e);let o="",r=!1;for(const[t,i]of this.fieldMap.entries())if(t!==e&&(i===n||i===`${n} - Name`||i.startsWith(`${n} `))){r=i===`${n} - Name`,o=t;break}if(o){const e=Knack.getUserAttributes(),n=r?e.name:e.id;return{[o]:!1===t?null:n}}return null}startQtScanning(){this.quickToggleParams.showNotification&&(ktl.core.infoPopup(),this.showProgress()),this.qtScanItv||(ktl.views.autoRefresh(!1),this.qtScanItv=setInterval(()=>{if(!$.isEmptyObject(this.quickToggleObj)){const e=Object.keys(this.quickToggleObj)[0],{processed:t}=this.quickToggleObj[e];t||(this.quickToggleObj[e].processed=!0,this.doQuickToggle(e))}},500))}doQuickToggle(e){const t=this.quickToggleObj[e];if($.isEmptyObject(t)||!t.viewId||!t.fieldId)return;const n={[t.fieldId]:t.value,...t.additionalData};ktl.core.knAPI(t.viewId,t.recId,n,"PUT",[],!1).then(()=>{this.quickToggleParams.showNotification&&this.showProgress(),this.numToProcess--,delete this.quickToggleObj[e],$.isEmptyObject(this.quickToggleObj)&&(clearInterval(this.qtScanItv),this.qtScanItv=null,this.quickToggleParams.showSpinner&&Knack.showSpinner(),this.refreshTimer=setTimeout(()=>{ktl.core.removeInfoPopup(),ktl.views.refreshViewArray(this.viewsToRefresh).then(()=>{Knack.hideSpinner(),ktl.views.autoRefresh()}).catch(()=>{})},500))}).catch(e=>{ktl.views.autoRefresh();const t=e?JSON.stringify(e):"Unknown error";console.error("Quick Toggle operation failed:",e),errorHandler.handleError(e,{function:"doQuickToggle"},"Quick Toggle Error"),alert(`Error code KEC_1025 while processing Quick Toggle operation, reason: ${t}`)})}showProgress(){ktl.core.setInfoPopupText("Toggling... "+this.numToProcess+" items remaining.")}}class KnackError{constructor(e={}){this.options={sceneId:e.sceneId||"",viewId:e.viewId||"",fieldMap:e.fieldMap||{},captureUserData:void 0===e.captureUserData||e.captureUserData,captureSystemInfo:void 0===e.captureSystemInfo||e.captureSystemInfo,consoleLog:void 0===e.consoleLog||e.consoleLog,groupSimilarErrors:void 0===e.groupSimilarErrors||e.groupSimilarErrors,maxErrorsPerMinute:e.maxErrorsPerMinute||10,ignoredErrors:e.ignoredErrors||[],captureKnackContext:void 0===e.captureKnackContext||e.captureKnackContext,separateContextFields:void 0===e.separateContextFields||e.separateContextFields},this.api=new KnackAPI({debug:!1,showSpinner:!1}),this.boundHandleError=this.handleError.bind(this),this._errorCount=0,this._lastResetTime=Date.now(),this._errorHashes=new Map,this._lastKnownContext={sceneId:null,viewId:null,eventType:null,timestamp:null},this.options.captureKnackContext&&this._setupContextTracking(),this._validateOptions(),this.performanceData={javaScriptErrors:0,networkErrors:0,apiErrors:0,totalErrors:0,slowestOperation:null,averageResponseTime:0}}async handleError(e,t={},n="Unknown"){if(this._shouldIgnoreError(e)||this._isRateLimited())return null;this.options.captureKnackContext&&Object.assign(t,this._captureContextData());const o=this._captureErrorData(e,t,n);if(this.options.groupSimilarErrors){const e=this._processErrorGroup(o);if(e)return e.record}if(this._updatePerformanceMetrics(o),this.options.consoleLog&&console.error("KnackError:",o),this.options.sceneId&&this.options.viewId)try{return await this._logToKnackTable(o)}catch(e){console.error("Error logging to Knack table:",e)}return null}wrapEventHandler(e,t){const n=this;return async function(o,r,i){try{const o={eventType:e.replace("knack-",""),viewId:r?r.key:null,sceneId:n._getCurrentSceneId(),recordId:i?i.id:null,timestamp:(new Date).toISOString()};return n._lastKnownContext=o,await t.apply(this,arguments)}catch(t){throw await n.handleError(t,{knackContext:n._lastKnownContext},`${e} Handler`),t}}}setupGlobalErrorHandling(e=!0){return window.addEventListener("error",e=>{this.handleError(e.error||e.message,{errorFile:e.filename,errorLine:e.lineno,errorColumn:e.colno},"Global Error Event")}),e&&window.addEventListener("unhandledrejection",e=>{const t=e.reason instanceof Error?e.reason:new Error(String(e.reason));this.handleError(t,{},"Unhandled Promise Rejection")}),this}wrapFunction(e,t,n={}){return this.executeFunction(e,{source:t,rethrowError:!0,additionalInfo:n})}tryCatch(e,t,n={}){const o=this;return async function(...r){try{return await e.apply(this,r)}catch(i){return o.handleError(i,{functionArgs:JSON.stringify(r,(e,t)=>"function"==typeof t?"function() { ... }":t instanceof Node?t.nodeName:t instanceof Window?"Window":t),knackContext:o.getCurrentContext(),...n},t||e.name||"Anonymous Function"),{success:!1,error:i,message:i.message}}}}monitorPerformance(e,t,n=1e3,o={}){const r=this;return async function(...i){const s=performance.now();try{const o=await e.apply(this,i),r=performance.now()-s;return r>n&&console.warn(`Performance warning: ${t||e.name||"Anonymous"} took ${r.toFixed(2)}ms`),o}catch(a){const l=performance.now()-s;throw r.handleError(a,{functionArgs:JSON.stringify(i,(e,t)=>"function"==typeof t?"[Function]":t),responseTime:l.toFixed(2),performanceContext:{threshold:n,executionTime:l.toFixed(2)},...o},t||e.name||"Performance Monitor"),a}}}monitorApiCall(e,t="Knack API Call",n={}){const o=this;return async function(...r){const i=performance.now();try{const n=await e.apply(this,r),o=performance.now()-i;return o>2e3&&console.warn(`KnackError: Slow API call to ${t}: ${o.toFixed(2)}ms`),n}catch(s){const a=performance.now()-i;let l={};if(r.length>=2&&(l={sceneKey:r[0]||null,viewId:r[1]||null,recordId:r.length>2?r[2]:null,requestData:r.length>3?r[3]:null},e.name)){const t=e.name.toLowerCase();t.includes("create")?l.requestType="POST":t.includes("update")?l.requestType="PUT":t.includes("delete")?l.requestType="DELETE":t.includes("get")&&(l.requestType="GET")}throw o.handleError(s,{apiParams:l,responseTime:a.toFixed(2),knackContext:o.getCurrentContext(),...n},t),s}}}getPerformanceMetrics(){return{...this.performanceData,errorRate:{total:this.performanceData.totalErrors,perMinute:this._errorCount/((Date.now()-this._lastResetTime)/6e4)}}}ignoreError(e){return this.options.ignoredErrors.push(e),this}wrapAllMethods(e,t,n={}){const o={};for(const r in e)"function"==typeof e[r]?o[r]=this.wrapFunction(e[r],t?`${t}.${r}`:r,n):o[r]=e[r];return o}safeExecute(e,t,n,o={}){return this.executeFunction(e,{returnDefaultOnError:!0,defaultValue:t,source:n,immediate:!0,additionalInfo:o})}executeFunction(e,t={}){const{returnDefaultOnError:n=!1,defaultValue:o=null,captureArgs:r=!0,captureContext:i=!0,rethrowError:s=!0,source:a=e.name||"Execute Function",immediate:l=!1,immediateArgs:c=[],additionalInfo:d={}}=t,u=this,m=async function(...t){try{return await e.apply(this,t)}catch(e){const l={...d};if(r&&(l.functionArgs=JSON.stringify(t,(e,t)=>"function"==typeof t?"function() { ... }":t instanceof Node?t.nodeName:t instanceof Window?"Window":t)),i&&(l.knackContext=u.getCurrentContext()),u.handleError(e,l,a),n)return o;if(s)throw e}};return l?m(...c):m}wrapKnackListener(e,t,n,o={}){const r=this,i="any"===e?`${t}.any`:`${t}.${e}`;return $(document).on(i,function(i,s,a){const l={...o,listenerViewId:e,listenerEventType:t};try{return n.apply(this,arguments)}catch(n){const o=`${t} Listener for ${e}`;return r.handleError(n,l,o),void console.error(`Error in ${o}: ${n.message}`)}}),this}getCurrentContext(){const e={...this._lastKnownContext,currentSceneId:this._getCurrentSceneId(),currentViewId:this._getCurrentViewId(),url:window.location.href};return e.sceneId||(e.sceneId=e.currentSceneId),e.viewId||(e.viewId=e.currentViewId),e}_setupContextTracking(){["view-render","scene-render","form-submit","record-update","cell-update","record-delete"].forEach(e=>{$(document).on(`knack-${e}.any`,(t,n,o)=>{this._lastKnownContext={viewId:n?.key||null,sceneId:this._getCurrentSceneId(),eventType:e,recordId:o?.id||null,timestamp:(new Date).toISOString()}})})}_getCurrentSceneId(){if("undefined"!=typeof Knack&&Knack.router&&Knack.router.current_scene_key)return Knack.router.current_scene_key;const e=document.querySelector(".kn-scene");if(e){const t=e.id;if(t&&t.startsWith("kn-scene_"))return t.replace("kn-","")}return this._extractSceneIdFromUrl()}_getCurrentViewId(){return this._getActiveViewId()||this._getFirstViewId()}_getActiveViewId(){const e=document.activeElement;if(e){let t=e;for(;t&&t!==document.body;){if(t.id&&t.id.startsWith("view_"))return t.id;t=t.parentElement}}return null}_getFirstViewId(){const e=document.querySelector('[id^="view_"]');return e?e.id:null}_extractSceneIdFromUrl(){const e=window.location.href.match(/\/scene_(\d+)/i);return e&&e[1]?`scene_${e[1]}`:null}_validateOptions(){this.options.sceneId&&this.options.viewId||console.error("KnackError: Missing required options sceneId and viewId");const e=["errorMessage","errorSource","errorStack"].filter(e=>!this.options.fieldMap[e]);e.length>0&&console.error(`KnackError: Missing required field mappings: ${e.join(", ")}`)}_processErrorGroup(e){const t=this._generateErrorHash(e),n=Date.now();if(this._errorHashes.has(t)){const e=this._errorHashes.get(t);return e.count++,e.lastSeen=n,n-e.firstLogged>36e5?(this._errorHashes.set(t,{count:1,firstLogged:n,lastSeen:n,record:null}),null):e}return this._errorHashes.set(t,{count:1,firstLogged:n,lastSeen:n,record:null}),null}_shouldIgnoreError(e){const t=e instanceof Error?e.message:String(e);return this.options.ignoredErrors.some(e=>e instanceof RegExp?e.test(t):t.includes(e))}_isRateLimited(){const e=Date.now();return e-this._lastResetTime>6e4&&(this._errorCount=0,this._lastResetTime=e),++this._errorCount>this.options.maxErrorsPerMinute}_generateErrorHash(e){return[e.errorName||"",e.errorMessage||"",e.errorSource||"",e.contextSceneId||"",e.contextViewId||"",e.contextEventType||""].join("|")}_updatePerformanceMetrics(e){if(this.performanceData.totalErrors++,"NetworkError"===e.errorName||e.errorMessage.includes("network")?this.performanceData.networkErrors++:e.errorMessage.includes("API")||e.errorSource.includes("API")||e.errorSource.includes("caAPI")?this.performanceData.apiErrors++:this.performanceData.javaScriptErrors++,e.responseTime){const t=parseFloat(e.responseTime);if(!isNaN(t)){(!this.performanceData.slowestOperation||t>this.performanceData.slowestOperation.time)&&(this.performanceData.slowestOperation={time:t,source:e.errorSource,timestamp:e.errorTime});const n=this.performanceData.averageResponseTime*(this.performanceData.totalErrors-1);this.performanceData.averageResponseTime=(n+t)/this.performanceData.totalErrors}}}_captureErrorData(e,t,n){const o={errorMessage:e instanceof Error?e.message:String(e),errorName:e instanceof Error?e.name:"CustomError",errorStack:e instanceof Error?e.stack:(new Error).stack,errorSource:n,errorTime:(new Date).toISOString(),errorUrl:window.location.href};return["contextSceneId","contextViewId","contextEventType","contextRecordId","contextUrl","contextTimestamp","knackContext","knackContextFormatted"].forEach(e=>{t[e]&&(o[e]=t[e])}),this.options.captureUserData&&Object.assign(o,this._captureUserData()),this.options.captureSystemInfo&&Object.assign(o,this._captureSystemInfo()),this.options.captureKnackContext&&Object.assign(o,this._captureContextData(t)),o.additionalInfo={...t},o}_captureUserData(){const e={};if(this.options.captureUserData&&Knack&&Knack.getUserAttributes)try{const t=Knack.getUserAttributes();e.userName=t.name||"Unknown User",e.userId=t.id||"Unknown ID",Knack.getUserRoleNames&&(e.userRoles=Knack.getUserRoleNames())}catch(t){e.userInfoError="Failed to capture user data"}return e}_captureSystemInfo(){const e={};if(this.options.captureSystemInfo)try{const t=navigator.userAgent;if(e.userAgent=t,e.browserName=this._getBrowserInfo(t).name,e.browserVersion=this._getBrowserInfo(t).version,e.deviceType=this._getDeviceType(t),e.operatingSystem=this._getOperatingSystem(t),e.screenSize=`${window.innerWidth}x${window.innerHeight}`,e.viewportSize=`${document.documentElement.clientWidth}x${document.documentElement.clientHeight}`,e.knackAppId=Knack?Knack.application_id:"Unknown",navigator.connection&&(e.networkType=navigator.connection.effectiveType,e.downlink=navigator.connection.downlink),window.performance&&window.performance.memory){const t=window.performance.memory;e.jsHeapSizeLimit=t.jsHeapSizeLimit,e.totalJSHeapSize=t.totalJSHeapSize,e.usedJSHeapSize=t.usedJSHeapSize}if(window.performance&&window.performance.timing){const t=window.performance.timing;e.pageLoadTime=t.loadEventEnd-t.navigationStart,e.domReadyTime=t.domComplete-t.domLoading}}catch(t){e.systemInfoError="Failed to capture system data"}return e}_captureContextData(e){const t={};if(this.options.captureKnackContext&&this.options.separateContextFields)try{const e=this.getCurrentContext();t.contextSceneId=e.sceneId||e.currentSceneId||null,t.contextViewId=e.viewId||e.currentViewId||null,t.contextEventType=e.eventType||null,t.contextRecordId=e.recordId||null,t.contextTimestamp=e.timestamp||null,t.contextUrl=e.url||window.location.href,e.recordId&&(t.contextRecordId=e.recordId),t.knackContextFormatted=this._formatKnackContext(e)}catch(e){t.contextError="Failed to capture Knack context"}return t}_formatKnackContext(e){const t=[];if(e.eventType&&t.push(`Event: ${e.eventType}`),(e.sceneId||e.currentSceneId)&&t.push(`Scene: ${e.sceneId||e.currentSceneId}`),(e.viewId||e.currentViewId)&&t.push(`View: ${e.viewId||e.currentViewId}`),e.recordId&&t.push(`Record: ${e.recordId}`),e.timestamp){const n=new Date(e.timestamp).toLocaleString();t.push(`Time: ${n}`)}return t.join(" | ")}_logToKnackTable(e){const t={};if(Object.entries(this.options.fieldMap).forEach(([n,o])=>{"additionalInfo"!==n&&void 0!==e[n]&&(t[o]=e[n])}),this.options.fieldMap.additionalInfo&&e.additionalInfo){const n=this.options.fieldMap.additionalInfo,o={...e.additionalInfo};Object.keys(this.options.fieldMap).forEach(e=>{"additionalInfo"!==e&&delete o[e]});if(["contextSceneId","contextViewId","contextEventType","contextRecordId","contextUrl","contextTimestamp","knackContext","knackContextFormatted"].forEach(e=>{delete o[e]}),Object.keys(o).length>0){const e=JSON.stringify(o,null,2);t[n]=e}}return this.api.createRecord(this.options.sceneId,this.options.viewId,t)}_getBrowserInfo(e){const t=[{name:"Edge",pattern:/Edge|Edg/i},{name:"Chrome",pattern:/Chrome/i},{name:"Firefox",pattern:/Firefox/i},{name:"Safari",pattern:/Safari/i},{name:"Opera",pattern:/Opera|OPR/i},{name:"Internet Explorer",pattern:/Trident|MSIE/i}];let n={name:"Unknown",version:"Unknown"};for(const o of t)if(o.pattern.test(e)){let t;switch(n.name=o.name,o.name){case"Edge":t=e.match(/Edge?\/(\d+(\.\d+)?)/i);break;case"Chrome":t=e.match(/Chrome\/(\d+(\.\d+)?)/i);break;case"Firefox":t=e.match(/Firefox\/(\d+(\.\d+)?)/i);break;case"Safari":t=e.match(/Version\/(\d+(\.\d+)?)/i);break;case"Opera":t=e.match(/OPR\/(\d+(\.\d+)?)/i)||e.match(/Opera\/(\d+(\.\d+)?)/i);break;case"Internet Explorer":t=e.match(/(?:MSIE |rv:)(\d+(\.\d+)?)/i)}t&&t[1]&&(n.version=t[1]);break}return n}_getDeviceType(e){return/Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e)?/Tablet|iPad/i.test(e)?"Tablet":"Mobile":"Desktop"}_getOperatingSystem(e){const t=[{name:"Windows",pattern:/Windows NT/i},{name:"Windows Phone",pattern:/Windows Phone/i},{name:"macOS",pattern:/Macintosh/i},{name:"iOS",pattern:/iPhone|iPad|iPod/i},{name:"Android",pattern:/Android/i},{name:"Linux",pattern:/Linux/i}];for(const n of t)if(n.pattern.test(e))return n.name;return"Unknown OS"}}