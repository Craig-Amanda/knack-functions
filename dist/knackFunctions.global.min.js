const CLASS_HIDDEN="ktlHidden",CLASS_DISPLAY_NONE="ktlDisplayNone",INPUT_CHECKBOX_SELECTOR='input[type="checkbox"]',INPUT_RADIO_SELECTOR='input[type="radio"]',INPUT_CHECKBOX_CHECKED_SELECTOR=`${INPUT_CHECKBOX_SELECTOR}:checked`,INPUT_RADIO_CHECKED_SELECTOR=`${INPUT_RADIO_SELECTOR}:checked`,HEADER_CHECKBOX_SELECTOR='th input[type="checkbox"]',CLASS_DISABLED="disabled";console.log("KnackApps/ARC Beta 1.0 - knackFunctions.js loaded."),$.expr[":"].textEquals=function(e,t,n){let r=n[3];return $(e).text().replace("*","").trim()===r};const evaluate=e=>t=>n=>{switch(t){case"+":return e+n;case"-":return e-n;case"/":return e/n;case"*":return e*n;case">":return e>n;case">=":return e>=n;case"<":return e<n;case"<=":return e<=n;case"==":return e==n;case"===":return e===n;case"!=":return e!=n;case"!==":return e!==n;case"%":return e%n;default:return"Invalid operation"}};function getNumericValue(e,t=!1){let n;if("string"==typeof e){if(n=document.querySelector(e),!n)return NaN}else{if(!e||"object"!=typeof e||!("value"in e))return NaN;n=e}const r=String(n.value??"").trim(),o=t?r.replace(/[^\d.+-]/g,""):r,i=Number(o);return Number.isFinite(i)?i:NaN}function setVisibility(e,t){"string"==typeof e&&(e=document.querySelectorAll(e)),e instanceof Element&&(e=[e]),(NodeList.prototype.isPrototypeOf(e)||Array.isArray(e))&&e.forEach(e=>{e&&(e.style.display=t?"":"none")})}function showIf(e,t){setVisibility(e,!!("function"==typeof t?t():t))}function toggleVisibility(e,t){"string"==typeof e&&(e=document.querySelectorAll(e)),e instanceof Element&&(e=[e]),(NodeList.prototype.isPrototypeOf(e)||Array.isArray(e))&&e.forEach(e=>{if(!e)return;let n;n=void 0===t?"none"===e.style.display:"function"==typeof t?t():!!t,e.style.display=n?"":"none"})}function QuillEditor({value:e,onChange:t,modules:n,theme:r="snow",readOnly:o=!1}){const i=React.useRef(null),s=React.useRef(null);return React.useEffect(()=>{if(!i.current||!window.Quill||s.current)return;s.current=new window.Quill(i.current,{theme:r,modules:n,readOnly:o});const e=[i.current.previousSibling,i.current.parentNode?.querySelector(".ql-toolbar"),document.querySelector(".ql-toolbar")].find(e=>e?.classList?.contains("ql-toolbar"));if(e){const t=/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"Cmd":"Ctrl";[{selector:"button.ql-bold",tip:`Bold (${t}+B)`},{selector:"button.ql-italic",tip:`Italic (${t}+I)`},{selector:"button.ql-underline",tip:`Underline (${t}+U)`},{selector:"button.ql-link",tip:`Insert Link (${t}+K)`},{selector:"button.ql-image",tip:"Insert Image"},{selector:"button.ql-code-block",tip:"Code Block"},{selector:"button.ql-blockquote",tip:"Blockquote"},{selector:"button.ql-clean",tip:"Remove Formatting"},{selector:'button.ql-list[value="ordered"]',tip:`Numbered List (${t}+Shift+7)`},{selector:'button.ql-list[value="bullet"]',tip:`Bullet List (${t}+Shift+8)`},{selector:".ql-color",tip:"Text Color"},{selector:".ql-background",tip:"Background Color"},{selector:'button.ql-script[value="sub"]',tip:`Subscript (${t}+,)`},{selector:'button.ql-script[value="super"]',tip:`Superscript (${t}+.)`},{selector:".ql-align",tip:"Align"}].forEach(({selector:t,tip:n})=>{e.querySelectorAll(t).forEach(e=>{e.title=n})});const n=e.querySelector(".ql-align.ql-picker");if(n){n.querySelectorAll(".ql-picker-item").forEach(e=>{switch(e.getAttribute("data-value")){case null:e.title="Align Left";break;case"center":e.title="Align Center";break;case"right":e.title="Align Right";break;case"justify":e.title="Justify"}})}}return s.current.on("text-change",()=>{const e=i.current.querySelector(".ql-editor").innerHTML;t&&t(e)}),()=>{s.current&&(s.current.off("text-change"),s.current=null)}},[n,r,o]),React.useEffect(()=>{s.current&&e!==s.current.root.innerHTML&&!s.current.hasFocus()&&s.current.clipboard.dangerouslyPasteHTML(e||"")},[e]),React.useEffect(()=>{s.current&&s.current.enable(!o)},[o]),React.createElement("div",{ref:i})}function initializeQuillIcons(){if(!window.Quill?.imports?.["ui/icons"])return;const e=window.Quill.imports["ui/icons"];e.list.ordered='\n        <svg viewBox="0 0 18 18">\n            <text x="2" y="5.5" font-size="6" font-family="Arial" fill="#444">1</text>\n            <rect class="ql-stroke" height="0.1" width="8" x="10" y="3.8" rx="0.3"></rect>\n            <text x="2" y="11.5" font-size="6" font-family="Arial" fill="#444">2</text>\n            <rect class="ql-stroke" height="0.1" width="8" x="10" y="9.6" rx="0.3"></rect>\n            <text x="2" y="17" font-size="6" font-family="Arial" fill="#444">3</text>\n            <rect class="ql-stroke" height="0.1" width="8" x="10" y="15" rx="0.3"></rect>\n        </svg>\n    ',e.list.bullet='\n        <svg viewBox="0 0 18 18">\n            <circle class="ql-fill" cx="5" cy="4" r="1.5"></circle>\n            <rect class="ql-stroke" height="0.1" width="8" x="10" y="3.8" rx="0.3"></rect>\n            <circle class="ql-fill" cx="5" cy="10" r="1.5"></circle>\n            <rect class="ql-stroke" height="0.1" width="8" x="10" y="9.6" rx="0.3"></rect>\n            <circle class="ql-fill" cx="5" cy="15" r="1.5"></circle>\n            <rect class="ql-stroke" height="0.1" width="8" x="10" y="15" rx="0.3"></rect>\n        </svg>\n    '}const QuillModal={init(){if(document.getElementById("quill-universal-modal"))return;const e=document.createElement("div");e.id="quill-universal-modal",e.innerHTML='\n            <div class="ql-modal-content">\n                <h3 id="ql-modal-title"></h3>\n                <div id="ql-modal-fields"></div>\n                <div class="ql-modal-actions">\n                    <button id="ql-modal-save" type="button">Save</button>\n                    <button id="ql-modal-unlink" type="button" style="display:none;">Unlink</button>\n                    <button id="ql-modal-cancel" type="button">Cancel</button>\n                </div>\n            </div>\n        ',document.body.appendChild(e);const t=document.createElement("style");t.textContent="\n            #quill-universal-modal {\n                position: fixed; z-index: 99999; left: 0; top: 0; width: 100vw; height: 100vh; display: none;\n                background: rgba(0,0,0,0.3); align-items: center; justify-content: center;\n            }\n            .ql-modal-content {\n                background: #fff; border-radius: 8px; padding: 1.5em 2em; min-width: 320px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);\n                display: flex; flex-direction: column; gap: 1.25em;\n            }\n            .ql-modal-content h3 {\n                margin: 0; padding: 0; font-size: 1.3em;\n            }\n            .ql-modal-content label {\n                display: flex; flex-direction: column; gap: 0.5em; font-weight: 500;\n                margin-bottom: 0.5em;\n            }\n            .ql-modal-content input {\n                padding: 0.5em; border: 1px solid #ccc; border-radius: 4px;\n                margin-bottom: 0;\n            }\n            .ql-modal-content small {\n                color: #666; font-size: 0.65em; margin-top: -0.7em; margin-bottom: 0.85em;\n                display: block;\n            }\n            .ql-modal-fields {\n                margin-bottom: 0.5em;\n            }\n            .ql-modal-actions {\n                display: flex; gap: 1em; justify-content: flex-end;\n                margin-top: 0.5em; padding-top: 0.5em;\n            }\n            .ql-modal-actions button {\n                padding: 0.6em 1.2em; border: none; border-radius: 4px;\n                background: #0078d4; color: #fff; font-weight: 600; cursor: pointer;\n                min-width: 80px;\n            }\n            .ql-modal-actions button#ql-modal-unlink { background: #e81123; }\n            .ql-modal-actions button#ql-modal-cancel { background: #888; }\n            .ql-modal-actions button:disabled { opacity: 0.6; cursor: not-allowed; }\n            .ql-modal-actions button:hover { filter: brightness(1.1); }\n        ",document.head.appendChild(t)},show({type:e,url:t="",label:n="",onSave:r,onUnlink:o,onCancel:i}){this.init();const s=document.getElementById("quill-universal-modal"),a=document.getElementById("ql-modal-fields"),l=document.getElementById("ql-modal-title"),c=document.getElementById("ql-modal-save"),d=document.getElementById("ql-modal-unlink"),u=document.getElementById("ql-modal-cancel");"link"===e?(l.textContent="Insert/Edit Link",a.innerHTML=`\n                <label>\n                    Link URL:\n                    <input type="url" id="ql-link-url" placeholder="https://example.com" value="${t}" required>\n                    <small>\n                        If you omit https:// it will be added automatically.\n                    </small>\n                </label>\n                <label>\n                    Link Text:\n                    <input type="text" id="ql-link-label" placeholder="Link text" value="${n}" required>\n                </label>\n            `,d.style.display=""):"image"===e&&(l.textContent="Insert Image",a.innerHTML=`\n                <label>\n                    Image URL:\n                    <input type="url" id="ql-image-url" placeholder="https://example.com/image.jpg" value="${t}" required>\n                </label>\n            `,d.style.display="none"),s.style.display="flex",c.onclick=()=>{if("link"===e){let e=document.getElementById("ql-link-url").value.trim(),t=document.getElementById("ql-link-label").value.trim();e&&t&&(/^https?:\/\//i.test(e)||(e="https://"+e),r(e,t),s.style.display="none")}else if("image"===e){let e=document.getElementById("ql-image-url").value.trim();e&&(r(e),s.style.display="none")}},d.onclick=()=>{o&&o(),s.style.display="none"},u.onclick=()=>{i&&i(),s.style.display="none"}}};function createQuillModules(){return{toolbar:{container:[[{header:[1,2,3,4,!1]},{font:[]}],["bold","italic","underline",{color:[]},{background:[]}],[{align:[]},{list:"ordered"},{list:"bullet"}],["code-block","blockquote",{script:"sub"},{script:"super"}],["link","image"],["clean"]],handlers:{image:function(){const e=this.quill;let t=e.getSelection();QuillModal.show({type:"image",url:"",onSave:n=>{e.setSelection(t.index,t.length),e.insertEmbed(t.index,"image",n,"user")}})},link:function(){const e=this.quill;let t=e.getSelection();if(!t)return;let n="",r="";const[o]=e.getLeaf(t.index);if(o?.parent?.formats&&"function"==typeof o.parent.formats){const i=o.parent.formats();i.link?(n=i.link,r=o.parent.domNode.innerText||e.getText(t.index,t.length)):r=e.getText(t.index,t.length)}else r=e.getText(t.index,t.length);QuillModal.show({type:"link",url:n,label:r,onSave:(n,r)=>{e.setSelection(t.index,t.length),e.deleteText(t.index,t.length),e.insertText(t.index,r,"link",n)},onUnlink:()=>{e.setSelection(t.index,t.length),e.format("link",!1)}})}}},keyboard:{bindings:{orderedList:{key:55,shortKey:!0,shiftKey:!0,handler:function(){this.quill.format("list","ordered")}},bulletList:{key:56,shortKey:!0,shiftKey:!0,handler:function(){this.quill.format("list","bullet")}}}}}}function replaceKnackRichTextWithQuillEditor(e,t={}){if(!window.React||!window.ReactDOM||!window.Quill)return void console.warn("React or Quill not loaded, using Knack Redactor editor.");initializeQuillIcons();const n=createQuillModules(),r=e?document.getElementById(e):document;if(!r)return;const o=r.querySelectorAll?.(".kn-input-rich_text")||document.querySelectorAll(".kn-input-rich_text");return o.length?(o.forEach((o,i)=>{if("true"===o.dataset.quillMounted)return;const s=o.querySelector(".redactor-editor"),a=o.querySelector("textarea.rich_text");if(!s||!a)return;const l=o.querySelector("label.kn-label");let c=null;l&&(c=l.cloneNode(!0),l.remove());const d=`${e||"global"}-${i}`;let u=o.parentNode.querySelector(`.my-react-editor[data-for="${o.id}"]`);u||(u=document.createElement("div"),u.className="my-react-editor",u.id=`my-react-editor-${d}`,u.setAttribute("data-for",o.id),o.parentNode.insertBefore(u,o),c&&u.parentNode.insertBefore(c,u));try{s.classList.add("ktlHidden"),u._reactRootContainer||(u._reactRootContainer=ReactDOM.createRoot(u)),u._reactRootContainer.render(React.createElement(QuillEditor,{theme:t.theme||"snow",value:a.value,modules:t.modules||n,readOnly:t.readOnly||!1,onChange:e=>{const t=!e||""===e.replace(/<[^>]+>/g,"").trim();a.value=t?"":e,s&&(s.innerHTML=t?"":e),a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0})),a.blur()}})),o.dataset.quillMounted="true",document.querySelectorAll(".redactor-toolbar, .redactor-toolbar-tooltip, .redactor-air, .redactor-dropdown").forEach(e=>e.remove()),document.querySelectorAll('[id^="redactor-toolbar-"]').forEach(e=>e.remove())}catch(e){console.error("Failed to load QuillEditor, reverting to Knack Redactor editor:",e);const t=r.querySelectorAll?r:document;t.querySelectorAll(".redactor-editor").forEach(e=>e.classList.remove("ktlHidden")),t.querySelectorAll(".my-react-editor").forEach(e=>e.remove())}}),o.length):void 0}function truncateColumnsInGrid(e,t){const n=document.getElementById(e);n&&Object.entries(t).forEach(([e,t])=>{const r=parseInt(e,10);(Array.isArray(t)?t:[t]).forEach(e=>{const t=`td.field_${e}`,o=document.createElement("div");n.querySelectorAll(t).forEach(e=>{const t=e.innerHTML;let n=t.replace(/<\/(p|div|li|h[1-6]|tr|td|th)>/gi," ").replace(/<(p|div|li|h[1-6]|tr|td|th)[^>]*>/gi," ").replace(/<\/(p|div|li|h[1-6]|tr|td|th)>/gi," ").replace(/<(ul|ol|table|thead|tbody|tfoot|section|article)[^>]*>/gi," ");o.innerHTML=n;const i=o.textContent;if(i.length>r){const n=i.substring(0,r)+"...",o=document.createElement("span");o.textContent=n;const s=document.createElement("span");s.innerHTML=t,s.style.display="none";const a=document.createElement("a");a.href="#",a.className="text-expand",a.textContent="View More",a.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation();const t="none"===s.style.display;s.style.display=t?"":"none",o.style.display=t?"none":"",a.textContent=t?"View Less":"View More"}),e.innerHTML="",e.appendChild(o),e.appendChild(s),e.appendChild(document.createTextNode(" ")),e.appendChild(a)}})})})}function selectTextOnFocus(e,t=".kn-input-number input"){const n=document.getElementById(e);if(!n)return;n.querySelectorAll(t).forEach(e=>{e.addEventListener("focus",function(){setTimeout(()=>{this.select()},0)})})}function debounce(e,t){let n;return function(...r){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...r)},t)}}function resolveElement(e){return e?"string"==typeof e?document.querySelector(e):e instanceof Element?e:null:null}function resolveElements(e){return e?"string"==typeof e?Array.from(document.querySelectorAll(e)):e instanceof Element?[e]:NodeList.prototype.isPrototypeOf(e)||Array.isArray(e)?Array.from(e).filter(e=>e instanceof Element):[]:[]}function addInputEventListener(e,t,n={}){const{events:r="change",delegate:o=null,runOnInit:i=!1}=n,s=Array.isArray(r)?r:[r],a=[],l=()=>!(!window.jQuery||!window.jQuery.fn),c=()=>window.jQuery,d=e=>{if(!e||"SELECT"!==e.tagName)return!1;const t=e.classList;if(t&&(t.contains("chosen-select")||t.contains("chzn-select")))return!0;const n=e.nextElementSibling;return!(!n||!n.classList||!n.classList.contains("chosen-container")&&!n.classList.contains("chzn-container"))},u=e=>{i&&e.forEach(e=>{try{t(null,e)}catch(e){}})},m=(e,t,n)=>{e.addEventListener(t,n,!1)},f=e=>{if(!l()||!o)return!1;try{const n=c();return n(e).off("change.ktl_delegate_chosen"),n(e).on("change.ktl_delegate_chosen",`${o} select.chosen-select, ${o} select.chzn-select, ${o}.chosen-select, ${o}.chzn-select`,function(e){t(e,this)}),!0}catch(e){return!1}},p=e=>{if(!l())return;const n=c();var r;if("function"==typeof n.fn.datepicker&&((r=e)&&r.classList&&r.classList.contains("hasDatepicker")))try{const r=n(e);let o=null;try{o=r.datepicker("option","onSelect")}catch(e){o=null}r.datepicker("option","onSelect",function(n,r){if("function"==typeof o)try{o.call(this,n,r)}catch(e){}const i={type:"datepicker",dateText:n,target:e};try{t(i,e)}catch(e){}})}catch(e){}};return resolveElements(e).forEach(e=>{if(!(e instanceof Element))return;if(o){const n=Array.from(e.querySelectorAll(o));return n.some(e=>!!e&&(!!d(e)||!(!e.querySelector||!e.querySelector("select.chosen-select")&&!e.querySelector("select.chzn-select"))))&&f(e)||s.forEach(n=>{m(e,n,function(n){const r=n.target&&n.target.closest?n.target.closest(o):null;if(r&&e.contains(r))try{t(n,r)}catch(e){}})}),a.push(e),void u(n)}const n=(e=>{if(!e)return[];const t=(e.tagName||"").toUpperCase();return"INPUT"===t||"SELECT"===t||"TEXTAREA"===t?[e]:Array.from(e.querySelectorAll("input, select, textarea"))})(e);n.length&&(n.forEach(e=>{p(e),d(e)&&(e=>{if(!l())return!1;try{return c()(e).off("change.ktl_chosen").on("change.ktl_chosen",function(n){t(n,e)}),!0}catch(e){return!1}})(e)||s.forEach(n=>{m(e,n,function(n){try{t(n,e)}catch(e){}})}),a.push(e)}),u(n))}),a}function enhanceDateTimePicker(e,t={}){const n=Object.assign({},{mode:"date",changeMonth:!0,changeYear:!0,yearsBack:80,yearsForward:5,showButtonPanel:!1,dateFormat:null,minDate:null,maxDate:null,waitForInit:!1,maxAttempts:10,attemptInterval:200,onApplied:null,timeFormat:"H:i",minTime:null,maxTime:null,disableTimeRanges:null,step:null,timepickerOptions:null},t||{}),r=String(n.mode||"date").toLowerCase(),o="date"===r||"datetime"===r,i="time"===r||"datetime"===r,s=!(!window.jQuery||!window.jQuery.fn),a=s&&"function"==typeof window.jQuery.fn.datepicker,l=s&&"function"==typeof window.jQuery.fn.timepicker;if(!s||o&&!a||i&&!l)return!!n.waitForInit&&Promise.resolve(!1);const c=e=>{if(!e||"object"!=typeof e)return[];const t=e.viewId,n=e.fieldId;if(!t||!n)return[];const r=document.getElementById(t);if(!r)return[];const o=`kn-input-${n}`,i=r.querySelector(`#${o}`);if(!i)return[];const s=`${t}-${n}`,a=new Set([s,`${s}-time`,`${s}-to`,`${s}-time-to`]);return Array.from(i.querySelectorAll("input")).filter(e=>!(!e||!e.id)&&a.has(e.id))},d=(()=>{if(Array.isArray(e)&&e.length&&"object"==typeof e[0]&&!(e[0]instanceof Element)){const t=e.flatMap(e=>c(e));return Array.from(new Set(t))}if(e&&"object"==typeof e&&!(e instanceof Element)&&!NodeList.prototype.isPrototypeOf(e)){const t=c(e);if(t.length)return t}return"string"==typeof e?Array.from(document.querySelectorAll(e)):NodeList.prototype.isPrototypeOf(e)||Array.isArray(e)?Array.from(e):e instanceof Element?[e]:[]})();if(!d.length)return!!n.waitForInit&&Promise.resolve(!1);if(o&&!document.getElementById("knack-datepicker-styles")){const e=document.createElement("style");e.id="knack-datepicker-styles",e.textContent="\n        /* Improve month/year select styling in jQuery UI datepicker */\n        .ui-datepicker-title {\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            gap: 6px;\n        }\n        .ui-datepicker select.ui-datepicker-month, .ui-datepicker select.ui-datepicker-year {\n            padding: 2px 6px;\n            border-radius: 4px;\n            border: 1px solid #cfcfcf;\n            background: #fff;\n            color: #222;\n            font-size: 13px;\n            margin-right: 0;\n            display: inline-block;\n        }\n        .ui-datepicker .ui-datepicker-header {\n            padding: 6px 8px;\n            background: #f5f6f7;\n            border-bottom: 1px solid rgba(0,0,0,0.06);\n        }\n        .ui-datepicker .ui-datepicker-calendar td a {\n            border-radius: 4px;\n            padding: 6px 8px;\n        }\n        .ui-datepicker .ui-datepicker-buttonpane {\n            text-align: right;\n            padding: 6px 8px;\n        }\n        ",document.head.appendChild(e)}const u=()=>{let e=!1;return d.forEach(t=>{try{const r=$(t);if(!r||!r.hasClass)return;let s=!1;if(o&&r.hasClass("hasDatepicker")){const e=(new Date).getFullYear(),t=e-Math.max(0,n.yearsBack),o=e+Math.max(0,n.yearsForward),i={changeMonth:!!n.changeMonth,changeYear:!!n.changeYear,yearRange:`${t}:${o}`,showButtonPanel:!!n.showButtonPanel};n.dateFormat&&(i.dateFormat=n.dateFormat),null!==n.minDate&&(i.minDate=n.minDate),null!==n.maxDate&&(i.maxDate=n.maxDate),r.datepicker("option",i),i.showButtonPanel&&(document.documentElement.dataset.knackTodayHandlerAttached||(document.documentElement.dataset.knackTodayHandlerAttached="1",document.addEventListener("click",e=>{if(e.target&&e.target.closest?e.target.closest('.ui-datepicker-current[data-handler="today"]'):null)try{const e=window.jQuery&&window.jQuery.datepicker?window.jQuery.datepicker._curInst:null,t=e&&e.input?e.input:null;if(!t||!t.length)return;t.datepicker("setDate",new Date),t.datepicker("hide")}catch(e){}},!0))),s=!0}if(i&&"function"==typeof r.timepicker){const e=r.attr("id")||"",t=r.attr("name")||"";if(!(/-time(-to)?$/.test(e)||"time"===t||"to_time"===t||r.hasClass("kn-time")))return;const o={};n.timeFormat&&(o.timeFormat=n.timeFormat),null!==n.minTime&&(o.minTime=n.minTime),null!==n.maxTime&&(o.maxTime=n.maxTime),n.disableTimeRanges&&(o.disableTimeRanges=n.disableTimeRanges),n.step&&(o.step=n.step),n.timepickerOptions&&"object"==typeof n.timepickerOptions&&Object.assign(o,n.timepickerOptions),r.hasClass("ui-timepicker-input")?r.timepicker("option",o):r.timepicker(o),s=!0}if(s&&(e=!0,"function"==typeof n.onApplied))try{n.onApplied(t)}catch(e){}}catch(e){}}),e};return n.waitForInit?new Promise(e=>{let t=0;const r=()=>{t+=1;return u()?e(!0):t>=Math.max(1,n.maxAttempts)?e(!1):void setTimeout(r,Math.max(50,n.attemptInterval))};r()}):u()}async function waitSelector({selector:e,textCondition:t=null,returnType:n="element",timeout:r=1e4}){return new Promise((o,i)=>{let s=null,a=null;const l=()=>{let r=null,i=null,l=!1;t&&("string"==typeof t?(i=t,l=!1):"object"==typeof t&&null!==t&&(i=t.text,l=!!t.exact));const c=e=>{if(!i)return!0;const t=e.textContent.trim();return l?t===i:t.includes(i)};if("elements"===n){if(r=document.querySelectorAll(e),r.length>0){if(i&&(r=Array.from(r).filter(c),0===r.length))return;t&&"string"!=typeof t&&"object"!=typeof t&&!t(r)||(s&&s.disconnect(),clearTimeout(a),o(r))}}else{if(i){const t=document.querySelectorAll(e);for(const e of t)if(c(e)){r=e;break}}else r=document.querySelector(e);r&&(t&&"string"!=typeof t&&"object"!=typeof t&&!t(r)||(s&&s.disconnect(),clearTimeout(a),o("empty"===n||r)))}};l(),a=setTimeout(()=>{s&&s.disconnect();let n="";t&&("string"==typeof t?n=` with text: ${t}`:"object"==typeof t&&t.text&&(n=` with ${t.exact?"exact ":""}text: ${t.text}`)),i(new Error(`Timeout waiting for selector: ${e}${n} after ${r}ms`))},r),s=new MutationObserver((e,t)=>{l()}),s.observe(document.body,{childList:!0,subtree:!0,attributes:!0})})}document.addEventListener("mousedown",function(e){const t=document.activeElement&&document.activeElement.closest(".ql-editor"),n=e.target.closest(".ql-editor, .ql-toolbar, .ql-container"),r=e.target.closest(".ql-picker, .ql-picker-label, .ql-picker-options, .ql-picker-item");!t&&!n||r||e.stopImmediatePropagation()},!0);const updateOptions=(e,t,n,r)=>{const o=e.querySelector(".kn-add-option");if(!o)return;const i=e.querySelector(".default"),s=e.querySelector(".chzn-container")||e.querySelector(".select");if(o.textContent=t,o.style.width="fit-content",r){if(o.classList.add("disabled"),s){const t=()=>{o.classList.remove("disabled")};s.addEventListener("click",t);const n=s.querySelector(".chzn-search input");n&&(n.addEventListener("focus",t),n.addEventListener("input",t));const r=e.querySelector("select");r&&(r.addEventListener("change",t),r.addEventListener("focus",t))}}else{const t=e.querySelector(".control");t&&t.parentNode!==o.parentNode&&t.parentNode.insertBefore(o,t)}i&&(i.value=n),o.addEventListener("mousedown",function e(t){waitSelector({selector:"li.kn-form-col",timeout:3e3}).then(()=>registrationHandler(t)),o.removeEventListener("mousedown",e)},{once:!0})};function getValueFromDetailBody(e,t=!1){const n=document.querySelector(`.field_${e} .kn-detail-body`);return n?t?n.innerHTML.trim():n.textContent.trim():(console.log(`Error: Element with field_${e} not found.`),null)}function getIndexOfColumnHeader(e,t){if(!e)return errorHandler.handle(new Error("getIndexOfColumnHeader: viewElement is undefined"),{fieldIds:t}),Array.isArray(t)?t.map(()=>-1):-1;if(null==t)return errorHandler.handle(new Error("getIndexOfColumnHeader: fieldIds is undefined or null"),{viewElement:e}),-1;const n=e.querySelector("table thead tr");return n?Array.isArray(t)?t.map(e=>Array.from(n.children).findIndex(t=>t.classList.contains(`field_${e}`))):Array.from(n.children).findIndex(e=>e.classList.contains(`field_${t}`)):(errorHandler.handle(new Error("getIndexOfColumnHeader: headerRow not found"),{viewElement:e,fieldIds:t}),Array.isArray(t)?t.map(()=>-1):-1)}function getAllTableRows(e,t,n=!1,r=!1,o=null){if(!e)return;const i=document.querySelector(`#${e} table`);if(!i)return;let s=Array.from(i.querySelectorAll("tbody tr:not(.kn-table-group)"));if(n){s=[...Array.from(i.querySelectorAll("thead tr")),...s]}if(r){const e=Array.from(i.querySelectorAll("tbody tr.kn-table-group"));s=[...s,...e]}o&&(s=s.filter(e=>!e.matches(o))),s.forEach((e,n)=>{t(n,e)})}function updateButtonColourOnFormComplete(e,t,n){const r=getValueFromDetail(e);if(!r||!r.length)return;const o=r.split(",");for(const e of o){const r=t[e.trim()];r&&ktl.core.waitSelector(`#view_${r} .view-header:has(.ktlHideShowButton), #view_${r} a.knViewLink`).then(()=>{$(`#view_${r} .view-header:has(.ktlHideShowButton), #view_${r} a.knViewLink`).css("background-color",n)}).catch(e=>{console.error(`Error waiting for selector in view_${r}:`,e)})}}function removeElement(e){if(Array.isArray(e))return void e.forEach(e=>{removeElement(e)});(e instanceof jQuery?e:$(e)).remove()}function addClassToSelector(e,t){if(Array.isArray(e))return void e.forEach(e=>{addClassToSelector(e,t)});const n=e instanceof jQuery?e:$(e);return n.addClass(t),n}function removeClassFromSelector(e,t){if(Array.isArray(e))return void e.forEach(e=>{removeClassFromSelector(e,t)});const n=e instanceof jQuery?e:$(e);return n.removeClass(t),n}function escapeHTML(e){return e.replace(/[&<>"']/g,function(e){return`&#${e.charCodeAt(0)};`})}function getCheckedRowIds(e){return $(`#${e} tbody ${INPUT_CHECKBOX_CHECKED_SELECTOR}`).map(function(){return $(this).closest("tr").attr("id")}).get()}function getCheckedRows(e){return $(`#${e} tbody ${INPUT_CHECKBOX_CHECKED_SELECTOR}`).map(function(){return $(this).closest("tr")}).get()}function showInputNotification(e,t,n,r=null){const o=`notif_${Date.now()}`,i=e.closest(".kn-input");$("<div>",{id:o,class:"input-notification",text:t,css:{backgroundColor:n}}).insertAfter(i);return null!==r&&setTimeout(()=>{removeInputNotification(o)},r),o}function updateInputNotification(e,t){$(`#${e}`).text(t)}function removeInputNotification(e){$(`#${e}`).remove()}$(document).keydown(function(e){e.keyCode});const API_TIMER=e=>new Promise(t=>setTimeout(t,e)),getMax=e=>Object.keys(e).filter(t=>e[t]==Math.max.apply(null,Object.values(e)));function getTextArea(e){return $(`#${e} textarea`)}function getFieldId(e){return e.attr("id")}function updateFieldsInArrays(e){const t=$(`#${e}`).length>0?e:`connection-form-view:has(input[value="${e}"])`,n=FIELD_IDS_FOR_LOGGED_IN_USER.filter(e=>$(`#${t} #kn-input-field_${e}`).length>0),r=SET_CURRENT_DATE_FIELDS.filter(e=>$(`#${t} #kn-input-field_${e}`).length>0);n.length>0&&updateUserFields(e,n),r.length>0&&updateDateFields(e,r)}function updateUserFields(e,t){const n=Knack.getUserAttributes().name;t.forEach(e=>{const t=$(`#kn-input-field_${e}`),r=t.find("input");t.addClass("ktlHidden"),r.val(n)})}function updateDateFields(e,t){const n=new Date;t.forEach(t=>{if($("#view_3404").length>0)return!1;const r=$(`#${e}-field_${t}`),o=$(`#${e}-field_${t}-time`);if(r.val()||r.val(getDateUKFormat(n)),!o.val()){const e=`${n.getHours()}:${n.getMinutes()}`;o.val(e)}})}function copyTextToClipboard(e,t,n){if(navigator.clipboard)navigator.clipboard.writeText(t);else{const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select();try{document.execCommand("copy")}catch(e){}document.body.removeChild(e)}const r=e.closest("td, .kn-detail-body");if(r&&(r.style.position="relative",r.style.overflow="visible"),showNotification({target:r||e,message:n,backgroundColor:"var(--success)",className:"ca-notification ca-notification-copy",delay:1e3}),r&&!r.closest("table")){const e=r.querySelector(".ca-notification-copy");e&&(e.style.left="120px",e.style.opacity="0.85")}}function addCopyToDetails(e,t={}){if(!e)return;const{addIcon:n=!0,message:r="Text Copied",excludeFieldIds:o=[],includeLabels:i=!1}=t;e.querySelectorAll(".kn-detail-body").forEach(t=>{if(t.closest(".kn-details-link"))return;const s=t.closest('[class*="field_"]');if(s){if(Array.from(s.classList).some(e=>o.includes(e)))return}const a=t.textContent.trim();if(!a)return;if("true"===t.dataset.copyEnabled)return;t.dataset.copyEnabled="true";let l=a;if(i&&s){const t=[...s.classList].find(e=>e.startsWith("field_"));let n="";if(t){const r=e.querySelector(`.kn-label-top.${t}, .kn-detail.${t}`),o=r?.querySelector(".kn-detail-label");n=o?.textContent.trim()||"",console.log(`Label wrapper for ${t}:`,o)}n&&(l=`${n}: ${a}`)}if(n){const e=document.createElement("span");e.textContent=" ðŸ“‹",e.style.userSelect="none",t.appendChild(e)}t.style.cursor="pointer",t.addEventListener("click",()=>{copyTextToClipboard(t,l,r)})})}function setupClickToCopy(e){document.querySelectorAll(`#${e} .ca-click-to-copy`).forEach(e=>{let t=e.textContent.trim();if("ðŸ“‹"===t||""===t)return void(e.style.display="none");t=t.replace(" ðŸ“‹",""),e.textContent.includes("ðŸ“‹")||(e.textContent=t+" ðŸ“‹");let n="Text Copied";e.classList.contains("client-contact-num")?n="Client Number Copied":e.classList.contains("funder-email")?n="Funder Email Copied":e.classList.contains("funder-contact-num")?n="Funder Number Copied":e.classList.contains("funder-office-num")?n="Funder Office Number Copied":e.classList.contains("client-email")&&(n="Client Email Copied"),e.addEventListener("click",function(){copyTextToClipboard(e,t,n)})})}function getWeekCommencingDate(e){const t=e.getDay(),n=(0===t?-6:1)-t,r=new Date(e);return r.setDate(e.getDate()+n),r.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}function scheduleDailyRefresh(e,t,n){const r=new Date,o=new Date;o.setHours(t,n,0,0),r>o&&o.setDate(o.getDate()+1);setTimeout(function(){ktl.views.refreshView(e),setInterval(function(){ktl.views.refreshView(e)},864e5)},o-r)}function getCurrentYear(){return(new Date).getFullYear()}function constructList(e,t){let n=e.join(", ");if(e.length>1){let e=n.lastIndexOf(",");n=n.slice(0,e)+" "+t+n.slice(e+1)}return n}function csvToArray(e,t=!1){if(!e||"string"!=typeof e)return console.error("Invalid input. Please provide a non-empty string."),[];let n=e.split(",").map(e=>e.trim());return t&&(n=[...new Set(n)]),n}function startsWithVowel(e){return-1!=="aeiouAEIOU".indexOf(e[0])}function updateViewTitleIfSelectorFound(e,t,n){ktl.core.waitSelector(t,1e4).then(()=>{const r=$(`#${e} h3.kn-title:first`);$(t).length>0&&r.text(n)})}function onInputChange(e,t,n=!0){e.on("change",function(){t(this)}),n&&e.change()}function toggleMessage(e,t){const n=document.querySelectorAll(`.kn-input:has(${t}), .kn-special-title:has(${t})`);if(0===n.length){document.querySelectorAll(".kn-input, .kn-special-title").forEach(n=>{n.querySelector(t)&&(n.style.display=e?"block":"none")})}else n.forEach(t=>{t.style.display=e?"block":"none"})}function replaceTextInGrid(e,t,n){const r=n.startsWith("field_")?$(`#${e} .kn-table thead th.${n}`).index():$(`#${e} .kn-table thead th:textEquals('${n}')`).index();$(`#${e} .kn-table tbody tr`).each(function(){const e=$(this).find(`td:eq(${r}) span.knViewLink__label`),n=$(this).find(`td.${t}`).find("span").html();e.html(n).find("span").css("text-decoration","none")})}function removeBlanksFromDF(e,t){const n=/^-+\s*-*$/;e.find(".removeIfBlank").each(function(){let e=$(this).text().trim(),r=e;if(t){const n=e.split(t);r=n.length>1?n[1].trim():""}(""===r||n.test(r))&&removeElement(this)})}function hideEmptyListItems(e){$(`#${e}`).find(".kn-list-container").each(function(){""===$(this).text().trim()&&$(this).hide()})}function mapDateToRange(e,t){const[n,r,o]=e.split("/").map(Number),i=new Date(o,r-1,n),s=new Date,a=12*(s.getFullYear()-i.getFullYear())+(s.getMonth()-i.getMonth());for(const e of t)if(a<e.max)return e.label;return console.error(`No match found in range "${t}" for date "${e}".`),!1}function parseDateObject(e){if(e instanceof Date)return Number.isNaN(e.getTime())?null:new Date(e.getTime());if("number"==typeof e){const t=new Date(e);return Number.isNaN(t.getTime())?null:t}if("string"==typeof e){const t=removeHtml(e).trim(),n=/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/.exec(t);if(n){const e=parseInt(n[1],10),t=parseInt(n[2],10);let r=parseInt(n[3],10);r<100&&(r+=2e3);const o=new Date(r,t-1,e);return o.getFullYear()===r&&o.getMonth()===t-1&&o.getDate()===e?o:null}const r=new Date(t);return Number.isNaN(r.getTime())?null:r}return null}function getOffsetDateUK(e,t=0){const n=parseDateObject(e);return n?(n.setDate(n.getDate()+t),getDateUKFormat(n)):(console.warn("getOffsetDateUK: cannot parse date:",e),"")}function getDateUKFormat(e){const t=e instanceof Date?e:parseDateObject(e);return t?t.toLocaleDateString("en-GB"):(console.warn("getDateUKFormat: cannot parse date:",e),"")}function getEndOfDayIso(e){const t=parseDateObject(e);return t?(t.setHours(23,59,59,999),t.toISOString()):""}function getWeeksAgoDate(e){const t=new Date,n=7*e*24*60*60*1e3;return getDateUKFormat(new Date(t.getTime()-n))}function getArrayOfWeekNumbersAndFields(e){return Array.from({length:52},(t,n)=>`field_${e+n}`)}function getWeekNumber(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()));t.setUTCDate(t.getUTCDate()+4-(t.getUTCDay()||7));const n=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-n)/864e5+1)/7)}async function updateWeekNumberObject(e,t,n,r){const o=WEEK_NUM_SHARED_AREA_GRID,i=getWeekNumber(convertToDateObj(t)),s=o.weekNumberFields[i-1],a=createFilterForWeekObj(o,e,r),l=(await caAPI(o.sceneId,o.viewId,null,{},"get",a)).records[0].id;l&&await caAPI(o.sceneId,o.viewId,l,{[s]:n},"put")}function createFilterForWeekObj(e,t,n){return{match:"and",rules:[{field:e.conxField,operator:"is",value:[t]},{field:e.typeField,operator:"is",value:n}]}}function showRelevantWeeks(e,t,n=11,r=7){const o=window.WEEK_NUM_SHARED_AREA_GRID,i=getWeekNumber(new Date),s=o.weekNumberFields,a=document.getElementById(e);if(!a)return void console.warn(`View element with ID ${e} not found`);const l=a.querySelector("thead"),c=a.querySelector("tbody");if(!l||!c)return void console.warn(`Table header or body not found in view ${e}`);s.forEach(e=>{a.querySelectorAll(`.${e}`).forEach(e=>e.style.display="none")});const d=[];for(let e=0;e<n;e++){const t=(i-r+e+52)%52||52,n=t-1;d.push({field:s[n],isCurrentWeek:t===i})}const u=l.querySelector("tr");u&&d.forEach(e=>{const t=u.querySelector(`.${e.field}`);t&&(t.style.display="",u.appendChild(t))});c.querySelectorAll("tr").forEach(e=>{d.forEach(n=>{const r=e.querySelector(`.${n.field}`);r&&(r.style.display="",n.isCurrentWeek&&(r.style.backgroundColor=t),e.appendChild(r))})})}function compareAge(e,t,n){const r=convertToDateObj(e),o=Date.now()-r.getTime(),i=new Date(o),s=Math.abs(i.getUTCFullYear()-1970);return evaluate(s)(n)(t)}async function addConxDetailsToList(e,t,n="",r="detail",o=2e4){try{const i=$(e).addClass("custom-list");if(i.find("li").length>0)return;const s="list"===r?`.kn-list-item-container .${t} .kn-detail-body span`:`.${t} .kn-detail-body span`;await ktl.core.waitSelector(s,o);const a=$(s),l=[];if(a.each(function(e){const t=$(this),n=t.text().trim(),r=t.children("span").length>0;n&&!r&&l.push(n)}),0===l.length&&n)i.append(`<li>${n}</li>`);else{const e=new Set;l.forEach((t,n)=>{e.has(t)||(i.append(`<li>${t}</li>`),e.add(t))})}}catch(e){throw new Error(`Failed to add details to list: ${e}`)}}function mapFieldsToView(e,t,n,r,o){const i=(e,t,n)=>{const i=`#${r} #kn-input-field_${e} ${t}`,s=`#${o} #kn-input-field_${e} ${t}`;0!==$(i).length&&0!==$(s).length?($(s).closest(".kn-input").addClass("ktlHidden"),$(i).on(n,function(){const n=t===INPUT_RADIO_SELECTOR?$(`#kn-input-field_${e} ${INPUT_RADIO_CHECKED_SELECTOR}`).val():$(this).val();t===INPUT_RADIO_SELECTOR?$(`${s}`).filter(`[value="${n}"]`).trigger("click"):($(s).val(n),"select"===t&&$(s).trigger("liszt:updated"))})):console.error(`Element not found: ${i} or ${s}`)};e.forEach(e=>i(e,"textarea","blur")),t.forEach(e=>i(e,INPUT_RADIO_SELECTOR,"change")),n.forEach(e=>i(e,"select","change"))}const MULTI_FORM_CONFIG={TIMEOUTS:{BUTTON_WAIT:1e4,FORM_SUBMIT:3e4,PRE_SUBMIT_DELAY:200,MODAL_CLOSE_DELAY:200,OUTCOME_POLL_INTERVAL:500},SELECTORS:{SUBMIT_BUTTON:"button[type=submit]",FORM:"form",SUCCESS_MESSAGE:".kn-message.success",ERROR_MESSAGE:".kn-message.is-error",MODAL:".kn-modal",MODAL_CLOSE:"button.close-modal"}};class MultiFormSubmissionCoordinator{constructor(e){this.manualSubmitViewId=e.manualSubmitViewId,this.autoSubmitViewIds=e.autoSubmitViewIds||[],this.closeModalAfterSubmit=e.closeModalAfterSubmit||!1,this.onAutoFormsComplete=e.onAutoFormsComplete||null,this.timeouts={...MULTI_FORM_CONFIG.TIMEOUTS,...e.timeouts||{}},this.selectors={...MULTI_FORM_CONFIG.SELECTORS,...e.selectors||{}},this.eventHandlers=new Map,this.isInitialized=!1,this.submittedForms=new Set,this.instanceId=`mfc-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}initialize(e){e===this.manualSubmitViewId?this._attachManualFormHandler():this.autoSubmitViewIds.includes(e)&&this._waitForManualForm()}_getEventNamespace(e,t){return`${e}.${t}.${this.instanceId}`}_isValidationError(e){return e.message.includes("Form validation failed")}async _waitForManualForm(){try{await waitSelector({selector:`#${this.manualSubmitViewId} ${this.selectors.SUBMIT_BUTTON}`,timeout:this.timeouts.BUTTON_WAIT}),this._attachManualFormHandler()}catch(e){errorHandler.handleError(e,{manualSubmitViewId:this.manualSubmitViewId,autoSubmitViewIds:this.autoSubmitViewIds},"MultiFormCoordinator:WaitForManualForm")}}_attachManualFormHandler(){if(this.isInitialized)return;this._hideAutoSubmitButtons();const e=document.getElementById(this.manualSubmitViewId);if(!e)return console.error(`[MultiFormCoordinator] Manual submit view "${this.manualSubmitViewId}" not found`),void errorHandler.handleError(new Error(`Manual submit view "${this.manualSubmitViewId}" not found`),{manualSubmitViewId:this.manualSubmitViewId},"MultiFormCoordinator");const t=e.querySelector(this.selectors.FORM),n=e.querySelector(this.selectors.SUBMIT_BUTTON);if(!t||!n)return console.error(`[MultiFormCoordinator] Form or submit button not found in view "${this.manualSubmitViewId}"`),void errorHandler.handleError(new Error(`Form or submit button not found in view "${this.manualSubmitViewId}"`),{manualSubmitViewId:this.manualSubmitViewId,formExists:!!t,buttonExists:!!n},"MultiFormCoordinator");this._cleanupPreviousHandler(n);const r=async e=>{e.preventDefault(),e.stopPropagation(),await this._handleFormSubmission(t,n)},o=e=>{e.preventDefault(),e.stopPropagation()};n._multiSubmitHandler=r,n.addEventListener("click",r),t._multiFormSubmitHandler=o,t.addEventListener("submit",o),this.isInitialized=!0}_hideAutoSubmitButtons(){this.autoSubmitViewIds.forEach(e=>{const t=this._getEventNamespace("knack-view-render",e);$(document).off(t),$(document).on(t,()=>{const t=document.querySelector(`#${e} ${this.selectors.SUBMIT_BUTTON}`);t&&t.classList.add("ktlHidden")}),this.eventHandlers.set(`render-${e}`,t),waitSelector({selector:`#${e} ${this.selectors.SUBMIT_BUTTON}`,timeout:this.timeouts.BUTTON_WAIT}).then(e=>e&&e.classList.add("ktlHidden")).catch(()=>{})})}async _handleFormSubmission(e,t){t.disabled=!0,this._setFormInputsDisabled(e,!0);let n=[];try{n=await this._submitAutoForms(),this.onAutoFormsComplete&&this.onAutoFormsComplete(n),this._setFormInputsDisabled(e,!1),t.disabled=!1,await this._submitManualForm(e)}catch(r){errorHandler.handleError(r,{manualSubmitViewId:this.manualSubmitViewId,autoSubmitViewIds:this.autoSubmitViewIds,outcomes:n},"MultiFormCoordinator:HandleSubmission"),this._setFormInputsDisabled(e,!1),t.disabled=!1}}_validateForm(e,t){if(!t)return{isValid:!1,invalidInputs:[],errorMessage:`Form not found for ${e}`};const n=t.querySelectorAll("input, select, textarea"),r=Array.from(n).filter(e=>Array.from(e.classList).some(e=>e.startsWith("ktlNotValid_")));if(0===r.length)return{isValid:!0,invalidInputs:[],errorMessage:""};const o=r.map(e=>{const t=Array.from(e.classList).filter(e=>e.startsWith("ktlNotValid_")).join(", ");return`#${e.id||e.name} (${t})`}).join(", ");return{isValid:!1,invalidInputs:r,errorMessage:`Form validation failed for ${e}. Found ${r.length} invalid input(s): ${o}`}}async _submitAutoForms(){const e=[];for(const t of this.autoSubmitViewIds)if(this.submittedForms.has(t))e.push({success:!0,viewId:t,skipped:!0,reason:"Already submitted"});else try{const n=await this._submitSingleAutoForm(t);e.push(n),n.success&&this.submittedForms.add(t)}catch(e){throw this._isValidationError(e)||errorHandler.handleError(e,{manualSubmitViewId:this.manualSubmitViewId,autoSubmitViewIds:this.autoSubmitViewIds,failedViewId:t,submittedForms:Array.from(this.submittedForms)},"MultiFormCoordinator:SubmitAutoForms"),e}return e}async _submitSingleAutoForm(e){const t=document.getElementById(e);if(!t)throw new Error(`Auto submit view "${e}" not found`);const n=t.querySelector(this.selectors.FORM),r=t.querySelector(this.selectors.SUBMIT_BUTTON);if(!n||!r)throw new Error(`Form or submit button not found in auto view "${e}"`);try{this._setFormInputsDisabled(n,!1),r.disabled=!1;const t=this._validateForm(e,n);if(!t.isValid)throw console.error(`[MultiFormCoordinator] ${t.errorMessage}`),new Error(t.errorMessage);const o=this._waitForFormSubmitOutcome(e);r.click();const i=await o;return setVisibility(`#${e} ${this.selectors.SUCCESS_MESSAGE}`,!1),this._setFormInputsDisabled(n,!0),{success:!0,viewId:e,record:i.record||null,timestamp:(new Date).toISOString()}}catch(n){throw this._isValidationError(n)||errorHandler.handleError(n,{autoViewId:e,manualSubmitViewId:this.manualSubmitViewId,viewExists:!!t},"MultiFormCoordinator:SubmitSingleAutoForm"),n}}_waitForFormSubmitOutcome(e){return new Promise((t,n)=>{let r=!1,o=null,i=null,s=null;const a=()=>{r||(r=!0,o&&clearTimeout(o),i&&clearInterval(i),s&&s.disconnect())};o=setTimeout(()=>{a(),n(new Error(`Form submission timeout for ${e} after ${this.timeouts.FORM_SUBMIT}ms`))},this.timeouts.FORM_SUBMIT);const l=document.getElementById(e);if(!l)return a(),void n(new Error(`View element not found: ${e}`));const c=()=>{const r=l.querySelector(this.selectors.SUCCESS_MESSAGE);if(r)return a(),t({success:!0,record:null,view:e,message:r.textContent.trim()}),!0;const o=l.querySelector(this.selectors.ERROR_MESSAGE);if(o)return a(),n(new Error(`Form submission failed: ${o.textContent.trim()}`)),!0;const i=l.querySelectorAll('input.invalid, select.invalid, textarea.invalid, [aria-invalid="true"]');if(i.length>0){const e=Array.from(i).map(e=>{const t=e.closest(".kn-input")?.querySelector(".kn-label");return t?t.textContent.trim().replace("*","").trim():"Unknown field"}).filter((e,t,n)=>n.indexOf(e)===t).slice(0,3).join(", ");return a(),n(new Error(`Form validation failed: Required fields missing or invalid (${e})`)),!0}return!1};s=new MutationObserver(c),s.observe(l,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style","aria-invalid"]}),c(),setTimeout(c,this.timeouts.OUTCOME_POLL_INTERVAL),i=setInterval(()=>{r||c()},this.timeouts.OUTCOME_POLL_INTERVAL),this.eventHandlers.set(`submit-${e}`,a)})}async _submitManualForm(e){return new Promise((t,n)=>{setTimeout(()=>{try{$(e).submit(),this.closeModalAfterSubmit&&document.querySelector(this.selectors.MODAL)&&setTimeout(()=>{document.querySelector(this.selectors.MODAL_CLOSE)?.click()},this.timeouts.MODAL_CLOSE_DELAY),t()}catch(e){errorHandler.handleError(e,{manualSubmitViewId:this.manualSubmitViewId},"MultiFormCoordinator:SubmitManualForm"),n(e)}},this.timeouts.PRE_SUBMIT_DELAY)})}_setFormInputsDisabled(e,t){e&&e.querySelectorAll("input, select, textarea, button").forEach(e=>{e.disabled=t})}_cleanupPreviousHandler(e){e._multiSubmitHandler&&(e.removeEventListener("click",e._multiSubmitHandler),delete e._multiSubmitHandler);const t=e.closest("form");t&&t._multiFormSubmitHandler&&(t.removeEventListener("submit",t._multiFormSubmitHandler),delete t._multiFormSubmitHandler)}destroy(){const e=document.getElementById(this.manualSubmitViewId);if(e){const t=e.querySelector(this.selectors.FORM),n=e.querySelector(this.selectors.SUBMIT_BUTTON);n&&n._multiSubmitHandler&&(n.removeEventListener("click",n._multiSubmitHandler),delete n._multiSubmitHandler),t&&t._multiFormSubmitHandler&&(t.removeEventListener("submit",t._multiFormSubmitHandler),delete t._multiFormSubmitHandler)}this.eventHandlers.forEach(e=>{$(document).off(e)}),this.eventHandlers.clear(),this.submittedForms.clear(),this.isInitialized=!1}}function setupAutoFormSubmission(e,t,n,r=!1){const o=new MultiFormSubmissionCoordinator({manualSubmitViewId:e,autoSubmitViewIds:t,closeModalAfterSubmit:r});return o.initialize(n),o}async function addConnectionIdToRecord(e,t,n=null,r){const o=$(`#${e}`).length>0?$(`#${e}`):$(`#connection-form-view:has(input[value="${e}"])`),i=o.find(`#kn-input-field_${t}`),s=i.find("select"),a=n||getRecordID();i.addClass("ktlHidden");const l=e=>{s.val(e).trigger("liszt:updated")};await ktl.core.waitSelector(`${o.selector} #kn-input-field_${t} select option`,2e4);if(s.find("option").length>1)l(a);else{const{sceneIdAPI:e,viewIdAPI:t,clientPKField:o}=CONNECTION_FIELDS_OBJECT[r];try{const r=(await caAPI(e,t,n,{},"get",{},[],!1))[`${o}_raw`],a=i.find(".chzn-search input");a.trigger("focus").val(r).trigger("input");const c=setInterval(()=>{const e=s.find("option").filter((e,t)=>$(t).text()===r);e.length>0&&(l(e.val()),a.trigger("blur"),clearInterval(c),clearTimeout(d))},500),d=setTimeout(()=>{clearInterval(c),console.log(`Timeout: Could not find item "${r}" in the dropdown.`)},1e4)}catch(e){console.error("Error fetching data from API:",e)}}}function validateInputEmpty(e){const t=$(`#${e}`);return t.on("blur",function(){t.val()?removeClassFromSelector(t,"inputInvalid"):t.addClass("inputInvalid")}),!!t.val()||(t.addClass("inputInvalid").focus(),t[0].scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),!1)}function disableCellsByColHead(e,t){const n=document.getElementById(e);if(!n)return;const r=n.querySelector("table");if(!r)return;const o=r.querySelectorAll("thead th");let i=-1;o.forEach((e,n)=>{e.classList.contains(`field_${t}`)&&(i=n)}),-1!==i&&getAllTableRows(e,(e,t)=>{const n=t.children[i];n&&n.classList.add("disabled")})}function isInOfficeHours(e="08:30",t="16:30"){const n=e=>{const[t,n]=e.split(":").map(Number);return 60*t+n},r=n(e),o=n(t),i=new Date,s=60*i.getHours()+i.getMinutes();return 0!==i.getDay()&&6!==i.getDay()&&(r<=s&&s<=o)}function setupLocalStorageMinutes(e,t,n){const r=getRecordID();initSecureStorage(e),t.forEach(t=>{getTextArea(t).on("blur",function(){const t=getFieldId($(this));setSecureStorage(e,r,t,$(this).val())}),$(`#${t} .redactor-editor`).on("blur",function(){const t=getFieldId($(this).closest(".kn-input"));setSecureStorage(e,r,t,$(this).html())})}),ktl.core.waitSelector(`.kn-details-link a:contains("${n}")`,5e3).then(()=>{$(`.kn-details-link a:contains("${n}")`).on("click",function(n){n.preventDefault(),getSecureStorage(e,r).then(e=>{e&&reloadMinutes(t,e)})})})}function reloadMinutes(e,t){e.forEach(e=>{getTextArea(e).each(function(){const e=getFieldId($(this)),n=t[e];n&&$(`#${e}`).val(n)}),$(`#${e} .redactor-editor`).each(function(){const e=getFieldId($(this).closest(".kn-input")),n=t[e];n&&($(`#${e} .redactor-editor`).html(n),$(`#${e} textarea`).val(n))})})}function showHideGroup(e,t){const n=e.map(e=>waitSelector({selector:`#view_${e}`}));Promise.all(n).then(()=>{const n=`view_${e[0]}`,r=`showHide_${n}`,o=`.${r}`,i=`<a class="ktlShrinkLink" id="shrink-link_${r}">Shrink &nbsp;<span class="ktlArrow ktlUp" id="arrow_${r}">â—€</span></a>`;waitSelector({selector:`#${n} h2.kn-title`}).then(s=>{const a=s.textContent.trim(),l=`<div class="ktlHideShowButton" id="${r}">${a} &nbsp;<span class="ktlArrow ktlDown" id="arrow_${r}">â—€</span></div>`,c=document.getElementById(n);let d=document.getElementById(`${n}_wrapper`);if(document.getElementById(r)||(s.style.display="none",c&&c.insertAdjacentHTML("beforebegin",l),wrapContentForShowHideGroup(e,r),d=document.getElementById(`${n}_wrapper`),d&&!document.getElementById(`shrink-link_${r}`)&&d.insertAdjacentHTML("beforeend",i)),c){const e=c.querySelector(".kn-description");if(e&&""!==e.textContent.trim()&&!document.querySelector(`${o} .kn-description`)){const t=document.querySelector(o);t&&(t.insertBefore(e,t.firstChild),e.style.display="")}}showHideViewGroupContent(r,1e3,t),d&&(d.style.marginTop="13px")})}).catch(t=>{isDeveloper&&console.warn("view/s missing from page",e,t)})}function wrapContentForShowHideGroup(e,t){const n=`view_${e[0]}`,r=document.getElementById(n);if(document.getElementById(`${n}_wrapper`))return;const o=document.createElement("section");o.className=`${t} ktlBoxWithBorder ktlHideShowSection`,o.id=`${n}_wrapper`,o.style.display="none";const i=document.createElement("div");i.className="view-wrapper",r.parentNode.insertBefore(o,r),o.appendChild(i),i.appendChild(r),e.slice(1).forEach(e=>{const t=document.getElementById(`view_${e}`);t&&i.appendChild(t)})}function showHideViewGroupContent(e,t,n=!1){const r=document.getElementById(e),o=document.getElementById(`arrow_${e}`),i=document.querySelector(`.${e}`),s=document.getElementById(`shrink-link_${e}`);function a(e,t=600,n="block"){const r="none"===window.getComputedStyle(e).display,o=function(e){const t=window.getComputedStyle(e);return{paddingTop:t.paddingTop,paddingBottom:t.paddingBottom,marginTop:t.marginTop,marginBottom:t.marginBottom}}(e);if(r){e.style.removeProperty("display");let r=window.getComputedStyle(e).display;"none"===r&&(r=n),e.style.display=r,e.style.overflow="hidden",e.style.height="0px",e.style.paddingTop="0px",e.style.paddingBottom="0px",e.style.marginTop="13px",e.style.marginBottom="0px",e.offsetHeight,requestAnimationFrame(()=>{e.style.transition=[`height ${t}ms cubic-bezier(0.33,0,0.2,1)`,`padding-top ${t}ms cubic-bezier(0.33,0,0.2,1)`,`padding-bottom ${t}ms cubic-bezier(0.33,0,0.2,1)`,`margin-top ${t}ms cubic-bezier(0.33,0,0.2,1)`,`margin-bottom ${t}ms cubic-bezier(0.33,0,0.2,1)`].join(", "),e.style.height=e.scrollHeight+"px",e.style.paddingTop=o.paddingTop,e.style.paddingBottom=o.paddingBottom,e.style.marginTop=o.marginTop,e.style.marginBottom=o.marginBottom}),setTimeout(()=>{e.style.transition="",e.style.height="auto",e.style.overflow="",e.style.paddingTop="",e.style.paddingBottom="",e.style.marginTop="13px",e.style.marginBottom="";let t=e.closest('[id^="view_"]');if(t){const e=t.querySelectorAll(".kn-input-signature"),n=t.id;e.length&&window.Knack&&Knack.views&&Knack.views[n]&&"function"==typeof Knack.views[n].renderSignatures&&Knack.views[n].renderSignatures();const r=t.querySelector(".kn-table-group td"),o=t.querySelectorAll('th:not([style*="display: none"])');if(r&&o.length){const e=o.length;parseInt(r.getAttribute("colspan"),10)!==e&&r.setAttribute("colspan",e)}}},t)}else e.style.height=e.scrollHeight+"px",e.style.overflow="hidden",e.offsetHeight,requestAnimationFrame(()=>{e.style.transition=[`height ${t}ms cubic-bezier(0.33,0,0.2,1)`,`padding-top ${t}ms cubic-bezier(0.33,0,0.2,1)`,`padding-bottom ${t}ms cubic-bezier(0.33,0,0.2,1)`,`margin-top ${t}ms cubic-bezier(0.33,0,0.2,1)`,`margin-bottom ${t}ms cubic-bezier(0.33,0,0.2,1)`].join(", "),e.style.height="0px",e.style.paddingTop="0px",e.style.paddingBottom="0px",e.style.marginTop="13px",e.style.marginBottom="0px"}),setTimeout(()=>{e.style.display="none",e.style.transition="",e.style.height="",e.style.overflow="",e.style.paddingTop="",e.style.paddingBottom="",e.style.marginTop="13px",e.style.marginBottom=""},t)}r&&o&&i&&(r.onclick=function(){a(i,t,n?"flex":"block"),o.classList.toggle("ktlDown"),o.classList.toggle("ktlUp"),r.classList.toggle("ktlActive"),n&&"none"!==window.getComputedStyle(i).display&&(i.style.display="flex")},s&&(s.onclick=function(){!function(e,t=400){"none"!==window.getComputedStyle(e).display&&(e.style.height=e.scrollHeight+"px",e.style.overflow="hidden",e.offsetHeight,requestAnimationFrame(()=>{e.style.transition=`height ${t}ms cubic-bezier(0.33,0,0.2,1)`,e.style.height="0px"}),setTimeout(()=>{e.style.display="none",e.style.transition="",e.style.height="",e.style.overflow=""},t))}(i,t),o.classList.toggle("ktlDown"),o.classList.toggle("ktlUp"),r.classList.remove("ktlActive")}))}function addCheckboxes(e,t,n=!0){const r=document.getElementById(e);if(!r)return;const o=r.querySelector("table.kn-table");if(!o)return;const i=o.querySelector("thead tr"),s=o.querySelectorAll("tbody tr:not(.kn-tr-nodata)");let a=i.querySelector("th.header-checkbox-th");a||(a=document.createElement("th"),a.className="header-checkbox-th"),i.firstChild!==a&&i.insertBefore(a,i.firstChild);let l=null;if(n)l=a.querySelector('input[type="checkbox"]'),l||(l=document.createElement("input"),l.type="checkbox",l.className="header-checkbox",a.appendChild(l));else{const e=a.querySelector('input[type="checkbox"]');e&&e.remove()}s.forEach(n=>{let r=n.querySelector("td.row-checkbox-td");if(!r){r=document.createElement("td"),r.className="row-checkbox-td",r.style.maxWidth="32px";const i=document.createElement("input");i.type="checkbox",i.className="row-checkbox",r.appendChild(i),n.insertBefore(r,n.firstChild),addInputEventListener(i,function(r){const a=Array.from(o.querySelectorAll(`tbody tr:not(.kn-tr-nodata) ${INPUT_CHECKBOX_SELECTOR}`)).every(e=>e.checked);if(l&&(l.checked=a),"function"==typeof t){const a=o.querySelectorAll('tbody tr:not(.kn-tr-nodata) input[type="checkbox"].row-checkbox:checked').length;t({type:"row",checked:i.checked,row:n,viewId:e,checkedCount:a,totalCount:s.length,headerChecked:!!l?.checked,event:r||null})}},{events:"change"})}}),l&&addInputEventListener(l,function(n){const r=l.checked;if(s.forEach(e=>{const t=e.querySelector(`td.row-checkbox-td ${INPUT_CHECKBOX_SELECTOR}`);t&&(t.checked=r)}),"function"==typeof t){const o=r?s.length:0;t({type:"header",checked:r,viewId:e,checkedCount:o,totalCount:s.length,headerChecked:!!l.checked,event:n||null})}},{events:"change"})}function addCheckboxesToHeaders(e,t){const n=document.getElementById(e);if(!n)return;const r=n.querySelector("table.kn-table");if(!r)return;const o=r.querySelector("thead tr");if(o&&(Array.from(o.children).forEach(e=>{if(!Array.from(e.classList).find(e=>e.startsWith("field_")))return;let t=e.querySelector(".header-flex-wrap");if(!t){for(t=document.createElement("span"),t.className="header-flex-wrap",t.style.display="inline-flex",t.style.alignItems="center",t.style.gap="4px";e.firstChild;)t.appendChild(e.firstChild);e.appendChild(t)}if(t.querySelector(INPUT_CHECKBOX_SELECTOR)){const e=t.querySelector(INPUT_CHECKBOX_SELECTOR);e!==t.firstChild&&t.insertBefore(e,t.firstChild),e.style.verticalAlign="middle",e.style.marginRight="6px"}else{const e=document.createElement("input");e.type="checkbox",e.className="header-checkbox",e.style.verticalAlign="middle",e.style.marginRight="6px",t.insertBefore(e,t.firstChild)}}),"function"==typeof t)){const e=o.querySelectorAll(`${INPUT_CHECKBOX_SELECTOR}.header-checkbox`);addInputEventListener(e,function(){const n=Array.from(e).filter(e=>e.checked).map(e=>{const t=e.closest("th");if(!t)return null;const n=Array.from(t.classList).find(e=>e.startsWith("field_"));return n?n.replace("field_",""):null}).filter(Boolean);t(n)},{events:"change"})}}function prependTextToGroupBy(e,t,n=1){$(`#${t} .kn-group-level-${n} td`).prepend(`${e} `)}function getTableRows(e,t,n=!1,r=!1){if(!e)return;const o=$(`#${e} table`);let i=o.find("tbody tr:not(.kn-table-group)");if(n){const e=o.find("thead tr");i=i.add(e)}if(r){const e=o.find("tbody tr.kn-table-group");i=i.add(e)}i.each((e,n)=>{t(e,$(n))})}function extractPostcode(e){if(!e)return"";const t=removeHtml(e).trim().match(/[A-Z]{1,2}\d{1,2}[A-Z]?\s*\d[A-Z]{2}$/i);return t?t[0].toUpperCase():""}function fileViewer(e,t){return OFFICE_EXTENSIONS.includes(e)?`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(t)}`:"pdf"===e?`https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(t)}`:`https://docs.google.com/gview?url=${encodeURIComponent(t)}`}function weeksBetween(e,t){var n=Math.abs(t-e);return Math.ceil(n/6048e5)}function convertToDateObj(e){var t=e.split("/");return new Date(t[2],t[1]-1,t[0])}function isElementVisible(e,t=document){const n=t&&"function"==typeof t.querySelector?t:document,r="string"==typeof e?n.querySelector(e):e;if(!r||!r.isConnected)return!1;const o=window.getComputedStyle(r);return"none"!==o.display&&"hidden"!==o.visibility&&null!==r.offsetParent}function areAllInputsEmpty(e,t=[]){if(!e)return!0;const n=$(`#${e}`),r=n.find('input[type="text"]:not(.search-field input[type="text"]), input[type="number"], input[type="email"], textarea'),o=n.find("select");for(let e=0;e<r.length;e++){const n=$(r[e]),o=n.attr("id");if(t.includes(o))continue;if(""!==n.val().trim())return!1}for(let e=0;e<o.length;e++){const n=$(o[e]),r=n.attr("id");if(t.includes(r))continue;const i=n.find("option:selected");if(i.length>0&&""!==i.val())return!1}const i=n.find('input[type="radio"]:checked, input[type="checkbox"]:checked');for(let e=0;e<i.length;e++){const n=$(i[e]).attr("name").split("-").pop();if(!t.includes(n))return!1}return!0}const isInputEmpty=(e,t)=>{const n="string"==typeof e?document.getElementById(e):e;if(!n)return console.warn("isInputEmpty: element not found for",e),null;switch(t){case"choice":return 0===n.querySelectorAll("input:checked").length;case"textarea":{const e=n.querySelector('textarea, input[type="text"], input[type="number"], input[type="email"]');return!e||""===e.value.trim()}case"dropdown":{const e=n.querySelector("select"),t=e?e.value:"";return""===t||null===t}default:return console.warn(`isInputEmpty: unknown field type "${t}"`),!1}};function replaceValueInTD(e,t,n,r){const o=document.getElementById(e);if(!o)return;const i=o.querySelector("table");if(!i)return;const s=getIndexOfColumnHeader(i,t);-1!==s&&getAllTableRows(e,(e,t)=>{const o=t.querySelectorAll("td")[s];o&&o.textContent.trim().includes(n)&&(o.textContent=r)})}function filterSelectByText(e,t,n){$("#"+e+`_field_${t}_chzn li`).each(function(){-1!=$(this).text().indexOf(n)?$(this).show():$(this).hide()})}async function triggerWebhook(e,t,n="Unnamed Webhook",r=!1){if(!e.startsWith("https://")){const t=`Invalid webhook URL: ${e} in webhook: ${n}`;return console.error(t),{error:t}}let o=null;try{const i=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",userToken:r?Knack.getUserToken():""},body:JSON.stringify(t)});if(o=await(async e=>{const t=e.headers.get("Content-Type");return t&&t.includes("application/json")?await e.json():await e.text()})(i),!i.ok)throw console.error(`Webhook (${n}) failed with status ${i.status}:`,o),new Error(`Network response was not ok: ${o}`);return console.log(`Webhook (${n}) sent successfully with response:`,o),{success:!0,data:o,error:null}}catch(e){throw console.error(`Error triggering webhook: ${n}`,e),{success:!1,data:o,error:e.message,webhookName:n}}}async function delayAPIPut(e=null,t=null,n=[],r,o=[],i=500){for(var s=0;s<n.length;s++)caAPI(e,t,n[s],r,"put",{},o,!0),await API_TIMER(i)}class KnackAPI{constructor(e={}){this.options={showSpinner:void 0!==e.showSpinner&&e.showSpinner,timeout:e.timeout||6e4,debug:e.debug||!1,developerOnly:void 0===e.developerOnly||e.developerOnly,developerRoles:e.developerRoles||["Developer"]},this._initLogSettings()}async getRecords(e,t,n={}){const{filters:r,sorters:o,page:i,rows:s,rawResponse:a=!1,timeout:l}=n;let c={};r&&(c={...c,...this.buildFilters(r)},this._log("Filters",c)),o&&(c={...c,...this.buildSorters(o)},this._log("Sorters",c)),i&&(c.page=i),s&&(c.rows_per_page=s);const d=this._formatApiUrl(e,t)+this._formatParams(c);this._log("Getting records",d);const{controller:u,signal:m,clear:f}=this._createAbortController(l);try{const e=await this._executeRequest(d,{method:"GET",headers:this._buildHeaders()},m);return a?e:e.records}finally{f()}}async getAllRecords(e,t,n={}){const{filters:r,sorters:o,rows:i=1e3,onProgress:s}=n,a=await this.getRecords(e,t,{filters:r,sorters:o,page:1,rows:i,rawResponse:!0}),{total_pages:l,total_records:c,records:d}=a;if(this._log("Fetching all records",{total_pages:l,total_records:c}),0===c)return[];const u=[...d];for(let n=2;n<=l;n++){const a=await this.getRecords(e,t,{filters:r,sorters:o,page:n,rows:i,rawResponse:!0});if(u.push(...a.records),s){s({page:n,total_pages:l,records_loaded:u.length,total_records:c,percentage:Math.round(n/l*100)})}}return u}async getRecordChildren(e,t,n,r,o={}){const{filters:i,sorters:s,page:a,rows:l,rawResponse:c=!1,timeout:d}=o;let u={};i&&(u={...u,...this.buildFilters(i)}),s&&(u={...u,...this.buildSorters(s)}),a&&(u.page=a),l&&(u.rows_per_page=l);const m=this._formatApiUrl(e,t);u[`${r}_id`]=n;const f=m+this._formatParams(u);this._log("Getting child records",f);const{controller:p,signal:h,clear:g}=this._createAbortController(d);try{const e=await this._executeRequest(f,{method:"GET",headers:this._buildHeaders()},h);return c?e:e.records}finally{g()}}async getAllRecordChildren(e,t,n,r,o={}){const{filters:i,sorters:s,rows:a=1e3,onProgress:l}=o,c=await this.getRecordChildren(e,t,n,r,{filters:i,sorters:s,page:1,rows:a,rawResponse:!0}),{total_pages:d,total_records:u,records:m}=c;if(this._log("Fetching all child records",{total_pages:d,total_records:u}),0===u)return[];const f=[...m];for(let o=2;o<=d;o++){const c=await this.getRecordChildren(e,t,n,r,{filters:i,sorters:s,page:o,rows:a,rawResponse:!0});if(f.push(...c.records),l){l({page:o,total_pages:d,records_loaded:f.length,total_records:u,percentage:Math.round(o/d*100)})}}return f}async createRecord(e,t,n,r,o){const i=this._formatApiUrl(e,t);this._log("Creating record",{url:i,data:n});const{controller:s,signal:a,clear:l}=this._createAbortController(o);try{const e=await this._executeRequest(i,{method:"POST",headers:this._buildHeaders(),body:JSON.stringify(n)},a);return r&&await this.refreshView(r),e}finally{l()}}async updateRecord(e,t,n,r,o,i){const s=this._formatApiUrl(e,t,n);this._log("Updating record",{url:s,data:r});const{controller:a,signal:l,clear:c}=this._createAbortController(i);try{const i=await this._executeRequest(s,{method:"PUT",headers:this._buildHeaders(),body:JSON.stringify(r)},l);try{const o=i?.record??i,s=Object.keys(r||{}),a=[];for(const e of s){const t=r[e],n=this._extractResponseValueFromRecord(o,e);void 0!==n&&this._valuesEffectivelyEqual(n,t)||a.push({field:e,sent:t,received:n})}if(a.length>0){const r=a.map(e=>e.field).join(", ");this._log("Field update verification: failures detected",{sceneId:e,viewId:t,recordId:n,failedFields:r,failedCount:a.length},"warn")}}catch(e){this._log("Field update verification error",e,"error")}return o&&await this.refreshView(o),i}finally{c()}}async updateRecordsWithDelay(e,t,n,r,o,i=300,s){const a=[];for(let o=0;o<n.length;o++)try{const l=await this.updateRecord(e,t,n[o],r,[],s);a.push(l),o<n.length-1&&await new Promise(e=>setTimeout(e,i))}catch(e){a.push({error:e,recordId:n[o]})}return o&&await this.refreshView(o),a}async deleteRecord(e,t,n,r,o){const i=this._formatApiUrl(e,t,n);this._log("Deleting record",i);const{controller:s,signal:a,clear:l}=this._createAbortController(o);try{const e=await this._executeRequest(i,{method:"DELETE",headers:this._buildHeaders()},a);return r&&await this.refreshView(r),e}finally{l()}}async refreshView(e){if(Array.isArray(e)){const t=e.map(e=>this._refreshSingleView(e));return Promise.all(t)}return this._refreshSingleView(e)}async getRecord(e,t,n){if(!e||!t||!n)throw new Error("sceneId, viewId, and recordId are required to fetch a record.");const r=this._formatApiUrl(e,t,n);this._log("Fetching record by ID",r);try{return await this._executeRequest(r,{method:"GET",headers:this._buildHeaders()})}catch(e){throw console.error("Error fetching record by ID:",e),e}}forceLog(e,t){this._log(e,t,!0)}isDeveloper(){return this._canShowLogs}setDebug(e){this.options.debug=e,this._log("Debug mode set to",e)}_log(e,t,n="info",r=!1){if(this.options.debug&&(this._canShowLogs||r)){const r=`[KnackAPI] ${e}`;switch(n){case"warn":console.warn(r,t||"");break;case"error":console.error(r,t||"");break;default:console.log(r,t||"")}}}_toggleSpinner(e){this.options.showSpinner&&(e?Knack.showSpinner():Knack.hideSpinner())}_checkKnack(){if("undefined"==typeof Knack)throw new Error("Knack is not available")}_createAbortController(e){const t=new AbortController,n=e||this.options.timeout,r=setTimeout(()=>{t.abort()},n);return{controller:t,signal:t.signal,clear:()=>clearTimeout(r)}}_getAuthToken(){return Knack.getUserToken()}_formatApiUrl(e,t,n=null){let r=`${Knack.api_dev}/pages/${e}/views/${t}`;return r+=n?`/records/${n}`:"/records",r}async _handleResponse(e){if(!e.ok){const t=await e.json().catch(()=>({message:"Unknown error"}));throw new Error(`API error ${e.status}: ${t.message||e.statusText}`)}return await e.json()}async _executeRequest(e,t,n){this._checkKnack(),this._toggleSpinner(!0);try{const r=await fetch(e,{...t,signal:n}),o=await this._handleResponse(r);return this._log("API response",o),o}catch(e){if("AbortError"===e.name)throw new Error("Request timeout");throw e}finally{this._toggleSpinner(!1)}}_buildHeaders(e=!0){const t={"Content-Type":"application/json","X-Knack-Application-ID":Knack.application_id,"X-Knack-REST-API-Key":"knack"};if(e){const e=this._getAuthToken();e&&(t.Authorization=e)}return t}_initLogSettings(){if(this._canShowLogs=!1,this.options.developerOnly)try{const e=Knack.getUserRoleNames();this._canShowLogs=this.options.developerRoles.some(t=>e.includes(t))}catch(e){this._canShowLogs=!1,console.warn("KnackAPI: Could not determine user role, defaulting to no logs")}else this._canShowLogs=!0}buildFilters(e){if(!e)return{};if(e.match&&e.rules)return{filters:JSON.stringify(e)};Array.isArray(e)||(e=[e]);const t={};return e.forEach((e,n)=>{const r=`filters[${n}]`;e.field&&(t[`${r}[field]`]=e.field),e.operator&&(t[`${r}[operator]`]=e.operator),void 0!==e.value&&(Array.isArray(e.value)?e.value.forEach((e,n)=>{t[`${r}[value][${n}]`]=e}):t[`${r}[value]`]=e.value),e.type&&(t[`${r}[type]`]=e.type)}),t}buildSorters(e){if(!e)return{};Array.isArray(e)||(e=[e]);const t={};return e.forEach((e,n)=>{const r=`sort[${n}]`;e.field&&(t[`${r}[field]`]=e.field),e.direction?t[`${r}[direction]`]=e.direction:t[`${r}[direction]`]="asc"}),t}_formatParams(e){if(!e||0===Object.keys(e).length)return"";const t=new URLSearchParams;return Object.entries(e).forEach(([e,n])=>{t.append(e,n)}),`?${t.toString()}`}_refreshSingleView(e){return new Promise((t,n)=>{try{const r=Knack.views[e];if(!r||!r.model||!r.model.view)return this._log("View not found or invalid",e),n(new Error("View not found or invalid"));const o=r.model.view.type;if("form"===o)return"function"==typeof r.reloadForm?(r.reloadForm(),r.render(),this._log("Form view reloaded successfully",e),t()):(this._log("reloadForm not available on form view",e),n(new Error("reloadForm not available")));if("calendar"===o)return"function"==typeof r.renderRecords?(r.renderRecords(),Knack.hideSpinner?.(),this._log("Calendar view refreshed via renderRecords",e),t()):(this._log("renderRecords not available on calendar view",e),n(new Error("renderRecords not available")));if("search"===o)return"function"==typeof r.renderResults?(r.renderResults(),this._log("Search view refreshed via renderResults",e),t()):(this._log("renderResults not available on search view",e),n(new Error("renderResults not available")));if("menu"===o)return"function"==typeof r.postRender?(r.postRender(),this._log("Menu view refreshed via postRender",e),t()):(this._log("postRender not available on menu view",e),n(new Error("postRender not available")));r.model.fetch({success:()=>{"details"===o&&(r.render(),r.postRender?.(),this._log("Details view refreshed after fetch",e)),"table"===o&&(r.renderResults?.(),this._log("Table view refreshed via renderResults",e)),t()},error:(t,r)=>{this._log("Error fetching view model",{viewId:e,error:r}),n(r)}})}catch(t){this._log("Error in _refreshSingleView()",{viewId:e,error:t}),n(t)}})}formatConnectedFields(e,t){return Array.isArray(e)||(e=[e]),e.map(e=>{const n={...e};return t.forEach(t=>{e[`${t}_raw`]&&(n[t]=Array.isArray(e[`${t}_raw`])?e[`${t}_raw`].map(e=>({...e})):{...e[`${t}_raw`]})}),n})}_extractResponseValueFromRecord(e,t){if(!e||"object"!=typeof e)return;if(Object.prototype.hasOwnProperty.call(e,t))return e[t];const n=`${t}_raw`;return Object.prototype.hasOwnProperty.call(e,n)?e[n]:void 0}_normaliseForCompare(e){if(null==e)return null;if(Array.isArray(e)){return e.map(e=>e&&"object"==typeof e?e.id??e.value??JSON.stringify(e):String(e)).sort().join("|")}if("object"==typeof e){return Object.keys(e).sort().map(t=>`${t}:${this._normaliseForCompare(e[t])}`).join("|")}return String(e).trim()}_valuesEffectivelyEqual(e,t){return this._normaliseForCompare(e)===this._normaliseForCompare(t)}}async function caAPI(e=null,t=null,n=null,r={},o="",i={},s=[],a=!1){return new Promise(function(l,c){if(o=o.toUpperCase(),null===t||"PUT"!==o&&"GET"!==o&&"POST"!==o&&"DELETE"!==o)return void c(new Error("Called caAPI with invalid parameters: view = "+t+", recId = "+n+", reqType = "+o));const d=setTimeout(function(){if(m)return clearInterval(m),void c(new Error("Called caAPI with invalid scene key"))},5e3);let u=e.startsWith("scene_")?e:Knack.scenes.getBySlug(e).attributes.key,m=setInterval(function(){if(u){clearInterval(m),m=null,clearTimeout(d);let f=`https://api.knack.com/v1/pages/${u}/views/${t}/records/`;n&&!e.startsWith("scene_")?f=`${f}?${e}_id=${n}`:n&&e.startsWith("scene_")?f=`${f}${n}`:$.isEmptyObject(i)||(f=`${f}?filters=${encodeURIComponent(JSON.stringify(i))}`),a&&Knack.showSpinner(),ktl.account.isDeveloper()&&(console.log("apiURL =",f),console.log(`caAPI - sceneKey: ${e}, caAPI - viewId: ${t}, recId: ${n}, requestType: ${o}, apiData: ${JSON.stringify(r)}, apiFilter: apiFilter: ${JSON.stringify(i)}`)),$.ajax({url:f,type:o,crossDomain:!0,retryLimit:4,headers:{Authorization:Knack.getUserToken(),"X-Knack-Application-Id":Knack.application_id,"X-Knack-REST-API-Key":"knack","Content-Type":"application/json","Access-Control-Allow-Origin":"*.knack.com"},data:JSON.stringify(r),success:function(e,t,n){Knack.hideSpinner(),ktl.account.isDeveloper()&&(ktl.log.clog("green","caAPI data : "),console.log(e)),0===s.length?l(e):ktl.views.refreshViewArray(s).then(function(){l(e)})},error:function(e){if(ktl.log.clog("purple","caAPI error:"),console.log("retries:",this.retryLimit,"\nresponse:",e),this.retryLimit-- >0){const e=this;return void setTimeout(function(){$.ajax(e)},500)}console.log("retry limit reached"),Knack.hideSpinner(),e.caller="caAPI",e.viewId=t,c(e)}})}else u=e.startsWith("scene_")?e:Knack.scenes.getBySlug(e).attributes.key},100)})}function getNestedValue(e,t){return t.split(".").reduce((e,t)=>e?.[t],e)}function removeHtml(e){const t=document.createElement("div");return t.innerHTML=e,t.textContent}function findElementByText(e,t=document,n={}){const{tag:r,class:o}=n,i=r?t.querySelectorAll(r):t.querySelectorAll("*");for(let t of i){if((!o||o.split(/\s+/).every(e=>t.classList.contains(e)))&&t.textContent.trim()===e)return t}return console.warn(`[findElementByText] No element found with text "${e}"`+(r?`, tag "${r}"`:"")+(o?`, class "${o}"`:"")),null}function getSelectedRadioValue(e){const t=`kn-input-field_${e}`,n=document.getElementById(t),r=n?.querySelector('input[type="radio"]:checked');return r?.value?.trim()||""}function replaceTextRegex(e,t,n,r=!1){$("number"==typeof e?`td.field_${e}`:e).each(function(){const e=$(this).text(),o=r?e.replaceAll(t,n):e.replace(t,n);$(this).text(o)})}function showHideMsgBasedOnSelect(e,t,n,r,o=!1){const i=Array.isArray(t)?t:[t],s=Array.isArray(n)?n:[n];const a=()=>{toggleMessage(i.some(t=>s.includes(function(t){if(o){const n=document.querySelector(`#${e}_field_${t}_chzn li.result-selected`);return n?n.textContent.trim():""}{const n=document.getElementById(`${e}-field_${t}`);return n?n.value:""}}(t))),r)};i.forEach(t=>{const n=document.getElementById(`${e}-field_${t}`);n?addInputEventListener(n,a,{runOnInit:!0}):console.error(`Select element not found: ${e}-field_${t}`)})}function showHideMsgBasedOnRadios(e,t,n,r,o,i="any"){let s,a,l;if(s="object"==typeof e&&null!==e&&(e.hasOwnProperty("fieldIds")||e.hasOwnProperty("selector")||e.hasOwnProperty("mode"))?Object.assign({fieldIds:null,valuesToMatch:null,selector:null,callback:null,params:null,mode:"any"},e):{fieldIds:e,valuesToMatch:t,selector:n,callback:r,params:o,mode:i},s.fieldIDs||s.fieldID)return void console.error('[showHideMsgBasedOnRadios] Deprecated parameter "fieldIDs"/"fieldID" used; please pass "fieldIds" only.');let c="map"===s.mode||"object"==typeof s.fieldIds&&!Array.isArray(s.fieldIds);if(!s.fieldIds)return void console.error('[showHideMsgBasedOnRadios] Missing required parameter "fieldIds". Example: showHideMsgBasedOnRadios([123], "Yes", "#msg")');if(!s.selector)return void console.error('[showHideMsgBasedOnRadios] Missing required parameter "selector". Example: showHideMsgBasedOnRadios([123], "Yes", "#msg")');if(!document.querySelector(s.selector))return void console.error(`Message element not found: ${s.selector}`);const d=()=>{let e=!1;if(c)e=Object.entries(s.fieldIds).every(([e,t])=>{const n=document.querySelector(`#kn-input-field_${e} input[type="radio"]:checked`);return n&&n.value===t});else{a=Array.isArray(s.fieldIds)?s.fieldIds:[s.fieldIds],l=Array.isArray(s.valuesToMatch)?s.valuesToMatch:[s.valuesToMatch];const t=a.map(e=>{const t=document.querySelector(`#kn-input-field_${e} ${INPUT_RADIO_CHECKED_SELECTOR}`);return t&&l.includes(t.value)});e="all"===s.mode?t.every(Boolean):t.some(Boolean)}toggleMessage(e,s.selector),s.callback&&"function"==typeof s.callback&&s.callback(e,s.params)};c?Object.keys(s.fieldIds).forEach(e=>{document.querySelectorAll(`#kn-input-field_${e} input[type="radio"]`).forEach(e=>{addInputEventListener(e,d,{runOnInit:!0})})}):(a=Array.isArray(s.fieldIds)?s.fieldIds:[s.fieldIds],a.forEach(e=>{document.querySelectorAll(`#kn-input-field_${e} input[type="radio"]`).forEach(e=>{addInputEventListener(e,d,{runOnInit:!0})})}))}function showHideEleBasedOnRadios(e,t,n,r=!1){const o=`#kn-input-field_${e}`;0!==$(o).length?0!==$(n).length?$(o).change(function(){const e=$(`${o} :checked`).val(),i=r?-1!==$.inArray(e,t):e==t;$(n).toggle(i)}).change():console.error(`Target selector "${n}" not found on the page.`):console.error(`Field with ID ${e} not found on the page.`)}function showHideEleBasedOnString(e,t){Object.entries(t).forEach(([t,n])=>{const r=e.includes(t);$(n).toggle(r)})}function showNotification(e){const t={target:null,message:"",backgroundColor:"",className:"",delay:2e3,fadeTime:500,styles:{},onShow:null,onHide:null,...e},n="string"==typeof t.target?document.querySelector(t.target):t.target;if(!n)return console.error("Target element not found:",t.target),null;const r=getComputedStyle(n).zIndex;"auto"!==r&&"0"!==r||(n.style.position=n.style.position||"relative",n.style.zIndex="1");const o=document.createElement("div");let i=[];Array.isArray(t.className)?i=t.className.flatMap(e=>e.split(" ")):"string"==typeof t.className&&t.className.trim()&&(i=t.className.trim().split(/\s+/)),o.classList.add("custom-notification",...i);const s=["color","fontWeight","fontSize","lineHeight","textAlign"];(Array.isArray(t.message)?t.message:[t.message]).forEach(e=>{const n=document.createElement("p");n.innerHTML=e,s.forEach(e=>{t.styles?.[e]&&(n.style[e]=t.styles[e])}),o.appendChild(n)});const a={backgroundColor:t.backgroundColor,opacity:"1",transition:`opacity ${t.fadeTime}ms ease`};return Object.assign(o.style,a),Object.assign(o.style,t.styles),n.appendChild(o),"function"==typeof t.onShow&&t.onShow(o),t.delay>0&&setTimeout(()=>{o.style.opacity="0",setTimeout(()=>{o.parentNode&&(o.parentNode.removeChild(o),"auto"!==r&&"0"!==r||(n.style.zIndex=r),"function"==typeof t.onHide&&t.onHide())},t.fadeTime)},t.delay),o}const isNodeList=e=>NodeList.prototype.isPrototypeOf(e),isjQueryInstance=e=>window.jQuery&&e instanceof window.jQuery;function normaliseInputs(e){return e?"string"==typeof e?Array.from(document.querySelectorAll(e)):isjQueryInstance(e)?e.toArray():Array.isArray(e)?e:isNodeList(e)?Array.from(e):[e]:[]}function cssEscape(e){return"undefined"!=typeof CSS&&CSS.escape?CSS.escape(e):String(e).replace(/([^a-zA-Z0-9_\-])/g,"\\$1")}function clearInput(e,t=!1){normaliseInputs(e).forEach(e=>{if(!e)return;const n=e.matches&&e.matches("input, select, textarea")?[e]:Array.from(e.querySelectorAll("input, select, textarea"));if(!n.length)return;const r=new Set;n.forEach(n=>{if(!n)return;(()=>{if("radio"!==n.type||!n.name)return[n];if(r.has(n.name))return[];r.add(n.name);const t=e.querySelectorAll?e.querySelectorAll(`${INPUT_RADIO_SELECTOR}[name="${cssEscape(n.name)}"]`):[];if(t.length)return Array.from(t);const o=document.querySelectorAll(`${INPUT_RADIO_SELECTOR}[name="${cssEscape(n.name)}"]`);return o.length?Array.from(o):[n]})().forEach(e=>{const n="checkbox"===e.type||"radio"===e.type?e.checked:""!==e.value;if("checkbox"===e.type||"radio"===e.type)e.checked=!1;else if("SELECT"===e.tagName){if(e.multiple?Array.from(e.options).forEach(e=>e.selected=!1):e.selectedIndex=-1,"undefined"!=typeof window&&window.jQuery){const t=$(e);t.data("chosen")&&t.trigger("liszt:updated")}}else e.value="";t&&n&&(e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})))})})})}function removeOpsFromSelect(e,t){return!!$.isArray(t)&&($(t).each(function(t,n){$(`${e} option`).filter(`[value="${n}"]`).remove()}),!0)}function removeFrmRadioCheckBox(e,t){return!!$.isArray(t)&&($(t).each(function(t,n){removeElement(`#kn-input-field_${e} .control:contains("${n}")`)}),!0)}function changeRadioButtonLabel(e,t,n){const r=$(`#kn-input-field_${e}`).find("label.option.radio").filter(function(){return $(this).text().trim()===t}),o=r.find("input").detach();r.text(` ${n}`),r.prepend(o)}function setupFieldStatus(e,t=!1){const n=document.querySelectorAll(`.field_${e}`);n.length&&n.forEach(e=>{const n=e.textContent.trim();t&&n.includes("Not")?e.style.backgroundColor="var(--warning)":n.includes("Not")||t||(e.style.backgroundColor="var(--success)")})}function removeNull(e){removeElement(`span.${e}:contains("null")`)}function selectFromSelect(e,t){$(`${e} option[value="${t}"]`).length>0?$(`${e} option[value="${t}"]`).prop("selected",!0):console.error(`Option "${t}" does not exist in the dropdown with ID "${e}".`)}function selectFromConx(e,t,n){$("#"+e+`-field_${t} option`).each(function(){if($(this).text()==n)return selectFromSelect("#"+e+`-field_${t}`,$(this).val()),!1})}function addPlaceholderToInput(e,t){const n=document.getElementById(`field_${e}`);n&&n.setAttribute("placeholder",t)}async function waitGetValueFromDetail({viewId:e,fieldIds:t,delay:n=2e4,returnHtml:r=!1}){const o=Array.isArray(t)?t:[t],i={};try{return(await Promise.all(o.map(async t=>{const r=e?`#${e} .field_${t} .kn-detail-body span`:`.field_${t} .kn-detail-body span`;try{return{fieldId:t,found:!0,element:await waitSelector({selector:r,delay:n})}}catch(r){return console.warn(`Field ${t} not found ${e?`in view ${e}`:"globally"} within ${n}ms.`),{fieldId:t,found:!1,element:null}}}))).forEach(({fieldId:e,found:t,element:n})=>{if(t&&n){const t=r?n.innerHTML?.trim()||null:n.textContent?.trim()||null;i[e]=t}else i[e]=null}),Array.isArray(t)?i:i[t]}catch(n){return console.error(`Error retrieving values for fields in view ${e}:`,n),o.forEach(e=>{void 0===i[e]&&(i[e]=null)}),Array.isArray(t)?i:null}}function getValueFromDetail(e,t=!1){const n=$(`.field_${e} .kn-detail-body`).first();return 0===n.length?(console.log(`Error: Element with field_${e} not found.`),null):t?n.html().trim():n.text().trim()}function insertValFromDetail(e,t){const n=getValueFromDetail(e);document.querySelectorAll(t).forEach(e=>{e.textContent=n})}function insertLoggedInUser(e,t){try{const n=Knack.getUserAttributes()?.name||"Unknown User";if("string"==typeof e){const t=document.querySelectorAll(e);if(0===t.length)return console.warn(`No elements found matching selector: ${e}`),n;t.forEach(e=>{e.textContent=n})}else if(e instanceof Element)e.textContent=n;else{if(!(e instanceof NodeList))return console.error("Invalid selector type provided to insertLoggedInUser"),n;e.forEach(e=>{e.textContent=n})}return"function"==typeof t&&t(n),n}catch(e){return console.error("Error inserting logged in user:",e),"User Unknown"}}function borderRadiusLastVisible(e,t){const n=document.getElementById(e);if(!n)return;const r=n.querySelector(".menu-links__list");if(!r)return;const o=Array.from(r.children).filter(e=>"none"!==window.getComputedStyle(e).display&&null!==e.offsetParent);if(0===o.length)return;o.forEach(e=>{const t=e.querySelector("a");t&&(t.style.borderRadius="")});const i=o[o.length-1].querySelector("a");i&&(i.style.borderRadius="0 .35em .35em 0"),t&&setTimeout(()=>borderRadiusLastVisible(e),t)}function changeToSlider(e,t,n,r={}){const o="string"==typeof t?`#${e} ${t}`:t,i="string"==typeof n?`#${e} ${n}`:n,s="string"==typeof o?document.querySelector(o):o,a="string"==typeof i?document.querySelector(i):i;if(!s||!a)return void console.error(`Slider or result field not found in view ${e}`);const l=s.id,c=a.id,d=r.minLabel||"",u=r.maxLabel||"",m=r.class||"",f={...r};delete f.minLabel,delete f.maxLabel,delete f.class,s.classList.remove("input"),s.type="range",s.classList.add("slider"),m&&m.split(/\s+/).filter(Boolean).forEach(e=>{document.getElementById(`kn-input-${l}`).classList.add(e),document.getElementById(`kn-input-${c}`).classList.add(`${e}-result`)});for(const[e,t]of Object.entries(f))s.setAttribute(e,t);if(s.addEventListener("input",()=>{a.value=s.value}),a.addEventListener("keyup",()=>{const e=parseFloat(a.value),t=parseFloat(s.min||0),n=parseFloat(s.max||100);!isNaN(e)&&e>=t&&e<=n&&(s.value=e)}),a.value=s.value,!l)return;const p=document.querySelector(`#${e} #kn-input-${l} div.control`);if(p){if(d){const e=document.createElement("label");e.className="slideLabel",e.textContent=d,e.style.left="1px",p.appendChild(e)}if(u){const e=document.createElement("label");e.className="slideLabel",e.textContent=u,e.style.right="2px",p.appendChild(e)}}}function openFileFromBtn(e,t,n,r=!1){const o=document.getElementById(e);if(!o)return void console.error(`View element with ID ${e} not found`);const i=[];i.push(...o.querySelectorAll("a")),i.push(...o.querySelectorAll("button"));const s=Array.from(i).filter(e=>e.textContent.trim().includes(t));0!==s.length?s.forEach(e=>{e.addEventListener("click",function(e){if(e.preventDefault(),r){const e=n.split("."),t=fileViewer(e[e.length-1],`https://api.knack.com/v1/applications/${Knack.application_id}/download/asset/${n}`);window.open(t,"_blank")}else window.location.href=sanitiseURL(window.location.href)+KN_ASSET_PREFIX+n})}):console.error(`Button with text "${t}" not found in view ${e}`)}function handleRedirect(e,t){"knack-form-submit"===e.type?setTimeout(()=>{window.location.href=t},300):"knack-scene-render"!==e.type&&"knack-view-render"!==e.type||document.querySelectorAll("button.close-modal").forEach(e=>{e.addEventListener("click",function(){setTimeout(()=>{window.location.href=t},300)},{once:!0})})}function getNewURL(e,t=3){const n=sanitiseURL(e).split("/");for(let e=1;e<=t;e++)n.pop();return n.join("/")}function getBackgroundSceneId(){const e=document.querySelectorAll("#knack-body .kn-scenes .kn-scene");for(const t of e)if(!t.closest(".kn-modal"))return t.id||null;return null}function isSceneToIgnore(e){const t=getBackgroundSceneId();if(!t||!e.length)return!1;const n=Number(t.replace("kn-scene_",""));return e.map(e=>Number(e)).filter(e=>!Number.isNaN(e)).includes(n)}function isUserRole(e){var t=!1;return $(e).each(function(e,n){if(Knack.getUserRoles(n))return t=!0,!1}),t}function isUserName(e){const t=Knack.getUserAttributes()?.name;return t===e}function replaceLargeNo(e,t,n,r){let o=[];o=r?Array.from(document.querySelectorAll("span.knViewLink__label")).filter(t=>t.textContent.includes(e)):Array.from(document.querySelectorAll(`td.field_${e}`)),o.forEach(e=>{const r=parseInt(e.textContent.replace(/,/g,""),10);!isNaN(r)&&r>t&&(e.textContent=n)})}function getIdFromElement(e){if(!e)return null;const t=/^[a-fA-F0-9]{24}$/;if(e.id&&t.test(e.id))return e.id;for(const n of e.classList||[])if(t.test(n))return n;return null}function getConnectionIdFromCell(e){if(!e)return null;const t=getIdFromElement(e.querySelector('span[data-kn="connection-value"]'));if(t)return t;const n=e.querySelectorAll("span");for(const e of n){const t=getIdFromElement(e);if(t)return t}return null}function getRecordID(e=null){const t=sanitiseURL(window.location.href).split("/");return e?t[t.length-e]:t[t.length-2]}function showPopUpNotification(e,t,n,r,o){Knack.showSpinner(),$(`<div class="${r}">${t}</div>`).css({"background-color":n}).insertAfter(e).delay(o).fadeOut(function(){removeElement(this)})}function sanitiseURL(e){return e.toString().split("?")[0]}async function initSecureStorage(e){return e&&"string"==typeof e?ktl.storage.initSecureLs().then(()=>{try{const t=ktl.storage.lsGetItem(e,!1,!1,!0);if(!t){console.log(`Storage '${e}' doesn't exist yet, initializing empty storage.`);const t="{}";return ktl.storage.lsSetItem(e,t,!1,!1,!0),{}}try{return JSON.parse(t)}catch(t){return console.warn(`Error parsing content of '${e}', returning empty object:`,t),ktl.storage.lsSetItem(e,"{}",!1,!1,!0),{}}}catch(t){throw console.error(`Error accessing storage '${e}':`,t),new Error(`Failed to get item from secure storage: ${t.message}`)}}).catch(e=>{throw console.error("Failed to initialize secure storage:",e),new Error(`Secure storage initialization failed: ${e.message}`)}):Promise.reject(new Error("Invalid storage key provided. Must be a non-empty string."))}function setSecureStorage(e,t,n,r,o=5){initSecureStorage(e).then(i=>{const s=new Date;s.setDate(s.getDate()+o),i[t]=i[t]||{},i[t].expirationDate=s.getTime(),i[t][n]=r,ktl.storage.lsSetItem(e,JSON.stringify(i),!1,!1,!0)})}function getSecureStorage(e,t){return initSecureStorage(e).then(n=>{const r=(new Date).getTime();for(let e in n)r>n[e].expirationDate&&delete n[e];return ktl.storage.lsSetItem(e,JSON.stringify(n),!1,!1,!0),n[t]?n[t]:""})}function checkAllRadioAnswered(e,t=[]){const n=new Set;$(`#${e} :radio:visible`).each(function(){const e=parseInt($(this).closest('[id^="kn-input-field_"]').attr("id").split("_")[1]);t.includes(e)||n.add($(this).attr("name"))});return $(`#${e} :radio:visible:checked`).filter(function(){const e=parseInt($(this).closest('[id^="kn-input-field_"]').attr("id").split("_")[1]);return!t.includes(e)}).length===n.size}function changeCellTextBasedOnCellContent(e,t,n,r,o,i,s="success"){t.forEach(t=>{if(t[n].includes(o)){$(`tr[id=${t.id}]`).find(`td:eq(${$(`#${e} th.${r}`).index()})`).css({"background-color":`var(--${s})`,"font-weight":"700",color:"black"}).find(".knViewLink__label").text(i)}})}function toggleShowHideViewContent(e,t,n,r,o=!1){e.off("click.showHide").on("click.showHide",function(){t.slideToggle(r),n.toggleClass("down up"),e.toggleClass("active"),o&&t.css("display","flex")})}function shrinkContent(e,t,n,r,o){e.off("click.shrinkLink").on("click.shrinkLink",function(){t.slideUp(r),removeClassFromSelector(n,"up").addClass("down"),removeClassFromSelector(o,"active")})}function showHideViewContent(e,t,n=!1){const r=$(`#show-hide_${e}`),o=$(`#arrow_${e}`),i=$(`#shrink-link_${e}`),s=$(`.${e}`);toggleShowHideViewContent(r,s,o,t,n),shrinkContent(i,s,o,t,r)}function appendShrinkLink(e,t,n=!1){const r=`<a class="show-hide-btn shrink-link" id="shrink-link_${t}">Shrink &nbsp;<span class="arrow up" id="arrow_${t}">â—€</span></a>`;0===$(`#shrink-link_${t}`).length&&(n?$(`#${e}`).append(r):$(`#${e}`).find(".show-hide-section").append(r))}function replaceTitleWithButton(e,t){const n=$(`#${e} h2.kn-title`),r=`<div class="show-hide-btn" id="show-hide_${t}">${n.text()} &nbsp;<span class="arrow down" id="arrow_${t}">â—€</span></div>`;0===$(`#show-hide_${t}`).length&&n.html(r)}function wrapContentForShowHide(e,t,n){const r={table:".kn-table-wrapper, .kn-records-nav",form:"form, .kn-form-confirmation",list:".kn-list-content, .kn-records-nav"}[t],o=$(`#${e}`),i=o.find("section");if(r){const e=o.find(r);e.parent().is("section")||e.wrapAll(`<section class='${n} show-hide-section box-with-border' />`)}else i.hasClass(`${n} show-hide-section box-with-border`)||i.addClass(`${n} show-hide-section box-with-border`)}function toggleElements(e,t){Array.isArray(e)?e.forEach((e,n)=>{const r=Array.isArray(t)?t[n]:t;$(e).toggle(r)}):$(e).toggle(t)}function getFormId(e){return $(`#${e} .kn-submit input[name="id"]`).val()}function splitAndTrimField(e){return e?e.split(",").map(e=>e.trim()):[]}function syncTextInputs(e,t){if("1"===e.dataset.notesSyncBound&&"1"===t.dataset.notesSyncBound)return;e.dataset.notesSyncBound="1",t.dataset.notesSyncBound="1";let n=!1;function r(e,t){if(n)return;const r=e.value;t.value!==r&&(n=!0,t.value=r,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),n=!1)}function o(){r(e,t)}function i(){r(t,e)}e.addEventListener("input",o),e.addEventListener("change",o),t.addEventListener("input",i),t.addEventListener("change",i);const s=(e.value||"").trim(),a=(t.value||"").trim();s&&s!==a?r(e,t):a&&a!==s&&r(t,e)}function createButton(e){"string"==typeof arguments[0]&&(e={id:arguments[0],html:arguments[1],className:arguments[2]}),e=Object.assign({id:"",html:"",className:"",type:"button",attributes:{},onClick:null},e);const t=document.createElement("button");e.id&&(t.id=e.id),t.className="kn-button"+(e.className?" "+e.className:""),t.type=e.type,t.innerHTML=e.html;for(const[n,r]of Object.entries(e.attributes))t.setAttribute(n,r);return"function"==typeof e.onClick&&t.addEventListener("click",e.onClick),t}function addModalNavigationButtons(){const e=document.createElement("div");e.className="modal-control-buttons";const t=createButton({id:"scrollToTopBtn",html:'<i class="fa fa-arrow-up"></i>',className:"modalButton success-bkgd scroll-to-top-btn",onClick:function(){document.querySelector(".modal-card-head").scrollIntoView({behavior:"auto",block:"start"})}}),n=createButton({id:"closeModalBtn",html:'<i class="fa fa-times"></i>',className:"modalButton warning-bkgd close-modal-btn",onClick:function(){const e=document.querySelector("button.close-modal");if(e)e.click();else{const e=document.getElementById("kn-modal-bg-0");e&&(e.style.display="none")}}});e.appendChild(t),e.appendChild(n);const r=document.getElementById("kn-modal-bg-0");r&&(r.appendChild(e),e.style.display="none",r.addEventListener("scroll",function(){const t=document.querySelector(".modal-card-body");if(!t)return;const n=t.getBoundingClientRect();e.style.left=`${n.right}px`,r.scrollTop>100?(e.style.display="flex",e.style.opacity="1",e.style.transition="opacity 0.3s"):(e.style.opacity="0",e.style.transition="opacity 0.3s",setTimeout(function(){r.scrollTop<=100&&(e.style.display="none")},300))}))}function capitaliseInput(e,t,n={mode:"title",trim:!0,smartWords:!0}){let r=document.getElementById(e);if(r||(r=document.querySelector(`#connection-form-view:has(input[value="${e}"])`)),!r)return;const o=r.querySelector(t);if(!o)return;const i=["and","or","the","of","in","on","at","to","for","by","with","a","an","but","nor","as"];addInputEventListener(o,function(e,t){let r=t.value;if(!r)return;const{mode:o="title",trim:s=!0,smartWords:a=!0}=n||{};let l=e&&"blur"===e.type;s&&l&&(r=r.trim());let c=r;if("all"===o?c=r.toUpperCase():"sentence"===o?c=r.charAt(0).toUpperCase()+r.slice(1):"title"===o&&(e&&"insertText"===e.inputType&&" "===e.data||(c=r.replace(/\b[\w'-]+\b/g,function(e,t,n){let r=e.replace(/(^|[-'])\w/g,function(e){return e.toUpperCase()}).replace(/(?<!^|[-'])\w/g,function(e){return e.toLowerCase()});return a&&i.includes(r.toLowerCase())&&0!==t&&t+e.length!==n.length?r.toLowerCase():r}))),t.value!==c){const e=t.selectionStart;t.value=c,"number"==typeof e&&t===document.activeElement&&t.setSelectionRange(e,e)}},{events:["input","blur"]})}function capitaliseString(e,t={allCaps:!0}){if("string"!=typeof e||!e.trim())return"";const{allCaps:n=!0}=t;return n?e.trim().toUpperCase():e.trim().replace(/\b\w/g,e=>e.toUpperCase())}async function waitGetConxIdFromDetailId({viewId:e,fieldId:t,delay:n=5e3}){try{const r=`#${e} .field_${t} .kn-detail-body > span > span > span`,o=await waitSelector({selector:r,delay:n,returnType:"elements"});return o&&0!==o.length?new Promise(e=>{setTimeout(()=>{const t=Array.from(o).map(e=>e.id).filter(Boolean);0===t.length?(console.log("No connection IDs found in elements"),e(null)):e(1===t.length?t[0]:t)},100)}):(console.log(`No connection elements found with selector: ${r}`),null)}catch(e){return console.error(`Error getting connection ID from detail view: ${e}`),null}}function createDropdownHTML(e,t=!0,n="Select"){const r=document.createElement("div");r.className="kn-input kn-input-multiple_choice control";const o=document.createElement("label");o.setAttribute("for",e),o.className="label kn-label";const i=document.createElement("span");i.textContent=`${n} `;const s=document.createElement("span");if(s.className="selectText",o.appendChild(i),o.appendChild(s),t){const e=document.createElement("span");e.className="kn-required",e.textContent="*",o.appendChild(e)}const a=document.createElement("div");a.className="kn-select";const l=document.createElement("div");l.className="kn-select";const c=document.createElement("select");return c.setAttribute("data-placeholder","Select"),c.setAttribute("name",e),c.setAttribute("id",e),c.className="select",c.style.verticalAlign="bottom",l.appendChild(c),a.appendChild(l),r.appendChild(o),r.appendChild(a),r}const OFFICE_EXTENSIONS=["docx","odt","rtf","docm","doc","dotx","dotm","dot","xlsx","xls","ppts","ppt","pptx"],IMAGE_EXTENSIONS=["png","jpeg","jpg","gif","bmp","svg","webp","tiff","ico"];function updateLinksAndAssets(e){const t=sanitiseURL(window.location.href),n=document.getElementById(e);function r(e,t=!1){let n,r;if(t)n=e.getAttribute("data-asset-id"),r=e.getAttribute("data-file-name");else{const t=e.id;if(!assetURLs[t])return{};const o=assetURLs[t].split("/");n=o[0],r=o[o.length-1]}if(!r||!n)return{};const o=r.match(/\.([^.]+)$/);return{assetId:n,fileName:r,extension:o?o[1].toLowerCase():"",assetUrl:`https://api.knack.com/v1/applications/${Knack.application_id}/download/asset/${n}/${encodeURIComponent(r)}`}}function o(e,t,n=!1){t.extension&&(IMAGE_EXTENSIONS.includes(t.extension)?e.setAttribute("href",`${sanitiseURL(window.location.href)}kn-asset/1542-3553-3690-${t.assetId}/${t.fileName}`):OFFICE_EXTENSIONS.includes(t.extension)?(e.setAttribute("href",`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(t.assetUrl)}`),e.setAttribute("target","_blank")):"pdf"===t.extension?(e.setAttribute("href",`https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(t.assetUrl)}`),e.setAttribute("target","_blank")):(e.setAttribute("href",t.assetUrl),e.setAttribute("download",t.fileName)),n&&(e.textContent=t.fileName))}n?(n.querySelectorAll(".ca-link, .ca-link-child, .ca-link-user").forEach(e=>{const n=e.id;let i=t;if(!n)return void console.error(`%c Error: ${e.textContent} - Link must have ID to define URL `,"color: red; font-weight: bold;");const s=e.classList.contains("ca-asset"),a=s?assetURLs[n]:n;e.classList.contains("ca-link-child")?i+=`${a}/${getRecordID()}`:e.classList.contains("ca-link-user")?i+=`${a}/${Knack.getUserAttributes()?.id}`:i+=a,s?function(e,t=!1){const n=r(e,t);n.extension&&o(e,n,t)}(e,!1):("_blank"===e.getAttribute("target")&&e.classList.add("extLink"),e.setAttribute("href",i))}),n.querySelectorAll(".kn-view-asset").forEach(e=>{const t=r(e,!0);if(!t.extension)return;if(IMAGE_EXTENSIONS.includes(t.extension))return;const n=document.createElement("a");n.target="_blank",o(n,t,!0),e.replaceWith(n)})):console.error(`View element with ID ${e} not found`)}function insertStaffName(e){try{const t=".kn-detail-label",n=Knack.getUserAttributes()?.name||"";waitSelector({selector:t,textCondition:{text:"Staff Name",exact:!0},timeout:5e3}).then(t=>{const r=t.nextElementSibling.textContent.trim()||n;"string"==typeof e?document.querySelectorAll(e).forEach(e=>e.textContent=r):e instanceof Element?e.textContent=r:(e instanceof NodeList||Array.isArray(e))&&Array.from(e).forEach(e=>e.textContent=r)}).catch(t=>{console.error(`Error finding staff field: ${t}`),"string"==typeof e?document.querySelectorAll(e).forEach(e=>e.textContent=n):e instanceof Element?e.textContent=n:(e instanceof NodeList||Array.isArray(e))&&Array.from(e).forEach(e=>e.textContent=n)})}catch(t){errorHandler.handle(t,{function:"insertStaffName",target:e},"insertStaffName")}}function updateLabelText(e,t,n,{params:r}){const o=document.getElementById(e);if(!o)return void console.warn(`View ${e} not found for updateLabelText`);let i,s,a;const l={form:`#${o.id} #kn-input-${n} .kn-label span:not(.kn-required)`,details:`#${o.id} .${n} .kn-detail-label > span`,list:`#${o.id} .${n} .kn-detail-label > span`,table:`#${o.id} th.${n} > span > a > span:not(span.icon)`,search:`#${o.id} th.${n} > span > a > span:not(span.icon)`};2===r.length?([i,s]=r.map(e=>e),i=i.join(", "),a=l[t]&&s[0].includes(t[0])?l[t]:null):(i=r[0].join(", "),a=l[t]);const c=Object.entries({"{br}":"<br>","{strong}":"<strong>","{/strong}":"</strong>","{em}":"<em>","{/em}":"</em>","{hr}":"<hr>"}).reduce((e,[t,n])=>e.replaceAll(t,n),i||"");if(a){const e=document.querySelector(a);e&&(e.innerHTML=c||"")}}function idleWatchDogTimeout(){if(document.querySelector(".kn-login"))return;const e="ktl-idle-",t=e+"overlay",n=e+"dialog",r=e+"logout-btn",o=e+"stay-btn";document.getElementById(t)?.remove(),document.getElementById(n)?.remove();const i=document.createElement("div");i.id=t,Object.assign(i.style,{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"black",opacity:.8,zIndex:1e5,display:"block"}),document.body.appendChild(i);const s=document.createElement("div");s.id=n,s.setAttribute("role","dialog"),s.setAttribute("aria-modal","true"),s.setAttribute("aria-labelledby",e+"title"),s.setAttribute("tabindex","-1"),s.innerHTML=`\n        <h2 id="${e}title">Knack Logout</h2>\n        <p>You are about to be logged out. Do you wish to remain logged in?</p>\n        <div class="ktl-dialog-buttons">\n            <button id="${r}" class="kn-button is-secondary">Logout</button>\n            <button id="${o}" class="kn-button is-secondary">Stay Logged In</button>\n        </div>\n    `,document.body.appendChild(s);const a=document.activeElement;let l;s.focus();let c=!1;function d(){i.remove(),s.remove(),window.removeEventListener("resize",m),a&&"function"==typeof a.focus&&a.focus()}function u(){if(!c){c=!0,clearTimeout(l),d();try{Knack.user.destroy()}catch(e){console.warn("Error calling Knack.user.destroy()",e)}setTimeout(()=>{if(!document.querySelector(".kn-login"))try{Knack.user.destroy()}catch(e){try{window.location.reload()}catch(e){}}},2e3)}}function m(){s.style.width=window.innerWidth<=768?"70%":"25%"}document.getElementById(r).addEventListener("click",u),document.getElementById(o).addEventListener("click",function(){d();try{ktl.scenes.resetIdleWatchdog()}catch(e){}}),m(),window.addEventListener("resize",m);l=setTimeout(u,60*Math.max(0,1)*1e3)}function setViewMaxWidth({key:e}){const t=$(`#${e}`);ktl.core.getKeywordsByType(e,"_vmxw").forEach(({options:e,params:n})=>{if(!ktl.core.hasRoleAccess(e))return;const r=n[0][0];let o;const i=parseFloat(r);if(r.includes("%")||r.includes("px")||isNaN(i))o=r;else{if(isNaN(i))return void console.error(`Invalid width value: ${r}`);o=`${i}px`}t.css("max-width",o)})}function hideEmptyFields(e){$(`#${e.key} .kn-detail-body`).each(function(){""===$.trim($(this).text())&&removeElement(this)})}function hideElementsByValue(e,t){const n="_hebv",{key:r}=e;if(!r||!t[n])return;ktl.core.getKeywordsByType(r,n).forEach(e=>{const{options:t,params:n}=e;ktl.core.hasRoleAccess(t)&&0!==n.length&&n.forEach(e=>{if(e.length<3)return;const[t,n,...r]=e,o=$.trim($(`.${t} .kn-detail-body`).text());(n.startsWith("!")?o!==n.slice(1):o===n)&&($(r.join()).hide(),borderRadiusLastVisible())})})}function buttonToUrl({key:e},t){const n="_btnurl";if(!t[n])return;const r=ktl.views.getViewType(e);if(["list","form"].includes(r))return;const o=$(`#${e}`);ktl.core.getKeywordsByType(e,n).forEach(({options:t,params:n})=>{n.length?n.forEach(n=>{if(n.length<2)return void console.error("Button URL Params Error - Insufficient parameters found.");if(!ktl.core.hasRoleAccess(t))return void removeElement(o.find(d));const i=sanitiseURL(window.location.href),[s,a,l,c]=n,d="menu"===r?`li:textEquals("${s}")`:`a:textEquals("${s}")`,u=(e,t)=>{e.length?e.off("click").on("click",e=>((e,t)=>{e.preventDefault(),window.location.href=t})(e,t)):console.error(`buttonURL Error - Button with text "${s}" not found.`)};if(["table","search"].includes(r))getTableRows(e,(e,t)=>{const n=t.find("td.field_6087").text().trim(),r=t.find(d);u(r,`${i}${a}/${n}/`)});else{const e=o.find(d),t="false"!==l?`${i}${a}/${getRecordID(c||null)}/`:`${i}${a}/`;u(e,t)}}):console.error("Button URL Params Error - No parameter groups found.")})}function caQuickToggle({key:e},t=[]){new CAQuickToggle(e,t).init()}class CAQuickToggle{constructor(e,t){this.viewId=e,this.data=t,this.kw="_caqt",this.kwInstance=null,this.viewModel=null,this.viewType="",this.inlineEditing=!1,this.fieldMap=new Map,this.quickToggleParams={bgColorTrue:"#e2efda",bgColorFalse:"#ffb557",bgColorPending:"#ffe699",showNotification:!1,showSpinner:!1,pendingClass:"ktlProgress"},this.qtScanItv=null,this.quickToggleObj={},this.numToProcess=0,this.refreshTimer=null,this.viewsToRefresh=[],this.viewHasQt=!1,this.fieldsColor={}}init(){this.isValidInitialState()&&this.setupKeywordInstances()&&this.setupViewModel()&&(this.setupColors(),this.processFields(),this.updateTableColors(),this.setupCellClickHandlers())}isValidInitialState(){return this.viewId&&this.data.length>0&&!ktl.scenes.isiFrameWnd()}setupKeywordInstances(){if(this.kwInstance=ktlKeywords[this.viewId]&&ktlKeywords[this.viewId][this.kw],this.kwInstance&&this.kwInstance.length){this.kwInstance=this.kwInstance[0];const{options:e}=this.kwInstance;if(!ktl.core.hasRoleAccess(e))return!1}const e=ktl.core.checkIfViewHasKeyword(this.viewId,this.kw);return ktl.core.checkIfViewHasKeyword(this.viewId,"_qt")?(console.log(`View ${this.viewId} has both _caqt and _qt keywords. Using original quickToggle only.`),!1):!!e}setupViewModel(){if(this.viewModel=Knack.router.scene_view.model.views._byId[this.viewId],!this.viewModel)return!1;const e=this.viewModel.attributes;return this.viewType=e.type,!!["table","search"].includes(this.viewType)&&(this.inlineEditing="table"===this.viewType?e.options&&e.options.cell_editor:e.cell_editor,!0)}setupColors(){let e=this.quickToggleParams.bgColorTrue,t=this.quickToggleParams.bgColorFalse;if(this.kwInstance&&(this.viewHasQt=!0,this.kwInstance.params&&this.kwInstance.params.length)){const n=this.kwInstance.params[0];n.length>=1&&n[0]&&(e=n[0]),n.length>=2&&n[1]&&(t=n[1])}this.bgColorTrue=e,this.bgColorFalse=t}processFields(){const e=this.viewModel.attributes;let t={};("table"===this.viewType?e.columns:e.results.columns).forEach(e=>{if("field"===e.type&&e.field&&e.field.key){const n=Knack.objects.getField(e.field.key);if(n&&!e.connection&&"boolean"===n.attributes.type){let n=!1;const{key:r}=e.field;let o={bgColorTrue:this.bgColorTrue,bgColorFalse:this.bgColorFalse};ktl.fields.getFieldKeywords(r,t);const i=t[r]&&t[r][this.kw];if((this.viewHasQt||i)&&(n=!0,i&&i.length&&i[0].params&&i[0].params.length>0)){const e=i[0].params[0];e.length>=1&&""!==e[0]&&(o.bgColorTrue=e[0]),e.length>=2&&""!==e[1]&&(o.bgColorFalse=e[1])}n&&(this.fieldsColor[r]=o,this.inlineEditing&&!e.ignore_edit&&$(`#${this.viewId} td.${r}.cell-edit`).addClass("caQtCellClickable"))}this.fieldMap.set(e.field.key,e.header)}})}updateTableColors(){$.isEmptyObject(this.fieldsColor)||this.data.forEach(e=>{Object.keys(this.fieldsColor).forEach(t=>{const n=$(`#${this.viewId} tbody tr[id="${e.id}"] .${t}`),r=n.attr("style"),o=`background-color:${!0===e[t+"_raw"]?this.fieldsColor[t].bgColorTrue:this.fieldsColor[t].bgColorFalse}`;n.attr("style",`${r?r+"; ":""}${o}`)})})}setupCellClickHandlers(){$(`#${this.viewId} .caQtCellClickable`).bindFirst("click",e=>this.handleCellClick(e))}handleCellClick(e){if($(".bulkEditCb:checked").length)return;e.stopImmediatePropagation();const t=$(e.target).data("field-key")||$(e.target).parent().data("field-key"),n=$(e.target).closest(".kn-search.kn-view[id], .kn-table.kn-view[id]");if(n.length){const r=n.attr("id"),o=Date.now(),i=$(e.target).closest("tr").attr("id");let s=ktl.views.getDataFromRecId(r,i)[`${t}_raw`];s=!0!==s,this.viewsToRefresh.includes(r)||this.viewsToRefresh.push(r),this.quickToggleObj[o]={viewId:r,fieldId:t,value:s,recId:i,processed:!1};const a=$(e.target).closest("td");a.css("background-color",this.quickToggleParams.bgColorPending),this.quickToggleParams.pendingClass&&a.addClass(this.quickToggleParams.pendingClass),clearTimeout(this.refreshTimer);const l=this.findCorrespondingField(t,s);l&&(this.quickToggleObj[o].additionalData=l),this.numToProcess++,this.startQtScanning()}}findCorrespondingField(e,t){const n=this.fieldMap.get(e);let r="",o=!1;for(const[t,i]of this.fieldMap.entries())if(t!==e&&(i===n||i===`${n} - Name`||i.startsWith(`${n} `))){o=i===`${n} - Name`,r=t;break}if(r){const e=Knack.getUserAttributes(),n=o?e.name:e.id;return{[r]:!1===t?null:n}}return null}startQtScanning(){this.quickToggleParams.showNotification&&(ktl.core.infoPopup(),this.showProgress()),this.qtScanItv||(ktl.views.autoRefresh(!1),this.qtScanItv=setInterval(()=>{if(!$.isEmptyObject(this.quickToggleObj)){const e=Object.keys(this.quickToggleObj)[0],{processed:t}=this.quickToggleObj[e];t||(this.quickToggleObj[e].processed=!0,this.doQuickToggle(e))}},500))}doQuickToggle(e){const t=this.quickToggleObj[e];if($.isEmptyObject(t)||!t.viewId||!t.fieldId)return;const n={[t.fieldId]:t.value,...t.additionalData};ktl.core.knAPI(t.viewId,t.recId,n,"PUT",[],!1).then(()=>{this.quickToggleParams.showNotification&&this.showProgress(),this.numToProcess--,delete this.quickToggleObj[e],$.isEmptyObject(this.quickToggleObj)&&(clearInterval(this.qtScanItv),this.qtScanItv=null,this.quickToggleParams.showSpinner&&Knack.showSpinner(),this.refreshTimer=setTimeout(()=>{ktl.core.removeInfoPopup(),ktl.views.refreshViewArray(this.viewsToRefresh).then(()=>{Knack.hideSpinner(),ktl.views.autoRefresh()}).catch(()=>{})},500))}).catch(e=>{ktl.views.autoRefresh();const t=e?JSON.stringify(e):"Unknown error";console.error("Quick Toggle operation failed:",e),errorHandler.handleError(e,{function:"doQuickToggle"},"Quick Toggle Error"),alert(`Error code KEC_1025 while processing Quick Toggle operation, reason: ${t}`)})}showProgress(){ktl.core.setInfoPopupText("Toggling... "+this.numToProcess+" items remaining.")}}class KnackError{constructor(e={}){this.options={sceneId:e.sceneId||"",viewId:e.viewId||"",fieldMap:e.fieldMap||{},captureUserData:void 0===e.captureUserData||e.captureUserData,captureSystemInfo:void 0===e.captureSystemInfo||e.captureSystemInfo,consoleLog:void 0===e.consoleLog||e.consoleLog,groupSimilarErrors:void 0===e.groupSimilarErrors||e.groupSimilarErrors,maxErrorsPerMinute:e.maxErrorsPerMinute||10,ignoredErrors:e.ignoredErrors||[],captureKnackContext:void 0===e.captureKnackContext||e.captureKnackContext,separateContextFields:void 0===e.separateContextFields||e.separateContextFields},this.api=new KnackAPI({debug:!1,showSpinner:!1}),this.boundHandleError=this.handleError.bind(this),this._errorCount=0,this._lastResetTime=Date.now(),this._errorHashes=new Map,this._lastKnownContext={sceneId:null,viewId:null,eventType:null,timestamp:null},this.options.captureKnackContext&&this._setupContextTracking(),this._validateOptions(),this.performanceData={javaScriptErrors:0,networkErrors:0,apiErrors:0,totalErrors:0,slowestOperation:null,averageResponseTime:0}}async handleError(e,t={},n="Unknown"){if(this._shouldIgnoreError(e)||this._isRateLimited())return null;this.options.captureKnackContext&&Object.assign(t,this._captureContextData());const r=this._captureErrorData(e,t,n);if(this.options.groupSimilarErrors){const e=this._processErrorGroup(r);if(e)return e.record}if(this._updatePerformanceMetrics(r),this.options.consoleLog&&console.error("KnackError:",r),this.options.sceneId&&this.options.viewId)try{return await this._logToKnackTable(r)}catch(e){console.error("Error logging to Knack table:",e)}return null}wrapEventHandler(e,t){const n=this;return async function(r,o,i){try{const r={eventType:e.replace("knack-",""),viewId:o?o.key:null,sceneId:n._getCurrentSceneId(),recordId:i?i.id:null,timestamp:(new Date).toISOString()};return n._lastKnownContext=r,await t.apply(this,arguments)}catch(t){throw await n.handleError(t,{knackContext:n._lastKnownContext},`${e} Handler`),t}}}setupGlobalErrorHandling(e=!0){return window.addEventListener("error",e=>{this.handleError(e.error||e.message,{errorFile:e.filename,errorLine:e.lineno,errorColumn:e.colno},"Global Error Event")}),e&&window.addEventListener("unhandledrejection",e=>{const t=e.reason instanceof Error?e.reason:new Error(String(e.reason));this.handleError(t,{},"Unhandled Promise Rejection")}),this}wrapFunction(e,t,n={}){return this.executeFunction(e,{source:t,rethrowError:!0,additionalInfo:n})}tryCatch(e,t,n={}){const r=this;return async function(...o){try{return await e.apply(this,o)}catch(i){return r.handleError(i,{functionArgs:JSON.stringify(o,(e,t)=>"function"==typeof t?"function() { ... }":t instanceof Node?t.nodeName:t instanceof Window?"Window":t),knackContext:r.getCurrentContext(),...n},t||e.name||"Anonymous Function"),{success:!1,error:i,message:i.message}}}}monitorPerformance(e,t,n=1e3,r={}){const o=this;return async function(...i){const s=performance.now();try{const r=await e.apply(this,i),o=performance.now()-s;return o>n&&console.warn(`Performance warning: ${t||e.name||"Anonymous"} took ${o.toFixed(2)}ms`),r}catch(a){const l=performance.now()-s;throw o.handleError(a,{functionArgs:JSON.stringify(i,(e,t)=>"function"==typeof t?"[Function]":t),responseTime:l.toFixed(2),performanceContext:{threshold:n,executionTime:l.toFixed(2)},...r},t||e.name||"Performance Monitor"),a}}}monitorApiCall(e,t="Knack API Call",n={}){const r=this;return async function(...o){const i=performance.now();try{const n=await e.apply(this,o),r=performance.now()-i;return r>2e3&&console.warn(`KnackError: Slow API call to ${t}: ${r.toFixed(2)}ms`),n}catch(s){const a=performance.now()-i;let l={};if(o.length>=2&&(l={sceneKey:o[0]||null,viewId:o[1]||null,recordId:o.length>2?o[2]:null,requestData:o.length>3?o[3]:null},e.name)){const t=e.name.toLowerCase();t.includes("create")?l.requestType="POST":t.includes("update")?l.requestType="PUT":t.includes("delete")?l.requestType="DELETE":t.includes("get")&&(l.requestType="GET")}throw r.handleError(s,{apiParams:l,responseTime:a.toFixed(2),knackContext:r.getCurrentContext(),...n},t),s}}}getPerformanceMetrics(){return{...this.performanceData,errorRate:{total:this.performanceData.totalErrors,perMinute:this._errorCount/((Date.now()-this._lastResetTime)/6e4)}}}ignoreError(e){return this.options.ignoredErrors.push(e),this}wrapAllMethods(e,t,n={}){const r={};for(const o in e)"function"==typeof e[o]?r[o]=this.wrapFunction(e[o],t?`${t}.${o}`:o,n):r[o]=e[o];return r}safeExecute(e,t,n,r={}){return this.executeFunction(e,{returnDefaultOnError:!0,defaultValue:t,source:n,immediate:!0,additionalInfo:r})}executeFunction(e,t={}){const{returnDefaultOnError:n=!1,defaultValue:r=null,captureArgs:o=!0,captureContext:i=!0,rethrowError:s=!0,source:a=e.name||"Execute Function",immediate:l=!1,immediateArgs:c=[],additionalInfo:d={}}=t,u=this,m=async function(...t){try{return await e.apply(this,t)}catch(e){const l={...d};if(o&&(l.functionArgs=JSON.stringify(t,(e,t)=>"function"==typeof t?"function() { ... }":t instanceof Node?t.nodeName:t instanceof Window?"Window":t)),i&&(l.knackContext=u.getCurrentContext()),u.handleError(e,l,a),n)return r;if(s)throw e}};return l?m(...c):m}wrapKnackListener(e,t,n,r={}){const o=this,i="any"===e?`${t}.any`:`${t}.${e}`;return $(document).on(i,function(i,s,a){const l={...r,listenerViewId:e,listenerEventType:t};try{return n.apply(this,arguments)}catch(n){const r=`${t} Listener for ${e}`;return o.handleError(n,l,r),void console.error(`Error in ${r}: ${n.message}`)}}),this}getCurrentContext(){const e={...this._lastKnownContext,currentSceneId:this._getCurrentSceneId(),currentViewId:this._getCurrentViewId(),url:window.location.href};return e.sceneId||(e.sceneId=e.currentSceneId),e.viewId||(e.viewId=e.currentViewId),e}_setupContextTracking(){["view-render","scene-render","form-submit","record-update","cell-update","record-delete"].forEach(e=>{$(document).on(`knack-${e}.any`,(t,n,r)=>{this._lastKnownContext={viewId:n?.key||null,sceneId:this._getCurrentSceneId(),eventType:e,recordId:r?.id||null,timestamp:(new Date).toISOString()}})})}_getCurrentSceneId(){if("undefined"!=typeof Knack&&Knack.router&&Knack.router.current_scene_key)return Knack.router.current_scene_key;const e=document.querySelector(".kn-scene");if(e){const t=e.id;if(t&&t.startsWith("kn-scene_"))return t.replace("kn-","")}return this._extractSceneIdFromUrl()}_getCurrentViewId(){return this._getActiveViewId()||this._getFirstViewId()}_getActiveViewId(){const e=document.activeElement;if(e){let t=e;for(;t&&t!==document.body;){if(t.id&&t.id.startsWith("view_"))return t.id;t=t.parentElement}}return null}_getFirstViewId(){const e=document.querySelector('[id^="view_"]');return e?e.id:null}_extractSceneIdFromUrl(){const e=window.location.href.match(/\/scene_(\d+)/i);return e&&e[1]?`scene_${e[1]}`:null}_validateOptions(){this.options.sceneId&&this.options.viewId||console.error("KnackError: Missing required options sceneId and viewId");const e=["errorMessage","errorSource","errorStack"].filter(e=>!this.options.fieldMap[e]);e.length>0&&console.error(`KnackError: Missing required field mappings: ${e.join(", ")}`)}_processErrorGroup(e){const t=this._generateErrorHash(e),n=Date.now();if(this._errorHashes.has(t)){const e=this._errorHashes.get(t);return e.count++,e.lastSeen=n,n-e.firstLogged>36e5?(this._errorHashes.set(t,{count:1,firstLogged:n,lastSeen:n,record:null}),null):e}return this._errorHashes.set(t,{count:1,firstLogged:n,lastSeen:n,record:null}),null}_shouldIgnoreError(e){const t=e instanceof Error?e.message:String(e);return this.options.ignoredErrors.some(e=>e instanceof RegExp?e.test(t):t.includes(e))}_isRateLimited(){const e=Date.now();return e-this._lastResetTime>6e4&&(this._errorCount=0,this._lastResetTime=e),++this._errorCount>this.options.maxErrorsPerMinute}_generateErrorHash(e){return[e.errorName||"",e.errorMessage||"",e.errorSource||"",e.contextSceneId||"",e.contextViewId||"",e.contextEventType||""].join("|")}_updatePerformanceMetrics(e){if(this.performanceData.totalErrors++,"NetworkError"===e.errorName||e.errorMessage.includes("network")?this.performanceData.networkErrors++:e.errorMessage.includes("API")||e.errorSource.includes("API")||e.errorSource.includes("caAPI")?this.performanceData.apiErrors++:this.performanceData.javaScriptErrors++,e.responseTime){const t=parseFloat(e.responseTime);if(!isNaN(t)){(!this.performanceData.slowestOperation||t>this.performanceData.slowestOperation.time)&&(this.performanceData.slowestOperation={time:t,source:e.errorSource,timestamp:e.errorTime});const n=this.performanceData.averageResponseTime*(this.performanceData.totalErrors-1);this.performanceData.averageResponseTime=(n+t)/this.performanceData.totalErrors}}}_captureErrorData(e,t,n){const r={errorMessage:e instanceof Error?e.message:String(e),errorName:e instanceof Error?e.name:"CustomError",errorStack:e instanceof Error?e.stack:(new Error).stack,errorSource:n,errorTime:(new Date).toISOString(),errorUrl:window.location.href};return["contextSceneId","contextViewId","contextEventType","contextRecordId","contextUrl","contextTimestamp","knackContext","knackContextFormatted"].forEach(e=>{t[e]&&(r[e]=t[e])}),this.options.captureUserData&&Object.assign(r,this._captureUserData()),this.options.captureSystemInfo&&Object.assign(r,this._captureSystemInfo()),this.options.captureKnackContext&&Object.assign(r,this._captureContextData(t)),r.additionalInfo={...t},r}_captureUserData(){const e={};if(this.options.captureUserData&&Knack&&Knack.getUserAttributes)try{const t=Knack.getUserAttributes();e.userName=t.name||"Unknown User",e.userId=t.id||"Unknown ID",Knack.getUserRoleNames&&(e.userRoles=Knack.getUserRoleNames())}catch(t){e.userInfoError="Failed to capture user data"}return e}_captureSystemInfo(){const e={};if(this.options.captureSystemInfo)try{const t=navigator.userAgent;if(e.userAgent=t,e.browserName=this._getBrowserInfo(t).name,e.browserVersion=this._getBrowserInfo(t).version,e.deviceType=this._getDeviceType(t),e.operatingSystem=this._getOperatingSystem(t),e.screenSize=`${window.innerWidth}x${window.innerHeight}`,e.viewportSize=`${document.documentElement.clientWidth}x${document.documentElement.clientHeight}`,e.knackAppId=Knack?Knack.application_id:"Unknown",navigator.connection&&(e.networkType=navigator.connection.effectiveType,e.downlink=navigator.connection.downlink),window.performance&&window.performance.memory){const t=window.performance.memory;e.jsHeapSizeLimit=t.jsHeapSizeLimit,e.totalJSHeapSize=t.totalJSHeapSize,e.usedJSHeapSize=t.usedJSHeapSize}if(window.performance&&window.performance.timing){const t=window.performance.timing;e.pageLoadTime=t.loadEventEnd-t.navigationStart,e.domReadyTime=t.domComplete-t.domLoading}}catch(t){e.systemInfoError="Failed to capture system data"}return e}_captureContextData(e){const t={};if(this.options.captureKnackContext&&this.options.separateContextFields)try{const e=this.getCurrentContext();t.contextSceneId=e.sceneId||e.currentSceneId||null,t.contextViewId=e.viewId||e.currentViewId||null,t.contextEventType=e.eventType||null,t.contextRecordId=e.recordId||null,t.contextTimestamp=e.timestamp||null,t.contextUrl=e.url||window.location.href,e.recordId&&(t.contextRecordId=e.recordId),t.knackContextFormatted=this._formatKnackContext(e)}catch(e){t.contextError="Failed to capture Knack context"}return t}_formatKnackContext(e){const t=[];if(e.eventType&&t.push(`Event: ${e.eventType}`),(e.sceneId||e.currentSceneId)&&t.push(`Scene: ${e.sceneId||e.currentSceneId}`),(e.viewId||e.currentViewId)&&t.push(`View: ${e.viewId||e.currentViewId}`),e.recordId&&t.push(`Record: ${e.recordId}`),e.timestamp){const n=new Date(e.timestamp).toLocaleString();t.push(`Time: ${n}`)}return t.join(" | ")}_logToKnackTable(e){const t={};if(Object.entries(this.options.fieldMap).forEach(([n,r])=>{"additionalInfo"!==n&&void 0!==e[n]&&(t[r]=e[n])}),this.options.fieldMap.additionalInfo&&e.additionalInfo){const n=this.options.fieldMap.additionalInfo,r={...e.additionalInfo};Object.keys(this.options.fieldMap).forEach(e=>{"additionalInfo"!==e&&delete r[e]});if(["contextSceneId","contextViewId","contextEventType","contextRecordId","contextUrl","contextTimestamp","knackContext","knackContextFormatted"].forEach(e=>{delete r[e]}),Object.keys(r).length>0){const e=JSON.stringify(r,null,2);t[n]=e}}return this.api.createRecord(this.options.sceneId,this.options.viewId,t)}_getBrowserInfo(e){const t=[{name:"Edge",pattern:/Edge|Edg/i},{name:"Chrome",pattern:/Chrome/i},{name:"Firefox",pattern:/Firefox/i},{name:"Safari",pattern:/Safari/i},{name:"Opera",pattern:/Opera|OPR/i},{name:"Internet Explorer",pattern:/Trident|MSIE/i}];let n={name:"Unknown",version:"Unknown"};for(const r of t)if(r.pattern.test(e)){let t;switch(n.name=r.name,r.name){case"Edge":t=e.match(/Edge?\/(\d+(\.\d+)?)/i);break;case"Chrome":t=e.match(/Chrome\/(\d+(\.\d+)?)/i);break;case"Firefox":t=e.match(/Firefox\/(\d+(\.\d+)?)/i);break;case"Safari":t=e.match(/Version\/(\d+(\.\d+)?)/i);break;case"Opera":t=e.match(/OPR\/(\d+(\.\d+)?)/i)||e.match(/Opera\/(\d+(\.\d+)?)/i);break;case"Internet Explorer":t=e.match(/(?:MSIE |rv:)(\d+(\.\d+)?)/i)}t&&t[1]&&(n.version=t[1]);break}return n}_getDeviceType(e){return/Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e)?/Tablet|iPad/i.test(e)?"Tablet":"Mobile":"Desktop"}_getOperatingSystem(e){const t=[{name:"Windows",pattern:/Windows NT/i},{name:"Windows Phone",pattern:/Windows Phone/i},{name:"macOS",pattern:/Macintosh/i},{name:"iOS",pattern:/iPhone|iPad|iPod/i},{name:"Android",pattern:/Android/i},{name:"Linux",pattern:/Linux/i}];for(const n of t)if(n.pattern.test(e))return n.name;return"Unknown OS"}}